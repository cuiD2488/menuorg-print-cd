<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>订单渲染测试</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .order-detail-content {
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 20px;
      }
      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
      }
      .info-item label {
        font-weight: bold;
      }
      .dishes-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }
      .dishes-table th,
      .dishes-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      .dishes-table th {
        background: #f5f5f5;
      }
      .error {
        color: red;
        padding: 20px;
        background: #ffe6e6;
        border-radius: 4px;
      }
      .success {
        color: green;
        padding: 20px;
        background: #e6ffe6;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>订单渲染测试</h1>
      <div id="result"></div>
      <div id="orderDetails"></div>
    </div>

    <script>
      // 模拟订单数据 - 使用用户提供的真实数据
      const testOrderData = {
        status_code: 200,
        message: '请求成功',
        data: {
          order_id: '28630121749386054',
          rd_id: 35863,
          user_id: '6305000000012',
          order_status: 10,
          paystyle: 0,
          delivery_style: 0,
          delivery_type: 0,
          doordash_id: '',
          recipient_name: 'test test',
          recipient_address: '',
          recipient_phone: '18823301830',
          recipient_distance: '0.00',
          rd_name: 'Great Wall',
          rd_address: '807 N Easton Rd  Doylestown PA',
          rd_phone: '2154891122',
          dishes_count: 3,
          dishes_id_list: '[35863151312, 35863151310, 35863151308]',
          dishes_array: [
            {
              price: '5.5',
              amount: 1,
              remark: '',
              dishes_id: 35863151312,
              unit_price: '5.50',
              dishes_name: '3. Fried Wonton (8)',
              dishes_describe: '',
              dishes_specs_id: [],
              dishes_series_id: 13540,
              image_url: '',
            },
            {
              price: '3.95',
              amount: 1,
              remark: '',
              dishes_id: 35863151310,
              unit_price: '3.95',
              dishes_name: '2. Chicken Spring Roll (2)',
              dishes_describe: '',
              dishes_specs_id: [],
              dishes_series_id: 13540,
              image_url: '',
            },
            {
              price: '1.85',
              amount: 1,
              remark: '',
              dishes_id: 35863151308,
              unit_price: '1.85',
              dishes_name: '1. Egg Roll',
              dishes_describe: '',
              dishes_specs_id: [],
              dishes_series_id: 13540,
              image_url: '',
            },
          ],
          discount_dishes_info: {},
          sub_total: '11.30',
          user_commission: '0.00',
          discount_total: '0.00',
          exemption: '0.00',
          tax_rate: '0.0600',
          tax_fee: '0.68',
          delivery_fee: '0.00',
          convenience_rate: '0.000000',
          convenience_fee: '0.00',
          retail_delivery_fee: '0.00',
          tip_fee: '0.00',
          total: '11.98',
          cloud_print: 0,
          order_notes: 'test',
          serial_num: 2,
          order_pdf_url:
            'https://www.menuorg.com/order_pdf/order_28630121749386054.pdf',
          user_email: '1029124915@qq.com',
          create_time: '2025-06-08 12:34:15',
          completion_time: '2025-06-09 04:00:00',
          delivery_time: '2025-06-08 13:03:10',
        },
      };

      function getOrderStatusText(status) {
        switch (status) {
          case 10:
            return '待处理';
          case 20:
            return '已确认';
          case 30:
            return '制作中';
          case 40:
            return '配送中';
          case 50:
            return '已完成';
          case 60:
            return '已取消';
          default:
            return '未知状态';
        }
      }

      function getOrderStatusClass(status) {
        switch (status) {
          case 10:
            return 'status-pending';
          case 20:
            return 'status-confirmed';
          case 30:
            return 'status-preparing';
          case 40:
            return 'status-delivering';
          case 50:
            return 'status-completed';
          case 60:
            return 'status-cancelled';
          default:
            return 'status-unknown';
        }
      }

      function getPaymentMethodText(paystyle) {
        switch (paystyle) {
          case 0:
            return '未知';
          case 1:
            return '现金';
          case 2:
            return '信用卡';
          case 3:
            return '借记卡';
          case 4:
            return '在线支付';
          default:
            return '未知';
        }
      }

      function testOrderRendering() {
        const resultEl = document.getElementById('result');
        const detailsEl = document.getElementById('orderDetails');

        try {
          // 检查API响应
          console.log('API Response:', testOrderData);
          console.log('Status Code:', testOrderData.status_code);
          console.log('Message:', testOrderData.message);
          console.log(
            'Decoded Message:',
            decodeURIComponent(JSON.stringify(testOrderData.message))
          );

          // 模拟API处理逻辑
          const isSuccess =
            testOrderData.status_code === 200 ||
            testOrderData.code === 0 ||
            testOrderData.success;
          console.log('Success Check:', isSuccess);

          if (isSuccess && testOrderData.data) {
            resultEl.innerHTML =
              '<div class="success">✅ API响应处理成功</div>';

            const order = testOrderData.data;
            console.log('Order Data:', order);

            // 渲染订单详情
            displayOrderDetails(order, detailsEl);
          } else {
            resultEl.innerHTML = '<div class="error">❌ API响应处理失败</div>';
          }
        } catch (error) {
          console.error('Error:', error);
          resultEl.innerHTML = `<div class="error">❌ 渲染错误: ${error.message}</div>`;
        }
      }

      function displayOrderDetails(order, detailsEl) {
        console.log('开始渲染订单:', order.order_id);

        // 处理时间格式
        const createTime = order.create_time
          ? new Date(order.create_time).toLocaleString('zh-CN')
          : '未知';
        const deliveryTime = order.delivery_time
          ? new Date(order.delivery_time).toLocaleString('zh-CN')
          : '无';

        // 处理商品列表
        const dishes = order.dishes_array || [];
        console.log('菜品数组:', dishes);

        const dishesHtml = dishes
          .map(
            (dish) => `
                <tr>
                    <td class="dish-name">${dish.dishes_name}</td>
                    <td class="dish-qty">${dish.amount}</td>
                    <td class="dish-price">¥${parseFloat(
                      dish.unit_price || 0
                    ).toFixed(2)}</td>
                    <td class="dish-total">¥${parseFloat(
                      dish.price || 0
                    ).toFixed(2)}</td>
                    <td class="dish-remark">${dish.remark || '-'}</td>
                </tr>
            `
          )
          .join('');

        detailsEl.innerHTML = `
                <div class="order-detail-content">
                    <div class="order-basic-info">
                        <h4>基本信息</h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>订单号:</label>
                                <span>${order.order_id}</span>
                            </div>
                            <div class="info-item">
                                <label>餐厅:</label>
                                <span>${order.rd_name || '未知餐厅'}</span>
                            </div>
                            <div class="info-item">
                                <label>下单时间:</label>
                                <span>${createTime}</span>
                            </div>
                            <div class="info-item">
                                <label>送达时间:</label>
                                <span>${deliveryTime}</span>
                            </div>
                            <div class="info-item">
                                <label>订单状态:</label>
                                <span class="status-badge ${getOrderStatusClass(
                                  order.order_status
                                )}">${getOrderStatusText(
          order.order_status
        )}</span>
                            </div>
                            <div class="info-item">
                                <label>配送方式:</label>
                                <span>${
                                  order.delivery_style === 1 ? '外送' : '自取'
                                }</span>
                            </div>
                        </div>
                    </div>

                    <div class="customer-info">
                        <h4>客户信息</h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>客户姓名:</label>
                                <span>${order.recipient_name || '未提供'}</span>
                            </div>
                            <div class="info-item">
                                <label>联系电话:</label>
                                <span>${
                                  order.recipient_phone || '未提供'
                                }</span>
                            </div>
                            <div class="info-item">
                                <label>送餐地址:</label>
                                <span>${
                                  order.recipient_address || '未提供'
                                }</span>
                            </div>
                        </div>
                    </div>

                    <div class="dishes-info">
                        <h4>商品明细</h4>
                        <table class="dishes-table">
                            <thead>
                                <tr>
                                    <th>商品名称</th>
                                    <th>数量</th>
                                    <th>单价</th>
                                    <th>小计</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${dishesHtml}
                            </tbody>
                        </table>
                    </div>

                    <div class="payment-info">
                        <h4>费用明细</h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>商品小计:</label>
                                <span>¥${parseFloat(
                                  order.sub_total || 0
                                ).toFixed(2)}</span>
                            </div>
                            <div class="info-item">
                                <label>配送费:</label>
                                <span>¥${parseFloat(
                                  order.delivery_fee || 0
                                ).toFixed(2)}</span>
                            </div>
                            <div class="info-item">
                                <label>税费:</label>
                                <span>¥${parseFloat(order.tax_fee || 0).toFixed(
                                  2
                                )}</span>
                            </div>
                            <div class="info-item">
                                <label>小费:</label>
                                <span>¥${parseFloat(order.tip_fee || 0).toFixed(
                                  2
                                )}</span>
                            </div>
                            <div class="info-item">
                                <label>订单总计:</label>
                                <span><strong>¥${parseFloat(
                                  order.total || 0
                                ).toFixed(2)}</strong></span>
                            </div>
                            <div class="info-item">
                                <label>支付方式:</label>
                                <span>${getPaymentMethodText(
                                  order.paystyle
                                )}</span>
                            </div>
                        </div>
                    </div>

                    ${
                      order.order_notes
                        ? `
                        <div class="order-notes">
                            <h4>订单备注</h4>
                            <p>${order.order_notes}</p>
                        </div>
                    `
                        : ''
                    }
                </div>
            `;

        console.log('订单渲染完成');
      }

      // 页面加载后执行测试
      window.onload = function () {
        testOrderRendering();
      };
    </script>
  </body>
</html>
