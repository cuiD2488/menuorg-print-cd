<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>C-Lodop ç²¾ç¡®æ’ç‰ˆæµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .output {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        white-space: pre-wrap;
        font-size: 12px;
        line-height: 1.4;
        border: 1px solid #e9ecef;
        max-width: 500px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .ruler {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        color: #666;
        border-bottom: 1px solid #ccc;
        padding: 5px 0;
        margin-bottom: 10px;
      }
      .margin-guide {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        color: #999;
        background: #fff3cd;
        padding: 5px;
        border-radius: 3px;
        margin-bottom: 10px;
      }
      .feature-list {
        background: #e7f3ff;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .feature-list h3 {
        margin-top: 0;
        color: #0056b3;
      }
      .feature-list ul {
        margin: 10px 0;
        padding-left: 20px;
      }
      .feature-list li {
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ–¨ï¸ C-Lodop ç²¾ç¡®æ’ç‰ˆæµ‹è¯•</h1>

      <div class="feature-list">
        <h3>ğŸ“‹ è‡ªé€‚åº”æ’ç‰ˆç‰¹æ€§</h3>
        <ul>
          <li>
            âœ… <strong>è‡ªé€‚åº”å®½åº¦è®¡ç®—</strong> -
            æ ¹æ®æ‰“å°æœºå®é™…å®½åº¦åŠ¨æ€è°ƒæ•´å­—ç¬¦æ•°
          </li>
          <li>
            âœ… <strong>æ™ºèƒ½å†…å®¹åˆ†å¸ƒ</strong> - å†…å®¹è‡ªåŠ¨é€‚åº”ä¸åŒå®½åº¦çš„æ‰“å°æœº
          </li>
          <li>âœ… <strong>æ”¹è¿›çš„èœå•æ ¼å¼</strong> - èœå+æ•°é‡+ä»·æ ¼ä¸‰åˆ—æ˜¾ç¤º</li>
          <li>âœ… <strong>åŠ¨æ€åˆ—å®½åˆ†é…</strong> - èœå60%ï¼Œæ•°é‡15%ï¼Œä»·æ ¼25%</li>
          <li>âœ… <strong>è§„æ ¼æ™ºèƒ½æ¢è¡Œ</strong> - è§„æ ¼å†…å®¹è‡ªåŠ¨æ¢è¡Œï¼Œ10%ç¼©è¿›</li>
          <li>âœ… <strong>è®¢å•å·å±…ä¸­æ˜¾ç¤º</strong> - æ ‡é¢˜å±…ä¸­å¯¹é½</li>
          <li>
            âœ… <strong>åŸºæœ¬ä¿¡æ¯è‡ªé€‚åº”å¯¹é½</strong> -
            æ ‡ç­¾å·¦å¯¹é½ï¼Œå€¼å³å¯¹é½ï¼Œè¿‡é•¿è‡ªåŠ¨æ¢è¡Œ
          </li>
        </ul>
      </div>

      <div class="ruler">
        è‡ªé€‚åº”å®½åº¦ç¤ºä¾‹ (80mmâ‰ˆ32å­—ç¬¦): 12345678901234567890123456789012
      </div>
      <div class="margin-guide">
        èœå•æ ¼å¼: |--èœå(60%)--|æ•°é‡(15%)|--ä»·æ ¼(25%)--|
      </div>

      <button onclick="testFormatting()">ç”Ÿæˆç²¾ç¡®æ’ç‰ˆæµ‹è¯•</button>
      <button onclick="testPrint()">æµ‹è¯•æ‰“å°</button>
      <button onclick="testPreview()">é¢„è§ˆæ•ˆæœ</button>

      <div id="output" class="output"></div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="renderer/LodopFuncs.js"></script>
    <script src="src/printer-lodop.js"></script>

    <script>
      let lodopManager = null;

      // å¢å¼ºçš„æµ‹è¯•è®¢å•æ•°æ®
      const testOrder = {
        order_id: 'TEST-12345',
        create_time: '2024-01-15T10:30:00.000Z',
        delivery_time: '2024-01-15T11:00:00.000Z',
        paystyle: 1,
        delivery_type: 1,
        recipient_name: 'John Doe',
        recipient_phone: '555-1234-5678',
        recipient_address: '123 Main Street, Apartment 4B',
        dishes_array: [
          {
            dishes_name: 'Kung Pao Chicken å®«ä¿é¸¡ä¸',
            amount: 2,
            price: '15.99',
            remark: 'Extra spicy, no peanuts',
          },
          {
            dishes_name: 'Beef Lo Mein ç‰›è‚‰æé¢',
            amount: 1,
            price: '12.99',
            remark: 'Medium spicy',
          },
          {
            dishes_name: 'Sweet and Sour Pork ç³–é†‹é‡Œè„Š',
            amount: 3,
            price: '14.99',
            remark: '', // æµ‹è¯•ç©ºè§„æ ¼
          },
          {
            dishes_name: 'Mapo Tofu éº»å©†è±†è…',
            amount: 1,
            price: '11.99',
            remark: 'Mild spicy, extra tofu',
          },
        ],
        sub_total: '84.94',
        discount_total: '5.00',
        tax_rate: '8.5',
        tax_fee: '6.79',
        delivery_fee: '3.99',
        convenience_fee: '4.25',
        convenience_rate: '5.0',
        tip_fee: '12.00',
        total: '106.97',
        order_notes: 'Please ring doorbell twice and wait for response',
      };

      async function initLodop() {
        try {
          if (typeof window.LodopPrinterManager !== 'undefined') {
            lodopManager = new window.LodopPrinterManager();
            const result = await lodopManager.init();

            if (result.success) {
              console.log('C-Lodop åˆå§‹åŒ–æˆåŠŸ');
              return true;
            } else {
              console.error('C-Lodop åˆå§‹åŒ–å¤±è´¥:', result.error);
              return false;
            }
          } else {
            console.error('LodopPrinterManager ç±»æœªæ‰¾åˆ°');
            return false;
          }
        } catch (error) {
          console.error('åˆå§‹åŒ–å¤±è´¥:', error);
          return false;
        }
      }

      async function testFormatting() {
        if (!lodopManager) {
          const success = await initLodop();
          if (!success) {
            document.getElementById('output').textContent =
              'âŒ C-Lodop åˆå§‹åŒ–å¤±è´¥';
            return;
          }
        }

        try {
          console.log('å¼€å§‹ç”Ÿæˆç²¾ç¡®æ’ç‰ˆæµ‹è¯•...');

          // è®¾ç½®ä¸º80mmå®½åº¦ï¼ˆ32å­—ç¬¦ï¼‰
          lodopManager.printers = [
            {
              name: 'Test Printer 80mm',
              width: 80,
              engine: 'C-Lodop',
            },
          ];
          lodopManager.selectedPrinters = ['Test Printer 80mm'];

          const content = lodopManager.generateOrderPrintContent(testOrder);

          // æ·»åŠ è¯¦ç»†çš„æ ‡å°ºå’Œè¾¹è·æŒ‡å—
          const ruler =
            'è‡ªé€‚åº”å®½åº¦ç¤ºä¾‹ (80mmâ‰ˆ32å­—ç¬¦): 12345678901234567890123456789012\n';
          const marginGuide =
            'èœå•æ ¼å¼: |--èœå(60%)--|æ•°é‡(15%)|--ä»·æ ¼(25%)--|\n';
          const separator = '='.repeat(32) + '\n';

          const displayContent = ruler + marginGuide + separator + content;

          document.getElementById('output').textContent = displayContent;

          console.log('ç²¾ç¡®æ’ç‰ˆæµ‹è¯•å®Œæˆ');
          console.log('æ’ç‰ˆç‰¹æ€§éªŒè¯:');
          console.log('- è‡ªé€‚åº”å®½åº¦è®¡ç®— âœ“');
          console.log('- æ™ºèƒ½å†…å®¹åˆ†å¸ƒ âœ“');
          console.log('- æ”¹è¿›çš„èœå•æ ¼å¼ âœ“');
          console.log('- åŠ¨æ€åˆ—å®½åˆ†é… âœ“');
          console.log('- è§„æ ¼æ™ºèƒ½æ¢è¡Œ âœ“');
          console.log('- è®¢å•å·å±…ä¸­æ˜¾ç¤º âœ“');
          console.log('- åŸºæœ¬ä¿¡æ¯è‡ªé€‚åº”å¯¹é½ âœ“');
        } catch (error) {
          console.error('æ’ç‰ˆæµ‹è¯•å¤±è´¥:', error);
          document.getElementById(
            'output'
          ).textContent = `âŒ æ’ç‰ˆæµ‹è¯•å¤±è´¥: ${error.message}`;
        }
      }

      async function testPrint() {
        if (!lodopManager) {
          const success = await initLodop();
          if (!success) {
            alert('C-Lodop åˆå§‹åŒ–å¤±è´¥');
            return;
          }
        }

        try {
          console.log('å¼€å§‹æµ‹è¯•æ‰“å°...');

          // åˆ·æ–°æ‰“å°æœºåˆ—è¡¨
          await lodopManager.refreshPrinters();

          if (lodopManager.printers.length === 0) {
            alert('æœªæ‰¾åˆ°å¯ç”¨æ‰“å°æœº');
            return;
          }

          // ä½¿ç”¨ç¬¬ä¸€å°æ‰“å°æœº
          lodopManager.setSelectedPrinters([lodopManager.printers[0].name]);

          const result = await lodopManager.printOrder(testOrder);

          if (result.æˆåŠŸæ•°é‡ > 0) {
            alert(
              'ç²¾ç¡®æ’ç‰ˆæ‰“å°æˆåŠŸï¼\n\néªŒè¯è¦ç‚¹:\n- è‡ªé€‚åº”å®½åº¦è®¡ç®—\n- æ™ºèƒ½å†…å®¹åˆ†å¸ƒ\n- æ”¹è¿›çš„èœå•æ ¼å¼\n- åŠ¨æ€åˆ—å®½åˆ†é…\n- è§„æ ¼æ™ºèƒ½æ¢è¡Œ\n- è®¢å•å·å±…ä¸­æ˜¾ç¤º\n- åŸºæœ¬ä¿¡æ¯è‡ªé€‚åº”å¯¹é½'
            );
          } else {
            alert('æµ‹è¯•æ‰“å°å¤±è´¥: ' + result.é”™è¯¯åˆ—è¡¨.join(', '));
          }
        } catch (error) {
          console.error('æµ‹è¯•æ‰“å°å¤±è´¥:', error);
          alert('æµ‹è¯•æ‰“å°å¤±è´¥: ' + error.message);
        }
      }

      async function testPreview() {
        if (!lodopManager) {
          const success = await initLodop();
          if (!success) {
            alert('C-Lodop åˆå§‹åŒ–å¤±è´¥');
            return;
          }
        }

        try {
          console.log('å¼€å§‹é¢„è§ˆæµ‹è¯•...');

          // åˆ·æ–°æ‰“å°æœºåˆ—è¡¨
          await lodopManager.refreshPrinters();

          if (lodopManager.printers.length === 0) {
            // åˆ›å»ºè™šæ‹Ÿæ‰“å°æœºç”¨äºé¢„è§ˆ
            lodopManager.printers = [
              {
                name: 'Virtual Printer 80mm',
                width: 80,
                engine: 'C-Lodop',
              },
            ];
          }

          // ä½¿ç”¨ç¬¬ä¸€å°æ‰“å°æœº
          lodopManager.setSelectedPrinters([lodopManager.printers[0].name]);

          const result = await lodopManager.generatePrintPreview(testOrder);

          if (result.success) {
            console.log('é¢„è§ˆç”ŸæˆæˆåŠŸï¼Œè¯·æŸ¥çœ‹é¢„è§ˆçª—å£');
            alert(
              'é¢„è§ˆå·²æ‰“å¼€ï¼\n\nè¯·åœ¨é¢„è§ˆçª—å£ä¸­éªŒè¯:\nâœ“ è‡ªé€‚åº”å®½åº¦è®¡ç®—\nâœ“ æ™ºèƒ½å†…å®¹åˆ†å¸ƒ\nâœ“ æ”¹è¿›çš„èœå•æ ¼å¼\nâœ“ åŠ¨æ€åˆ—å®½åˆ†é…\nâœ“ è§„æ ¼æ™ºèƒ½æ¢è¡Œ\nâœ“ è®¢å•å·å±…ä¸­æ˜¾ç¤º\nâœ“ åŸºæœ¬ä¿¡æ¯è‡ªé€‚åº”å¯¹é½'
            );
          } else {
            alert('é¢„è§ˆç”Ÿæˆå¤±è´¥');
          }
        } catch (error) {
          console.error('é¢„è§ˆæµ‹è¯•å¤±è´¥:', error);
          alert('é¢„è§ˆæµ‹è¯•å¤±è´¥: ' + error.message);
        }
      }

      // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œæµ‹è¯•
      window.addEventListener('load', () => {
        setTimeout(testFormatting, 1000);
      });
    </script>
  </body>
</html>
