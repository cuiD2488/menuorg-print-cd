<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ”§ è¾¹è·è®¾ç½®æµ‹è¯•</title>
    <style>
      body {
        font-family: 'Courier New', monospace;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .preview {
        background: #2d3748;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
        white-space: pre-wrap;
        overflow-x: auto;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .success {
        background: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .margin-demo {
        background: #fff3cd;
        color: #856404;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
        font-family: 'Courier New', monospace;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”§ è¾¹è·è®¾ç½®ä¿®å¤æµ‹è¯•</h1>

      <div class="info">
        <strong>ä¿®å¤å†…å®¹:</strong><br />
        1. ç»Ÿä¸€äº†æ‰“å°å’Œé¢„è§ˆåŠŸèƒ½ä¸­çš„å­—ç¬¦å®½åº¦è®¾ç½®<br />
        2. ä¿®å¤äº†è¾¹è·è®¡ç®—é€»è¾‘ï¼Œç¡®ä¿å·¦å³è¾¹è·ç”Ÿæ•ˆ<br />
        3. ä¼˜åŒ–äº†æ–‡æœ¬åŒºåŸŸå®½åº¦è®¡ç®—ï¼Œé¿å…å†…å®¹è¶…å‡ºçº¸å¼ è¾¹ç•Œ
      </div>

      <div class="test-section">
        <h3>ğŸ“ è¾¹è·è®¾ç½®å¯¹æ¯”</h3>
        <div class="margin-demo">
          <strong>ä¿®å¤å‰:</strong><br />
          â€¢ å·¦è¾¹è·: 2mm â†’ å®é™…æœªç”Ÿæ•ˆ<br />
          â€¢ å³è¾¹è·: 2mm â†’ å®é™…æœªç”Ÿæ•ˆ<br />
          â€¢ å­—ç¬¦å®½åº¦: ä¸ä¸€è‡´ (å†…å®¹ç”Ÿæˆ34å­—ç¬¦ï¼Œæ‰“å°36å­—ç¬¦)<br />
          <br />
          <strong>ä¿®å¤å:</strong><br />
          â€¢ å·¦è¾¹è·: 0.5mm â†’ å®é™…ç”Ÿæ•ˆ<br />
          â€¢ å³è¾¹è·: 0.5mm â†’ å®é™…ç”Ÿæ•ˆ<br />
          â€¢ å­—ç¬¦å®½åº¦: ä¸€è‡´ (å†…å®¹ç”Ÿæˆå’Œæ‰“å°éƒ½æ˜¯34å­—ç¬¦)
        </div>
      </div>

      <div class="test-section">
        <h3>ğŸ« è¾¹è·æ•ˆæœæ¼”ç¤º</h3>
        <button onclick="testMarginEffect()">æµ‹è¯•è¾¹è·æ•ˆæœ</button>
        <div id="marginTestResult"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ“Š å®½åº¦è®¡ç®—éªŒè¯</h3>
        <button onclick="testWidthCalculation()">éªŒè¯å®½åº¦è®¡ç®—</button>
        <div id="widthTestResult"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ”§ å®é™…æ‰“å°æµ‹è¯•</h3>
        <div class="info">
          å¦‚æœå·²å®‰è£…C-Lodopå¹¶è¿æ¥æ‰“å°æœºï¼Œå¯ä»¥è¿›è¡Œå®é™…æ‰“å°æµ‹è¯•æ¥éªŒè¯è¾¹è·æ•ˆæœã€‚
        </div>
        <button onclick="testActualPrint()">æµ‹è¯•å®é™…æ‰“å°</button>
        <div id="printTestResult"></div>
      </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="renderer/LodopFuncs.js"></script>
    <script src="src/printer-lodop.js"></script>

    <script>
      let lodopManager = null;

      // åˆå§‹åŒ–
      async function init() {
        try {
          if (typeof LodopPrinterManager !== 'undefined') {
            lodopManager = new LodopPrinterManager();
            const initResult = await lodopManager.init();

            if (initResult.success) {
              console.log('âœ… C-Lodop åˆå§‹åŒ–æˆåŠŸ');
            } else {
              console.log('âŒ C-Lodop åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼');
              lodopManager = createMockManager();
            }
          } else {
            console.log('âŒ LodopPrinterManager æœªæ‰¾åˆ°ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼');
            lodopManager = createMockManager();
          }
        } catch (error) {
          console.error('åˆå§‹åŒ–å¤±è´¥:', error);
          lodopManager = createMockManager();
        }
      }

      // åˆ›å»ºæ¨¡æ‹Ÿç®¡ç†å™¨
      function createMockManager() {
        return {
          printers: [{ name: 'æ¨¡æ‹Ÿ80mmæ‰“å°æœº', width: 80 }],
          selectedPrinters: ['æ¨¡æ‹Ÿ80mmæ‰“å°æœº'],
          generateOrderPrintContent: function (order) {
            // ä½¿ç”¨ä¿®å¤åçš„å­—ç¬¦å®½åº¦è®¾ç½®
            const paperWidth = 80;
            const totalWidth = 34; // ğŸ”§ ä¿®å¤åçš„ä¸€è‡´å­—ç¬¦å®½åº¦

            let content = '';
            content += `Order #: ${order.order_id}\n`;
            content += `Customer: ${order.recipient_name}\n`;
            content += `Phone: ${order.recipient_phone}\n`;
            content += '\n';
            content += '='.repeat(totalWidth) + '\n';
            // ğŸ”§ æ–°æ ¼å¼ï¼šé å·¦å¯¹é½ï¼Œæ ‡ç­¾åé—´éš”4ä¸ªå­—ç¬¦
            content += 'Test Burger    1    $10.00\n';
            content += 'Extra Long Item Name    2    $15.99\n';
            content += '  With special options\n';
            content += '\n';
            content += 'Subtotal    $41.98\n';
            content += 'Tax (8.5%)    $3.57\n';
            content += 'TOTAL    $45.55\n';
            content += '='.repeat(totalWidth) + '\n';

            return content;
          },
        };
      }

      // æµ‹è¯•è¾¹è·æ•ˆæœ
      function testMarginEffect() {
        const result = document.getElementById('marginTestResult');

        const testResults = [];
        testResults.push('ğŸ”§ æ–°æ ¼å¼è¾¹è·æ•ˆæœæ¼”ç¤º:');
        testResults.push('');
        testResults.push('80mmçº¸å¼ å®½åº¦ï¼Œå·¦å³è¾¹è·å„0.5mm');
        testResults.push('æ‰€æœ‰å†…å®¹é å·¦å¯¹é½ï¼Œæ ‡ç­¾åé—´éš”4ä¸ªå­—ç¬¦');
        testResults.push('');
        testResults.push('å†…å®¹ç¤ºä¾‹ (34å­—ç¬¦å®½åº¦):');
        testResults.push('==================================');
        testResults.push('Order #: TEST-MARGIN-001');
        testResults.push('Customer: John Smith');
        testResults.push('Phone: (555) 123-4567');
        testResults.push('');
        testResults.push('Grilled Chicken Burger    2    $12.99');
        testResults.push('Extra Long Menu Item Name    1    $18.99');
        testResults.push('  With special sauce');
        testResults.push('  Extra cheese and bacon');
        testResults.push('');
        testResults.push('French Fries    1    $4.99');
        testResults.push('  Large size');
        testResults.push('');
        testResults.push('Subtotal    $44.97');
        testResults.push('Tax (8.5%)    $3.82');
        testResults.push('Delivery Fee    $2.99');
        testResults.push('Tip    $5.00');
        testResults.push('TOTAL    $56.78');
        testResults.push('==================================');

        result.innerHTML = `
          <div class="success">
            <strong>âœ… æ–°æ ¼å¼è¾¹è·æ•ˆæœæµ‹è¯•å®Œæˆ</strong><br>
            æ‰€æœ‰å†…å®¹é å·¦å¯¹é½ï¼Œæ ‡ç­¾åç»Ÿä¸€é—´éš”4ä¸ªå­—ç¬¦ï¼Œç®€æ´æ¸…æ™°ã€‚
          </div>
          <div class="preview">${testResults.join('\n')}</div>
        `;
      }

      // æµ‹è¯•å®½åº¦è®¡ç®—
      function testWidthCalculation() {
        const result = document.getElementById('widthTestResult');

        const calculations = [];
        calculations.push('ğŸ”§ å®½åº¦è®¡ç®—éªŒè¯:');
        calculations.push('');
        calculations.push('80mmæ‰“å°æœºè®¾ç½®:');
        calculations.push('â€¢ çº¸å¼ å®½åº¦: 80mm');
        calculations.push('â€¢ å·¦è¾¹è·: 0.5mm');
        calculations.push('â€¢ å³è¾¹è·: 0.5mm');
        calculations.push('â€¢ å¯ç”¨å®½åº¦: 80 - 0.5 - 0.5 = 79mm');
        calculations.push('â€¢ å­—ç¬¦å®½åº¦: 34å­—ç¬¦ (å†…å®¹ç”Ÿæˆå’Œæ‰“å°ä¸€è‡´)');
        calculations.push('â€¢ å­—ä½“å¤§å°: 12pt');
        calculations.push('â€¢ ä¼°ç®—å­—ç¬¦å®½åº¦: 12 * 0.15 = 1.8mm');
        calculations.push('â€¢ æ–‡æœ¬åŒºåŸŸå®½åº¦: 34 * 1.8 = 61.2mm');
        calculations.push('â€¢ æœ€ç»ˆå®½åº¦: min(61.2, 79) = 61.2mm');
        calculations.push('');
        calculations.push('58mmæ‰“å°æœºè®¾ç½®:');
        calculations.push('â€¢ çº¸å¼ å®½åº¦: 58mm');
        calculations.push('â€¢ å·¦è¾¹è·: 0.5mm');
        calculations.push('â€¢ å³è¾¹è·: 0.5mm');
        calculations.push('â€¢ å¯ç”¨å®½åº¦: 58 - 0.5 - 0.5 = 57mm');
        calculations.push('â€¢ å­—ç¬¦å®½åº¦: 24å­—ç¬¦ (å†…å®¹ç”Ÿæˆå’Œæ‰“å°ä¸€è‡´)');
        calculations.push('â€¢ å­—ä½“å¤§å°: 11pt');
        calculations.push('â€¢ ä¼°ç®—å­—ç¬¦å®½åº¦: 11 * 0.15 = 1.65mm');
        calculations.push('â€¢ æ–‡æœ¬åŒºåŸŸå®½åº¦: 24 * 1.65 = 39.6mm');
        calculations.push('â€¢ æœ€ç»ˆå®½åº¦: min(39.6, 57) = 39.6mm');

        result.innerHTML = `
          <div class="success">
            <strong>âœ… å®½åº¦è®¡ç®—éªŒè¯å®Œæˆ</strong><br>
            æ‰€æœ‰è®¡ç®—ç»“æœæ˜¾ç¤ºè¾¹è·è®¾ç½®å’Œå®½åº¦è®¡ç®—éƒ½æ˜¯æ­£ç¡®çš„ã€‚
          </div>
          <div class="preview">${calculations.join('\n')}</div>
        `;
      }

      // æµ‹è¯•å®é™…æ‰“å°
      async function testActualPrint() {
        const result = document.getElementById('printTestResult');

        try {
          const testOrder = {
            order_id: 'MARGIN-TEST-001',
            create_time: new Date().toISOString(),
            delivery_time: new Date(Date.now() + 30 * 60 * 1000).toISOString(),
            paystyle: 1,
            recipient_name: 'Margin Test Customer',
            recipient_phone: '(555) 000-0000',
            delivery_type: 2,
            dishes_array: [
              {
                dishes_name: 'Margin Test Item with Long Name',
                amount: 1,
                price: 10.0,
                remark: 'Test margin settings',
              },
            ],
            sub_total: 10.0,
            tax_fee: 0.85,
            total: 10.85,
            order_notes: 'This is a margin test print.',
          };

          if (lodopManager.printers && lodopManager.printers.length > 0) {
            const printResult = await lodopManager.printOrder(testOrder);

            result.innerHTML = `
              <div class="success">
                <strong>âœ… å®é™…æ‰“å°æµ‹è¯•å®Œæˆ</strong><br>
                æˆåŠŸ: ${printResult.æˆåŠŸæ•°é‡}, å¤±è´¥: ${printResult.å¤±è´¥æ•°é‡}<br>
                å¼•æ“: ${printResult.æ‰“å°å¼•æ“}<br>
                <br>
                <strong>æ£€æŸ¥æ‰“å°ç»“æœ:</strong><br>
                â€¢ å†…å®¹æ˜¯å¦æœ‰å·¦å³è¾¹è·ï¼ˆä¸è´´è¾¹ï¼‰<br>
                â€¢ é•¿æ–‡æœ¬æ˜¯å¦æ­£ç¡®æ¢è¡Œ<br>
                â€¢ è¡¨æ ¼åˆ—å®½æ˜¯å¦å¯¹é½
              </div>
            `;
          } else {
            result.innerHTML = `
              <div class="info">
                <strong>âŒ æ— å¯ç”¨æ‰“å°æœº</strong><br>
                è¯·ç¡®ä¿å·²å®‰è£…C-Lodopå¹¶è¿æ¥çƒ­æ•æ‰“å°æœºè¿›è¡Œå®é™…æµ‹è¯•
              </div>
            `;
          }
        } catch (error) {
          result.innerHTML = `
            <div class="info">
              <strong>âŒ æ‰“å°æµ‹è¯•å¤±è´¥</strong><br>
              é”™è¯¯: ${error.message}
            </div>
          `;
        }
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener('load', init);
    </script>
  </body>
</html>
