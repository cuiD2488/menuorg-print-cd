<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¸ƒå±€è®¡ç®—ä¿®å¤æµ‹è¯•</title>
    <style>
      body {
        font-family: 'Courier New', monospace;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .preview {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        font-family: monospace;
        white-space: pre-wrap;
        font-size: 12px;
        margin: 10px 0;
        border-radius: 4px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”§ å¸ƒå±€è®¡ç®—ä¿®å¤æµ‹è¯•</h1>

      <div class="info">
        <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>
        <ul>
          <li>éªŒè¯ä¿®å¤åçš„è¾¹è·è®¡ç®—ï¼ˆå›ºå®šæ¯«ç±³æ•°è€Œéç™¾åˆ†æ¯”ï¼‰</li>
          <li>éªŒè¯ä¿®å¤åçš„å­—ç¬¦å®½åº¦è®¡ç®—ï¼ˆåŸºäºå®é™…å¯ç”¨å®½åº¦ï¼‰</li>
          <li>éªŒè¯ä¿®å¤åçš„æ–‡æœ¬åŒºåŸŸå®½åº¦ï¼ˆç›´æ¥ä½¿ç”¨å¯ç”¨å®½åº¦ï¼‰</li>
        </ul>
      </div>

      <div class="test-section">
        <h3>ğŸ“ å¸ƒå±€è®¡ç®—æµ‹è¯•</h3>
        <button onclick="testLayoutCalculations()">æµ‹è¯•å¸ƒå±€è®¡ç®—</button>
        <div id="layoutTestResult"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ“ è¾¹è·å¯¹æ¯”æµ‹è¯•</h3>
        <button onclick="testMarginComparison()">å¯¹æ¯”è¾¹è·è®¡ç®—</button>
        <div id="marginTestResult"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ“Š å­—ç¬¦å®½åº¦å¯¹æ¯”æµ‹è¯•</h3>
        <button onclick="testCharWidthComparison()">å¯¹æ¯”å­—ç¬¦å®½åº¦è®¡ç®—</button>
        <div id="charWidthTestResult"></div>
      </div>
    </div>

    <script src="src/printer-lodop.js"></script>
    <script>
      // æµ‹è¯•å¸ƒå±€è®¡ç®—
      function testLayoutCalculations() {
        const result = document.getElementById('layoutTestResult');

        try {
          const manager = new LodopPrinterManager();

          // æµ‹è¯•ä¸åŒçº¸å¼ å®½åº¦
          const testWidths = [58, 80, 110];
          let testResults = [];

          testResults.push('ğŸ”§ ä¿®å¤åçš„å¸ƒå±€è®¡ç®—ç»“æœ:');
          testResults.push('');

          testWidths.forEach((width) => {
            const layout = manager.calculateLayoutParams(width);

            testResults.push(`${width}mm çº¸å¼ :`);
            testResults.push(
              `â€¢ è¾¹è·: å·¦${layout.margins.left}mm + å³${
                layout.margins.right
              }mm = ${layout.margins.left + layout.margins.right}mm`
            );
            testResults.push(
              `â€¢ å¯ç”¨å®½åº¦: ${layout.availableWidth}mm (${(
                (layout.availableWidth / width) *
                100
              ).toFixed(1)}%)`
            );
            testResults.push(`â€¢ å­—ç¬¦å®½åº¦: ${layout.totalCharWidth}å­—ç¬¦`);
            testResults.push(`â€¢ æ–‡æœ¬åŒºåŸŸ: ${layout.textAreaWidth}mm`);
            testResults.push(`â€¢ å¸ƒå±€ç±»å‹: ${layout.debug.layoutType}`);
            testResults.push(
              `â€¢ æ–‡æœ¬åŒºåŸŸåˆ©ç”¨ç‡: ${layout.debug.calculations.æ–‡æœ¬åŒºåŸŸåˆ©ç”¨ç‡}`
            );
            testResults.push('');
          });

          result.innerHTML = `
                    <div class="success">
                        <strong>âœ… å¸ƒå±€è®¡ç®—æµ‹è¯•å®Œæˆ</strong><br>
                        ä¿®å¤åçš„è®¡ç®—æ›´åŠ ç²¾ç¡®å’Œåˆç†ã€‚
                    </div>
                    <div class="preview">${testResults.join('\n')}</div>
                `;
        } catch (error) {
          result.innerHTML = `
                    <div class="error">
                        <strong>âŒ æµ‹è¯•å¤±è´¥:</strong> ${error.message}
                    </div>
                `;
        }
      }

      // æµ‹è¯•è¾¹è·å¯¹æ¯”
      function testMarginComparison() {
        const result = document.getElementById('marginTestResult');

        try {
          const testWidths = [58, 80];
          let comparison = [];

          comparison.push('ğŸ“ è¾¹è·è®¡ç®—å¯¹æ¯”:');
          comparison.push('');

          testWidths.forEach((width) => {
            const oldPercentage = (width * 1.0) / 100; // åŸæ¥çš„1%
            const newFixed = width >= 80 ? 2.0 : 1.5; // æ–°çš„å›ºå®šè¾¹è·

            comparison.push(`${width}mm çº¸å¼ :`);
            comparison.push(
              `â€¢ åŸç™¾åˆ†æ¯”æ–¹å¼: ${oldPercentage.toFixed(2)}mm (1%)`
            );
            comparison.push(`â€¢ æ–°å›ºå®šæ–¹å¼: ${newFixed}mm`);
            comparison.push(
              `â€¢ æ”¹è¿›: ${
                newFixed > oldPercentage ? 'å¢åŠ ' : 'å‡å°‘'
              }äº† ${Math.abs(newFixed - oldPercentage).toFixed(2)}mm`
            );
            comparison.push(
              `â€¢ å¯ç”¨å®½åº¦: ${width - newFixed * 2}mm (åŸ: ${
                width - oldPercentage * 2
              }mm)`
            );
            comparison.push('');
          });

          result.innerHTML = `
                    <div class="success">
                        <strong>âœ… è¾¹è·å¯¹æ¯”å®Œæˆ</strong><br>
                        æ–°çš„å›ºå®šè¾¹è·æ›´é€‚åˆçƒ­æ•æ‰“å°æœºçš„å®é™…éœ€æ±‚ã€‚
                    </div>
                    <div class="preview">${comparison.join('\n')}</div>
                `;
        } catch (error) {
          result.innerHTML = `
                    <div class="error">
                        <strong>âŒ æµ‹è¯•å¤±è´¥:</strong> ${error.message}
                    </div>
                `;
        }
      }

      // æµ‹è¯•å­—ç¬¦å®½åº¦å¯¹æ¯”
      function testCharWidthComparison() {
        const result = document.getElementById('charWidthTestResult');

        try {
          const testWidths = [58, 80];
          let comparison = [];

          comparison.push('ğŸ“Š å­—ç¬¦å®½åº¦è®¡ç®—å¯¹æ¯”:');
          comparison.push('');

          testWidths.forEach((width) => {
            // åŸæ¥çš„ç³»æ•°è®¡ç®—
            const oldRatio = width === 80 ? 0.43 : 0.42;
            const oldCharWidth = Math.floor(width * oldRatio);

            // æ–°çš„åŸºäºå¯ç”¨å®½åº¦è®¡ç®—
            const newMargin = width >= 80 ? 2.0 : 1.5;
            const availableWidth = width - newMargin * 2;
            const charWidthMm = width >= 80 ? 2.0 : 1.8;
            const maxChars = Math.floor(availableWidth / charWidthMm);
            const newCharWidth = Math.min(maxChars, width >= 80 ? 36 : 26);

            comparison.push(`${width}mm çº¸å¼ :`);
            comparison.push(
              `â€¢ åŸç³»æ•°æ–¹å¼: ${oldCharWidth}å­—ç¬¦ (${oldRatio} Ã— ${width})`
            );
            comparison.push(
              `â€¢ æ–°è®¡ç®—æ–¹å¼: ${newCharWidth}å­—ç¬¦ (${availableWidth}mm Ã· ${charWidthMm}mm = ${maxChars}, é™åˆ¶${
                width >= 80 ? 36 : 26
              })`
            );
            comparison.push(
              `â€¢ æ”¹è¿›: ${
                newCharWidth !== oldCharWidth
                  ? (newCharWidth > oldCharWidth ? 'å¢åŠ ' : 'å‡å°‘') +
                    Math.abs(newCharWidth - oldCharWidth) +
                    'å­—ç¬¦'
                  : 'æ— å˜åŒ–'
              }`
            );
            comparison.push(
              `â€¢ å®é™…å­—ç¬¦å¯†åº¦: ${(newCharWidth / availableWidth).toFixed(
                2
              )} å­—ç¬¦/mm`
            );
            comparison.push('');
          });

          result.innerHTML = `
                    <div class="success">
                        <strong>âœ… å­—ç¬¦å®½åº¦å¯¹æ¯”å®Œæˆ</strong><br>
                        æ–°çš„è®¡ç®—æ–¹å¼åŸºäºå®é™…å¯ç”¨å®½åº¦ï¼Œæ›´åŠ ç²¾ç¡®ã€‚
                    </div>
                    <div class="preview">${comparison.join('\n')}</div>
                `;
        } catch (error) {
          result.innerHTML = `
                    <div class="error">
                        <strong>âŒ æµ‹è¯•å¤±è´¥:</strong> ${error.message}
                    </div>
                `;
        }
      }
    </script>
  </body>
</html>
