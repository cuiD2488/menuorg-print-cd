<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>布局计算修复测试</title>
    <style>
      body {
        font-family: 'Courier New', monospace;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .preview {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        font-family: monospace;
        white-space: pre-wrap;
        font-size: 12px;
        margin: 10px 0;
        border-radius: 4px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🔧 布局计算修复测试</h1>

      <div class="info">
        <strong>测试目标：</strong>
        <ul>
          <li>验证修复后的边距计算（固定毫米数而非百分比）</li>
          <li>验证修复后的字符宽度计算（基于实际可用宽度）</li>
          <li>验证修复后的文本区域宽度（直接使用可用宽度）</li>
        </ul>
      </div>

      <div class="test-section">
        <h3>📐 布局计算测试</h3>
        <button onclick="testLayoutCalculations()">测试布局计算</button>
        <div id="layoutTestResult"></div>
      </div>

      <div class="test-section">
        <h3>📏 边距对比测试</h3>
        <button onclick="testMarginComparison()">对比边距计算</button>
        <div id="marginTestResult"></div>
      </div>

      <div class="test-section">
        <h3>📊 字符宽度对比测试</h3>
        <button onclick="testCharWidthComparison()">对比字符宽度计算</button>
        <div id="charWidthTestResult"></div>
      </div>
    </div>

    <script src="src/printer-lodop.js"></script>
    <script>
      // 测试布局计算
      function testLayoutCalculations() {
        const result = document.getElementById('layoutTestResult');

        try {
          const manager = new LodopPrinterManager();

          // 测试不同纸张宽度
          const testWidths = [58, 80, 110];
          let testResults = [];

          testResults.push('🔧 修复后的布局计算结果:');
          testResults.push('');

          testWidths.forEach((width) => {
            const layout = manager.calculateLayoutParams(width);

            testResults.push(`${width}mm 纸张:`);
            testResults.push(
              `• 边距: 左${layout.margins.left}mm + 右${
                layout.margins.right
              }mm = ${layout.margins.left + layout.margins.right}mm`
            );
            testResults.push(
              `• 可用宽度: ${layout.availableWidth}mm (${(
                (layout.availableWidth / width) *
                100
              ).toFixed(1)}%)`
            );
            testResults.push(`• 字符宽度: ${layout.totalCharWidth}字符`);
            testResults.push(`• 文本区域: ${layout.textAreaWidth}mm`);
            testResults.push(`• 布局类型: ${layout.debug.layoutType}`);
            testResults.push(
              `• 文本区域利用率: ${layout.debug.calculations.文本区域利用率}`
            );
            testResults.push('');
          });

          result.innerHTML = `
                    <div class="success">
                        <strong>✅ 布局计算测试完成</strong><br>
                        修复后的计算更加精确和合理。
                    </div>
                    <div class="preview">${testResults.join('\n')}</div>
                `;
        } catch (error) {
          result.innerHTML = `
                    <div class="error">
                        <strong>❌ 测试失败:</strong> ${error.message}
                    </div>
                `;
        }
      }

      // 测试边距对比
      function testMarginComparison() {
        const result = document.getElementById('marginTestResult');

        try {
          const testWidths = [58, 80];
          let comparison = [];

          comparison.push('📏 边距计算对比:');
          comparison.push('');

          testWidths.forEach((width) => {
            const oldPercentage = (width * 1.0) / 100; // 原来的1%
            const newFixed = width >= 80 ? 2.0 : 1.5; // 新的固定边距

            comparison.push(`${width}mm 纸张:`);
            comparison.push(
              `• 原百分比方式: ${oldPercentage.toFixed(2)}mm (1%)`
            );
            comparison.push(`• 新固定方式: ${newFixed}mm`);
            comparison.push(
              `• 改进: ${
                newFixed > oldPercentage ? '增加' : '减少'
              }了 ${Math.abs(newFixed - oldPercentage).toFixed(2)}mm`
            );
            comparison.push(
              `• 可用宽度: ${width - newFixed * 2}mm (原: ${
                width - oldPercentage * 2
              }mm)`
            );
            comparison.push('');
          });

          result.innerHTML = `
                    <div class="success">
                        <strong>✅ 边距对比完成</strong><br>
                        新的固定边距更适合热敏打印机的实际需求。
                    </div>
                    <div class="preview">${comparison.join('\n')}</div>
                `;
        } catch (error) {
          result.innerHTML = `
                    <div class="error">
                        <strong>❌ 测试失败:</strong> ${error.message}
                    </div>
                `;
        }
      }

      // 测试字符宽度对比
      function testCharWidthComparison() {
        const result = document.getElementById('charWidthTestResult');

        try {
          const testWidths = [58, 80];
          let comparison = [];

          comparison.push('📊 字符宽度计算对比:');
          comparison.push('');

          testWidths.forEach((width) => {
            // 原来的系数计算
            const oldRatio = width === 80 ? 0.43 : 0.42;
            const oldCharWidth = Math.floor(width * oldRatio);

            // 新的基于可用宽度计算
            const newMargin = width >= 80 ? 2.0 : 1.5;
            const availableWidth = width - newMargin * 2;
            const charWidthMm = width >= 80 ? 2.0 : 1.8;
            const maxChars = Math.floor(availableWidth / charWidthMm);
            const newCharWidth = Math.min(maxChars, width >= 80 ? 36 : 26);

            comparison.push(`${width}mm 纸张:`);
            comparison.push(
              `• 原系数方式: ${oldCharWidth}字符 (${oldRatio} × ${width})`
            );
            comparison.push(
              `• 新计算方式: ${newCharWidth}字符 (${availableWidth}mm ÷ ${charWidthMm}mm = ${maxChars}, 限制${
                width >= 80 ? 36 : 26
              })`
            );
            comparison.push(
              `• 改进: ${
                newCharWidth !== oldCharWidth
                  ? (newCharWidth > oldCharWidth ? '增加' : '减少') +
                    Math.abs(newCharWidth - oldCharWidth) +
                    '字符'
                  : '无变化'
              }`
            );
            comparison.push(
              `• 实际字符密度: ${(newCharWidth / availableWidth).toFixed(
                2
              )} 字符/mm`
            );
            comparison.push('');
          });

          result.innerHTML = `
                    <div class="success">
                        <strong>✅ 字符宽度对比完成</strong><br>
                        新的计算方式基于实际可用宽度，更加精确。
                    </div>
                    <div class="preview">${comparison.join('\n')}</div>
                `;
        } catch (error) {
          result.innerHTML = `
                    <div class="error">
                        <strong>❌ 测试失败:</strong> ${error.message}
                    </div>
                `;
        }
      }
    </script>
  </body>
</html>
