<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ« çƒ­æ•å°ç¥¨æ’ç‰ˆæµ‹è¯•</title>
    <style>
      body {
        font-family: 'Courier New', monospace;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .preview {
        background: #2d3748;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
        white-space: pre-wrap;
        overflow-x: auto;
        margin: 10px 0;
      }
      .comparison {
        display: flex;
        gap: 20px;
      }
      .size-demo {
        flex: 1;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
      }
      .size-80mm {
        background: #e8f5e8;
      }
      .size-58mm {
        background: #e8f0ff;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }
      button:hover {
        background: #0056b3;
      }
      .features {
        background: #fff3cd;
        color: #856404;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .features ul {
        margin: 10px 0;
        padding-left: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ« çƒ­æ•å°ç¥¨æ’ç‰ˆæµ‹è¯•</h1>

      <div class="info">
        <strong>ğŸ”§ çƒ­æ•å°ç¥¨ä¸“ç”¨ä¼˜åŒ–</strong><br />
        ä¸“é—¨é’ˆå¯¹80mmå’Œ58mmçƒ­æ•å°ç¥¨æœºçº¸å¼ ä¼˜åŒ–çš„æ‰“å°æ’ç‰ˆç³»ç»Ÿã€‚<br />
        ç‰¹ç‚¹ï¼šè®¢å•ä¿¡æ¯é å·¦å¯¹é½ï¼Œèœå•è¡¨æ ¼å›ºå®šåˆ—å®½ï¼Œä»·æ ¼å³å¯¹é½ï¼Œå­—ä½“é€‚ä¸­ã€‚
      </div>

      <div class="test-section">
        <h3>ğŸ“Š çº¸å¼ è§„æ ¼å¯¹æ¯”</h3>
        <div class="comparison">
          <div class="size-demo size-80mm">
            <h4>80mmçƒ­æ•çº¸</h4>
            <div class="features">
              <ul>
                <li>å­—ç¬¦å®½åº¦: 32å­—ç¬¦</li>
                <li>å­—ä½“å¤§å°: 12pt</li>
                <li>èœååˆ—: 20å­—ç¬¦</li>
                <li>æ•°é‡åˆ—: 4å­—ç¬¦</li>
                <li>ä»·æ ¼åˆ—: 8å­—ç¬¦</li>
              </ul>
            </div>
          </div>
          <div class="size-demo size-58mm">
            <h4>58mmçƒ­æ•çº¸</h4>
            <div class="features">
              <ul>
                <li>å­—ç¬¦å®½åº¦: 24å­—ç¬¦</li>
                <li>å­—ä½“å¤§å°: 11pt</li>
                <li>èœååˆ—: 12å­—ç¬¦</li>
                <li>æ•°é‡åˆ—: 4å­—ç¬¦</li>
                <li>ä»·æ ¼åˆ—: 8å­—ç¬¦</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="test-section">
        <h3>ğŸ« 80mmçƒ­æ•å°ç¥¨ç¤ºä¾‹</h3>
        <button onclick="generate80mmReceipt()">ç”Ÿæˆ80mmå°ç¥¨</button>
        <div id="receipt80mm"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ« 58mmçƒ­æ•å°ç¥¨ç¤ºä¾‹</h3>
        <button onclick="generate58mmReceipt()">ç”Ÿæˆ58mmå°ç¥¨</button>
        <div id="receipt58mm"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ”§ å®é™…æ‰“å°æµ‹è¯•</h3>
        <div class="info">
          <strong>æ³¨æ„:</strong>
          éœ€è¦å®‰è£…C-Lodopå¹¶è¿æ¥çƒ­æ•æ‰“å°æœºæ‰èƒ½è¿›è¡Œå®é™…æ‰“å°æµ‹è¯•ã€‚
        </div>
        <button onclick="testActualPrint()">æµ‹è¯•å®é™…æ‰“å°</button>
        <div id="printResult"></div>
      </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="renderer/LodopFuncs.js"></script>
    <script src="src/printer-lodop.js"></script>

    <script>
      let lodopManager = null;

      // åˆå§‹åŒ–
      async function init() {
        try {
          if (typeof LodopPrinterManager !== 'undefined') {
            lodopManager = new LodopPrinterManager();
            const initResult = await lodopManager.init();

            if (initResult.success) {
              console.log('âœ… C-Lodop åˆå§‹åŒ–æˆåŠŸ');
            } else {
              console.log('âŒ C-Lodop åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼');
              lodopManager = createMockManager();
            }
          } else {
            console.log('âŒ LodopPrinterManager æœªæ‰¾åˆ°ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼');
            lodopManager = createMockManager();
          }
        } catch (error) {
          console.error('åˆå§‹åŒ–å¤±è´¥:', error);
          lodopManager = createMockManager();
        }
      }

      // åˆ›å»ºæ¨¡æ‹Ÿç®¡ç†å™¨
      function createMockManager() {
        return {
          printers: [
            { name: 'æ¨¡æ‹Ÿ80mmæ‰“å°æœº', width: 80 },
            { name: 'æ¨¡æ‹Ÿ58mmæ‰“å°æœº', width: 58 },
          ],
          selectedPrinters: ['æ¨¡æ‹Ÿ80mmæ‰“å°æœº'],
          generateOrderPrintContent: function (order) {
            // è·å–æ‰“å°æœºå®½åº¦
            const printer = this.printers.find((p) =>
              this.selectedPrinters.includes(p.name)
            );
            const paperWidth = printer ? printer.width : 80;

            // è®¾ç½®å­—ç¬¦å®½åº¦
            let totalWidth;
            if (paperWidth === 80) {
              totalWidth = 32;
            } else if (paperWidth === 58) {
              totalWidth = 24;
            } else {
              totalWidth = Math.floor(paperWidth * 0.4);
            }

            let content = '';

            // è®¢å•å·åŒºåŸŸï¼šé å·¦å¯¹é½
            content += `Order #: ${order.order_id}\n\n`;

            // è®¢å•ä¿¡æ¯ï¼šé å·¦å¯¹é½
            content += `Order Date: ${this.formatDateTime(
              order.create_time
            )}\n`;
            content += `Pickup Time: ${this.formatDateTime(
              order.delivery_time
            )}\n`;
            content += `Payment: ${order.paystyle == 1 ? 'Card' : 'Cash'}\n`;
            content += `Customer: ${order.recipient_name || 'N/A'}\n`;
            content += `Phone: ${order.recipient_phone || 'N/A'}\n`;
            content += `Type: ${
              order.delivery_type == 1 ? 'Delivery' : 'Pickup'
            }\n`;

            // åœ°å€å¤„ç†
            if (order.delivery_type == 1 && order.recipient_address) {
              const address = order.recipient_address;
              if (this.displayWidth(`Address: ${address}`) <= totalWidth) {
                content += `Address: ${address}\n`;
              } else {
                content += `Address:\n`;
                const wrappedAddress = this.wrapText(address, totalWidth - 2);
                const addressLines = wrappedAddress.split('\n');
                addressLines.forEach((line) => {
                  if (line.trim()) {
                    content += `  ${line}\n`;
                  }
                });
              }
            }

            content += '\n' + '='.repeat(totalWidth) + '\n';

            // èœå•è¡¨æ ¼
            const qtyWidth = 4;
            const priceWidth = 8;
            const nameWidth = totalWidth - qtyWidth - priceWidth;

            // è¡¨å¤´
            content += this.padText('Item', nameWidth, 'left');
            content += this.padText('Qty', qtyWidth, 'center');
            content += this.padText('Price', priceWidth, 'right');
            content += '\n';
            content += '-'.repeat(totalWidth) + '\n';

            // èœå•æ˜ç»†
            const dishes = order.dishes_array || [];
            dishes.forEach((dish) => {
              const price = parseFloat(dish.price || '0');
              const qty = parseInt(dish.amount || '1');
              const priceStr = `$${price.toFixed(2)}`;
              const qtyStr = qty.toString();

              const dishName = dish.dishes_name || '';
              if (this.displayWidth(dishName) <= nameWidth) {
                content += this.padText(dishName, nameWidth, 'left');
                content += this.padText(qtyStr, qtyWidth, 'center');
                content += this.padText(priceStr, priceWidth, 'right');
                content += '\n';
              } else {
                const wrappedName = this.wrapText(dishName, nameWidth);
                const nameLines = wrappedName.split('\n');

                const firstLine = nameLines[0] || '';
                content += this.padText(firstLine, nameWidth, 'left');
                content += this.padText(qtyStr, qtyWidth, 'center');
                content += this.padText(priceStr, priceWidth, 'right');
                content += '\n';

                for (let i = 1; i < nameLines.length; i++) {
                  if (nameLines[i].trim()) {
                    content += this.padText(nameLines[i], nameWidth, 'left');
                    content += ' '.repeat(qtyWidth + priceWidth);
                    content += '\n';
                  }
                }
              }

              if (dish.remark && dish.remark.trim()) {
                const specIndent = 2;
                const specWidth = nameWidth - specIndent;
                const wrappedSpec = this.wrapText(dish.remark, specWidth);
                const specLines = wrappedSpec.split('\n');

                specLines.forEach((line) => {
                  if (line.trim()) {
                    content += ' '.repeat(specIndent);
                    content += this.padText(line, specWidth, 'left');
                    content += ' '.repeat(qtyWidth + priceWidth);
                    content += '\n';
                  }
                });
              }

              content += '\n';
            });

            content += '='.repeat(totalWidth) + '\n';

            // è´¹ç”¨æ˜ç»†
            const feeWidth = totalWidth - priceWidth;

            const subtotal = parseFloat(order.sub_total || '0');
            const taxFee = parseFloat(order.tax_fee || '0');
            const deliveryFee = parseFloat(order.delivery_fee || '0');
            const tip = parseFloat(order.tip_fee || '0');
            const total = parseFloat(order.total || '0');

            content += this.padText('Subtotal', feeWidth, 'left');
            content += this.padText(
              `$${subtotal.toFixed(2)}`,
              priceWidth,
              'right'
            );
            content += '\n';

            if (taxFee > 0) {
              content += this.padText('Tax', feeWidth, 'left');
              content += this.padText(
                `$${taxFee.toFixed(2)}`,
                priceWidth,
                'right'
              );
              content += '\n';
            }

            if (deliveryFee > 0) {
              content += this.padText('Delivery', feeWidth, 'left');
              content += this.padText(
                `$${deliveryFee.toFixed(2)}`,
                priceWidth,
                'right'
              );
              content += '\n';
            }

            if (tip > 0) {
              content += this.padText('Tip', feeWidth, 'left');
              content += this.padText(
                `$${tip.toFixed(2)}`,
                priceWidth,
                'right'
              );
              content += '\n';
            }

            content += this.padText('TOTAL', feeWidth, 'left');
            content += this.padText(
              `$${total.toFixed(2)}`,
              priceWidth,
              'right'
            );
            content += '\n';

            if (order.order_notes && order.order_notes.trim()) {
              content += '\n';
              content += '-'.repeat(totalWidth) + '\n';
              content += 'Notes:\n';
              const wrappedNotes = this.wrapText(
                order.order_notes,
                totalWidth - 2
              );
              const noteLines = wrappedNotes.split('\n');
              noteLines.forEach((line) => {
                if (line.trim()) {
                  content += `  ${line}\n`;
                }
              });
            }

            content += '\n';
            content += '='.repeat(totalWidth) + '\n';

            return content;
          },
          formatDateTime: function (dateTimeStr) {
            if (!dateTimeStr) return 'N/A';
            try {
              const date = new Date(dateTimeStr);
              return date.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true,
              });
            } catch (error) {
              return dateTimeStr;
            }
          },
          displayWidth: function (text) {
            let width = 0;
            for (const char of text) {
              width += char.charCodeAt(0) > 127 ? 2 : 1;
            }
            return width;
          },
          padText: function (text, width, align = 'left') {
            const textWidth = this.displayWidth(text);
            if (textWidth >= width) {
              return this.truncateText(text, width);
            }

            const padding = width - textWidth;
            switch (align) {
              case 'right':
                return ' '.repeat(padding) + text;
              case 'center':
                const leftPad = Math.floor(padding / 2);
                const rightPad = padding - leftPad;
                return ' '.repeat(leftPad) + text + ' '.repeat(rightPad);
              default:
                return text + ' '.repeat(padding);
            }
          },
          truncateText: function (text, maxWidth) {
            let result = '';
            let currentWidth = 0;

            for (const char of text) {
              const charWidth = char.charCodeAt(0) > 127 ? 2 : 1;
              if (currentWidth + charWidth > maxWidth) {
                break;
              }
              result += char;
              currentWidth += charWidth;
            }

            return result;
          },
          wrapText: function (text, width) {
            let result = '';
            let currentLine = '';
            let currentWidth = 0;

            for (const char of text) {
              const charWidth = char.charCodeAt(0) > 127 ? 2 : 1;

              if (currentWidth + charWidth > width && currentLine) {
                result += currentLine + '\n';
                currentLine = '';
                currentWidth = 0;
              }

              currentLine += char;
              currentWidth += charWidth;
            }

            if (currentLine) {
              result += currentLine;
            }

            return result;
          },
          setSelectedPrinters: function (printers) {
            this.selectedPrinters = printers;
          },
        };
      }

      // ç”Ÿæˆ80mmå°ç¥¨
      function generate80mmReceipt() {
        const testOrder = {
          order_id: 'TEST-80MM-001',
          create_time: '2024-01-15 14:30:00',
          delivery_time: '2024-01-15 15:00:00',
          paystyle: 1,
          recipient_name: 'John Smith',
          recipient_phone: '(555) 123-4567',
          delivery_type: 1,
          recipient_address:
            '123 Main Street, Apartment 4B, New York, NY 10001',
          dishes_array: [
            {
              dishes_name: 'Classic Cheeseburger',
              amount: 2,
              price: 12.99,
              remark: 'No onions, extra pickles',
            },
            {
              dishes_name:
                'Super Deluxe Bacon Cheeseburger with Extra Everything',
              amount: 1,
              price: 18.99,
              remark: 'Medium rare, extra bacon, no tomatoes, add avocado',
            },
            {
              dishes_name: 'æ‹›ç‰Œç‚¸é¸¡æ±‰å ¡å¥—é¤',
              amount: 1,
              price: 25.5,
              remark: 'å¾®è¾£ï¼Œä¸è¦ç”Ÿèœï¼ŒåŠ èŠå£«',
            },
          ],
          sub_total: 57.48,
          tax_fee: 4.89,
          delivery_fee: 3.99,
          tip_fee: 8.0,
          total: 74.36,
          order_notes: 'Please call when you arrive. Ring the doorbell twice.',
        };

        lodopManager.setSelectedPrinters(['æ¨¡æ‹Ÿ80mmæ‰“å°æœº']);
        const content = lodopManager.generateOrderPrintContent(testOrder);

        document.getElementById('receipt80mm').innerHTML = `
          <div class="info">
            <strong>âœ… 80mmçƒ­æ•å°ç¥¨ç”Ÿæˆå®Œæˆ</strong><br>
            32å­—ç¬¦å®½åº¦ï¼Œ12ptå­—ä½“ï¼Œèœååˆ—20å­—ç¬¦ï¼Œæ•°é‡åˆ—4å­—ç¬¦ï¼Œä»·æ ¼åˆ—8å­—ç¬¦
          </div>
          <div class="preview">${content}</div>
        `;
      }

      // ç”Ÿæˆ58mmå°ç¥¨
      function generate58mmReceipt() {
        const testOrder = {
          order_id: 'TEST-58MM-001',
          create_time: '2024-01-15 14:30:00',
          delivery_time: '2024-01-15 15:00:00',
          paystyle: 1,
          recipient_name: 'John Smith',
          recipient_phone: '(555) 123-4567',
          delivery_type: 1,
          recipient_address:
            '123 Main Street, Apartment 4B, New York, NY 10001',
          dishes_array: [
            {
              dishes_name: 'Classic Cheeseburger',
              amount: 2,
              price: 12.99,
              remark: 'No onions, extra pickles',
            },
            {
              dishes_name:
                'Super Deluxe Bacon Cheeseburger with Extra Everything',
              amount: 1,
              price: 18.99,
              remark: 'Medium rare, extra bacon, no tomatoes, add avocado',
            },
            {
              dishes_name: 'æ‹›ç‰Œç‚¸é¸¡æ±‰å ¡å¥—é¤',
              amount: 1,
              price: 25.5,
              remark: 'å¾®è¾£ï¼Œä¸è¦ç”Ÿèœï¼ŒåŠ èŠå£«',
            },
          ],
          sub_total: 57.48,
          tax_fee: 4.89,
          delivery_fee: 3.99,
          tip_fee: 8.0,
          total: 74.36,
          order_notes: 'Please call when you arrive. Ring the doorbell twice.',
        };

        lodopManager.setSelectedPrinters(['æ¨¡æ‹Ÿ58mmæ‰“å°æœº']);
        const content = lodopManager.generateOrderPrintContent(testOrder);

        document.getElementById('receipt58mm').innerHTML = `
          <div class="info">
            <strong>âœ… 58mmçƒ­æ•å°ç¥¨ç”Ÿæˆå®Œæˆ</strong><br>
            24å­—ç¬¦å®½åº¦ï¼Œ11ptå­—ä½“ï¼Œèœååˆ—12å­—ç¬¦ï¼Œæ•°é‡åˆ—4å­—ç¬¦ï¼Œä»·æ ¼åˆ—8å­—ç¬¦
          </div>
          <div class="preview">${content}</div>
        `;
      }

      // æµ‹è¯•å®é™…æ‰“å°
      async function testActualPrint() {
        const result = document.getElementById('printResult');

        try {
          if (lodopManager.printers && lodopManager.printers.length > 0) {
            const testOrder = {
              order_id: 'PRINT-TEST-001',
              create_time: new Date().toISOString(),
              delivery_time: new Date(
                Date.now() + 30 * 60 * 1000
              ).toISOString(),
              paystyle: 1,
              recipient_name: 'Test Customer',
              recipient_phone: '(555) 000-0000',
              delivery_type: 2,
              dishes_array: [
                {
                  dishes_name: 'Test Item',
                  amount: 1,
                  price: 10.0,
                  remark: 'Test remark',
                },
              ],
              sub_total: 10.0,
              tax_fee: 0.85,
              total: 10.85,
              order_notes: 'This is a test print.',
            };

            const printResult = await lodopManager.printOrder(testOrder);

            result.innerHTML = `
              <div class="info">
                <strong>âœ… æ‰“å°æµ‹è¯•å®Œæˆ</strong><br>
                æˆåŠŸ: ${printResult.æˆåŠŸæ•°é‡}, å¤±è´¥: ${printResult.å¤±è´¥æ•°é‡}<br>
                å¼•æ“: ${printResult.æ‰“å°å¼•æ“}
              </div>
            `;
          } else {
            result.innerHTML = `
              <div class="info">
                <strong>âŒ æ— å¯ç”¨æ‰“å°æœº</strong><br>
                è¯·ç¡®ä¿å·²å®‰è£…C-Lodopå¹¶è¿æ¥çƒ­æ•æ‰“å°æœº
              </div>
            `;
          }
        } catch (error) {
          result.innerHTML = `
            <div class="info">
              <strong>âŒ æ‰“å°æµ‹è¯•å¤±è´¥</strong><br>
              é”™è¯¯: ${error.message}
            </div>
          `;
        }
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener('load', init);
    </script>
  </body>
</html>
