<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¤šé€‰æ‰“å°æœºåŠŸèƒ½æµ‹è¯•</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }

      .container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: #fafafa;
      }

      .section h3 {
        margin-top: 0;
        color: #555;
      }

      .printer-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .printer-checkbox {
        margin-right: 10px;
      }

      .printer-info {
        flex: 1;
      }

      .printer-name {
        font-weight: bold;
        color: #333;
      }

      .printer-details {
        font-size: 12px;
        color: #666;
      }

      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }

      .btn:hover {
        background: #0056b3;
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .btn-success {
        background: #28a745;
      }

      .btn-success:hover {
        background: #1e7e34;
      }

      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      #log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        height: 200px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ–¨ï¸ å¤šé€‰æ‰“å°æœºåŠŸèƒ½æµ‹è¯•</h1>

      <!-- æ‰“å°æœºåˆ—è¡¨ -->
      <div class="section">
        <h3>å¯ç”¨æ‰“å°æœº</h3>
        <div id="printerList">
          <div class="status info">æ­£åœ¨åŠ è½½æ‰“å°æœºåˆ—è¡¨...</div>
        </div>
        <div>
          <button class="btn" onclick="refreshPrinters()">åˆ·æ–°æ‰“å°æœº</button>
          <button class="btn btn-secondary" onclick="selectAllPrinters()">
            å…¨é€‰
          </button>
          <button class="btn btn-secondary" onclick="clearAllPrinters()">
            æ¸…ç©º
          </button>
        </div>
      </div>

      <!-- æ“ä½œåŒºåŸŸ -->
      <div class="section">
        <h3>æ‰“å°æµ‹è¯•</h3>
        <div>
          <button class="btn btn-success" onclick="testPrint()">
            æµ‹è¯•æ‰“å°åˆ°æ‰€æœ‰é€‰ä¸­æ‰“å°æœº
          </button>
          <button class="btn" onclick="printSampleOrder()">æ‰“å°ç¤ºä¾‹è®¢å•</button>
        </div>
        <div id="actionStatus" class="status info" style="display: none"></div>
      </div>

      <!-- çŠ¶æ€æ˜¾ç¤º -->
      <div class="section">
        <h3>çŠ¶æ€ä¿¡æ¯</h3>
        <div id="statusInfo" class="status info">
          é€‰ä¸­æ‰“å°æœº: 0 å°<br />
          æœ€åæ“ä½œ: æ— 
        </div>
      </div>

      <!-- æ—¥å¿— -->
      <div class="section">
        <h3>æ“ä½œæ—¥å¿—</h3>
        <div id="log"></div>
        <button class="btn btn-secondary" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
      </div>
    </div>

    <script>
      let printers = [];
      let selectedPrinters = [];

      // æ—¥å¿—åŠŸèƒ½
      function log(message) {
        const logEl = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        logEl.textContent += `[${timestamp}] ${message}\n`;
        logEl.scrollTop = logEl.scrollHeight;
        console.log(message);
      }

      function clearLog() {
        document.getElementById('log').textContent = '';
      }

      // çŠ¶æ€æ›´æ–°
      function updateStatus() {
        const statusEl = document.getElementById('statusInfo');
        const selectedCount = selectedPrinters.length;
        const totalCount = printers.length;

        let statusText = `é€‰ä¸­æ‰“å°æœº: ${selectedCount}/${totalCount} å°`;
        if (selectedCount > 0) {
          const names =
            selectedPrinters.length > 2
              ? `${selectedPrinters.slice(0, 2).join(', ')} ç­‰`
              : selectedPrinters.join(', ');
          statusText += `<br>é€‰ä¸­çš„æ‰“å°æœº: ${names}`;
        }

        statusEl.innerHTML = statusText;
      }

      // æ˜¾ç¤ºæ“ä½œçŠ¶æ€
      function showActionStatus(message, type = 'info') {
        const statusEl = document.getElementById('actionStatus');
        statusEl.className = `status ${type}`;
        statusEl.textContent = message;
        statusEl.style.display = 'block';

        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 5000);
      }

      // æ¸²æŸ“æ‰“å°æœºåˆ—è¡¨
      function renderPrinters() {
        const container = document.getElementById('printerList');

        if (printers.length === 0) {
          container.innerHTML =
            '<div class="status error">æœªå‘ç°ä»»ä½•æ‰“å°æœº</div>';
          return;
        }

        let html = '';
        printers.forEach((printer) => {
          const isSelected = selectedPrinters.includes(printer.name);
          html += `
            <div class="printer-item">
              <div class="printer-checkbox">
                <input type="checkbox" 
                       value="${printer.name}" 
                       ${isSelected ? 'checked' : ''}
                       onchange="togglePrinter('${
                         printer.name
                       }', this.checked)">
              </div>
              <div class="printer-info">
                <div class="printer-name">${printer.name}</div>
                <div class="printer-details">
                  å®½åº¦: ${printer.width || 80}mm | 
                  ç±»å‹: ${printer.isThermal ? 'çƒ­æ•' : 'æ™®é€š'} | 
                  çŠ¶æ€: ${printer.status || 'Ready'}
                </div>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
        updateStatus();
      }

      // åˆ‡æ¢æ‰“å°æœºé€‰æ‹©
      function togglePrinter(printerName, isChecked) {
        if (isChecked) {
          if (!selectedPrinters.includes(printerName)) {
            selectedPrinters.push(printerName);
            log(`âœ… é€‰æ‹©æ‰“å°æœº: ${printerName}`);
          }
        } else {
          selectedPrinters = selectedPrinters.filter(
            (name) => name !== printerName
          );
          log(`âŒ å–æ¶ˆé€‰æ‹©æ‰“å°æœº: ${printerName}`);
        }
        updateStatus();
      }

      // åˆ·æ–°æ‰“å°æœºåˆ—è¡¨
      async function refreshPrinters() {
        log('ğŸ”„ åˆ·æ–°æ‰“å°æœºåˆ—è¡¨...');
        showActionStatus('æ­£åœ¨åˆ·æ–°æ‰“å°æœºåˆ—è¡¨...', 'info');

        try {
          // æ¨¡æ‹Ÿè·å–æ‰“å°æœºåˆ—è¡¨
          await new Promise((resolve) => setTimeout(resolve, 1000));

          // æ¨¡æ‹Ÿæ‰“å°æœºæ•°æ®
          printers = [
            {
              name: 'HP LaserJet 1020',
              width: 80,
              isThermal: false,
              status: 'Ready',
            },
            {
              name: 'EPSON TM-T20II',
              width: 58,
              isThermal: true,
              status: 'Ready',
            },
            {
              name: 'Canon PIXMA',
              width: 80,
              isThermal: false,
              status: 'Ready',
            },
            {
              name: 'Zebra ZD420',
              width: 58,
              isThermal: true,
              status: 'Ready',
            },
          ];

          renderPrinters();
          log(`âœ… å‘ç° ${printers.length} å°æ‰“å°æœº`);
          showActionStatus(`å‘ç° ${printers.length} å°æ‰“å°æœº`, 'success');
        } catch (error) {
          log(`âŒ åˆ·æ–°æ‰“å°æœºå¤±è´¥: ${error.message}`);
          showActionStatus('åˆ·æ–°æ‰“å°æœºå¤±è´¥', 'error');
        }
      }

      // å…¨é€‰æ‰“å°æœº
      function selectAllPrinters() {
        selectedPrinters = printers.map((p) => p.name);
        renderPrinters();
        log(`âœ… å·²é€‰æ‹©æ‰€æœ‰ ${selectedPrinters.length} å°æ‰“å°æœº`);
        showActionStatus(
          `å·²é€‰æ‹©æ‰€æœ‰ ${selectedPrinters.length} å°æ‰“å°æœº`,
          'success'
        );
      }

      // æ¸…ç©ºé€‰æ‹©
      function clearAllPrinters() {
        const prevCount = selectedPrinters.length;
        selectedPrinters = [];
        renderPrinters();
        log(`ğŸ—‘ï¸ å·²æ¸…ç©º ${prevCount} å°æ‰“å°æœºçš„é€‰æ‹©`);
        showActionStatus('å·²æ¸…ç©ºæ‰€æœ‰æ‰“å°æœºé€‰æ‹©', 'info');
      }

      // æµ‹è¯•æ‰“å°
      async function testPrint() {
        if (selectedPrinters.length === 0) {
          alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€å°æ‰“å°æœº');
          return;
        }

        log(`ğŸ§ª å¼€å§‹æµ‹è¯•æ‰“å°ï¼Œç›®æ ‡: ${selectedPrinters.length} å°æ‰“å°æœº`);
        showActionStatus(
          `æ­£åœ¨å‘ ${selectedPrinters.length} å°æ‰“å°æœºå‘é€æµ‹è¯•æ‰“å°...`,
          'info'
        );

        let successCount = 0;
        let errorCount = 0;

        // æ¨¡æ‹Ÿå¹¶è¡Œæ‰“å°
        const promises = selectedPrinters.map(async (printerName) => {
          try {
            log(`ğŸ“¤ å‘ ${printerName} å‘é€æµ‹è¯•æ‰“å°...`);

            // æ¨¡æ‹Ÿæ‰“å°å»¶è¿Ÿ
            await new Promise((resolve) =>
              setTimeout(resolve, 1000 + Math.random() * 2000)
            );

            // æ¨¡æ‹Ÿä¸€å®šçš„å¤±è´¥ç‡
            if (Math.random() > 0.8) {
              throw new Error('æ‰“å°æœºè¿æ¥è¶…æ—¶');
            }

            log(`âœ… ${printerName} æµ‹è¯•æ‰“å°æˆåŠŸ`);
            successCount++;
            return { printer: printerName, success: true };
          } catch (error) {
            log(`âŒ ${printerName} æµ‹è¯•æ‰“å°å¤±è´¥: ${error.message}`);
            errorCount++;
            return {
              printer: printerName,
              success: false,
              error: error.message,
            };
          }
        });

        const results = await Promise.all(promises);

        // æ˜¾ç¤ºç»“æœ
        if (successCount > 0 && errorCount === 0) {
          log(`ğŸ‰ æ‰€æœ‰ ${successCount} å°æ‰“å°æœºæµ‹è¯•æˆåŠŸï¼`);
          showActionStatus(
            `æ‰€æœ‰ ${successCount} å°æ‰“å°æœºæµ‹è¯•æˆåŠŸï¼`,
            'success'
          );
        } else if (successCount > 0 && errorCount > 0) {
          log(`âš ï¸ æµ‹è¯•å®Œæˆ: ${successCount} å°æˆåŠŸï¼Œ${errorCount} å°å¤±è´¥`);
          showActionStatus(
            `${successCount} å°æˆåŠŸï¼Œ${errorCount} å°å¤±è´¥`,
            'error'
          );
        } else {
          log(`ğŸ’¥ æ‰€æœ‰æ‰“å°æœºæµ‹è¯•å¤±è´¥`);
          showActionStatus('æ‰€æœ‰æ‰“å°æœºæµ‹è¯•å¤±è´¥', 'error');
        }

        console.log('æµ‹è¯•æ‰“å°ç»“æœ:', results);
      }

      // æ‰“å°ç¤ºä¾‹è®¢å•
      async function printSampleOrder() {
        if (selectedPrinters.length === 0) {
          alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€å°æ‰“å°æœº');
          return;
        }

        log(`ğŸ“‹ å¼€å§‹æ‰“å°ç¤ºä¾‹è®¢å•åˆ° ${selectedPrinters.length} å°æ‰“å°æœº`);
        showActionStatus(
          `æ­£åœ¨å‘ ${selectedPrinters.length} å°æ‰“å°æœºæ‰“å°è®¢å•...`,
          'info'
        );

        // æ¨¡æ‹Ÿè®¢å•æ‰“å°
        await new Promise((resolve) => setTimeout(resolve, 2000));

        log(`âœ… ç¤ºä¾‹è®¢å•å·²å‘é€åˆ°æ‰€æœ‰é€‰ä¸­çš„æ‰“å°æœº`);
        showActionStatus('ç¤ºä¾‹è®¢å•æ‰“å°å®Œæˆ', 'success');
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.onload = function () {
        log('ğŸš€ å¤šé€‰æ‰“å°æœºæµ‹è¯•é¡µé¢å·²åŠ è½½');
        refreshPrinters();
      };
    </script>
  </body>
</html>
