<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ”¤ æ™ºèƒ½ç¼–ç æµ‹è¯•æ¼”ç¤º</title>
    <style>
      body {
        font-family: 'Microsoft YaHei', Arial, sans-serif;
        margin: 20px;
        line-height: 1.6;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        background: #f8f9fa;
      }

      .section h2 {
        color: #34495e;
        margin-top: 0;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
      }

      .test-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .test-group {
          grid-template-columns: 1fr;
        }
      }

      .test-input {
        background: white;
        border: 2px solid #bdc3c7;
        border-radius: 8px;
        padding: 15px;
      }

      .test-input label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        color: #2c3e50;
      }

      .test-input input,
      .test-input select,
      .test-input textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        box-sizing: border-box;
      }

      .test-input textarea {
        height: 80px;
        resize: vertical;
        font-family: monospace;
      }

      .button {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s ease;
        margin: 5px;
      }

      .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
      }

      .button.success {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
      }

      .button.warning {
        background: linear-gradient(135deg, #f39c12, #e67e22);
      }

      .button.danger {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }

      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }

      .result.success {
        background: #d4edda;
        border: 2px solid #27ae60;
        color: #155724;
      }

      .result.error {
        background: #f8d7da;
        border: 2px solid #e74c3c;
        color: #721c24;
      }

      .result.info {
        background: #cce7ff;
        border: 2px solid #3498db;
        color: #004085;
      }

      .encoding-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .encoding-card {
        background: white;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
      }

      .encoding-card.excellent {
        border-color: #27ae60;
        background: linear-gradient(135deg, #d4edda, #ffffff);
      }

      .encoding-card.good {
        border-color: #f39c12;
        background: linear-gradient(135deg, #fff3cd, #ffffff);
      }

      .encoding-card.poor {
        border-color: #e74c3c;
        background: linear-gradient(135deg, #f8d7da, #ffffff);
      }

      .score {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0;
      }

      .demo-text {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-family: monospace;
        border-left: 4px solid #3498db;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .stat-item {
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 2px solid #e1e8ed;
      }

      .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #3498db;
      }

      .stat-label {
        font-size: 14px;
        color: #7f8c8d;
        margin-top: 5px;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-indicator.online {
        background: #27ae60;
        box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
      }

      .status-indicator.offline {
        background: #e74c3c;
      }

      .status-indicator.testing {
        background: #f39c12;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”¤ æ™ºèƒ½ç¼–ç æµ‹è¯•æ¼”ç¤º</h1>

      <!-- æ–‡æœ¬åˆ†æåŒºåŸŸ -->
      <div class="section">
        <h2>ğŸ“ 1. æ–‡æœ¬ç¼–ç åˆ†æ</h2>
        <div class="test-group">
          <div class="test-input">
            <label for="analyzeText">è¾“å…¥æµ‹è¯•æ–‡æœ¬ï¼š</label>
            <textarea
              id="analyzeText"
              placeholder="è¾“å…¥åŒ…å«ä¸­æ–‡çš„æ–‡æœ¬ï¼Œä¾‹å¦‚ï¼šä½ å¥½ä¸–ç•Œï¼è®¢å•#12345ï¼Œæ€»è®¡ï¿¥99.50"
            >
å®«ä¿é¸¡ä¸ã€éº»å©†è±†è…ã€ç™½ç±³é¥­ã€å¯ä¹
åœ°å€ï¼šåŒ—äº¬å¸‚æœé˜³åŒºæœ›äº¬è¡—é“123å·2Bå®¤
æ€»è®¡ï¼šï¿¥128.50</textarea
            >
            <button class="button" onclick="analyzeTextEncoding()">
              ğŸ” åˆ†æç¼–ç ç‰¹å¾
            </button>
          </div>
          <div class="test-input">
            <label>åˆ†æç»“æœï¼š</label>
            <div id="analysisResult" class="result info">
              ç‚¹å‡»"åˆ†æç¼–ç ç‰¹å¾"æŒ‰é’®å¼€å§‹åˆ†æ...
            </div>
          </div>
        </div>
      </div>

      <!-- æ‰“å°æœºæ£€æµ‹åŒºåŸŸ -->
      <div class="section">
        <h2>ğŸ–¨ï¸ 2. æ‰“å°æœºä¸­æ–‡æ”¯æŒæ£€æµ‹</h2>
        <div class="test-group">
          <div class="test-input">
            <label for="printerSelect">é€‰æ‹©æ‰“å°æœºï¼š</label>
            <select id="printerSelect">
              <option value="">åŠ è½½ä¸­...</option>
            </select>
            <button class="button" onclick="refreshPrinters()">
              ğŸ”„ åˆ·æ–°æ‰“å°æœºåˆ—è¡¨
            </button>
            <button class="button success" onclick="testPrinterChinese()">
              ğŸ§ª æµ‹è¯•ä¸­æ–‡æ”¯æŒ
            </button>
          </div>
          <div class="test-input">
            <label>æ‰“å°æœºä¿¡æ¯ï¼š</label>
            <div id="printerInfo" class="result info">
              é€‰æ‹©æ‰“å°æœºåæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯...
            </div>
          </div>
        </div>

        <div
          id="encodingTestResults"
          class="encoding-grid"
          style="display: none"
        >
          <!-- ç¼–ç æµ‹è¯•ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
      </div>

      <!-- ç¼–ç å…¼å®¹æ€§æµ‹è¯• -->
      <div class="section">
        <h2>ğŸ¯ 3. ç¼–ç å…¼å®¹æ€§è¯„ä¼°</h2>
        <div class="test-input">
          <button class="button" onclick="getEncodingCapability()">
            ğŸ“Š è·å–ç¼–ç èƒ½åŠ›è¯„ä¼°
          </button>
          <button class="button warning" onclick="runFullCompatibilityTest()">
            ğŸ”¬ è¿è¡Œå®Œæ•´å…¼å®¹æ€§æµ‹è¯•
          </button>
        </div>
        <div id="compatibilityResult" class="result info">
          ç‚¹å‡»æŒ‰é’®å¼€å§‹å…¼å®¹æ€§è¯„ä¼°...
        </div>

        <div class="stats" id="compatibilityStats" style="display: none">
          <div class="stat-item">
            <div class="stat-value" id="totalTests">0</div>
            <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="successfulTests">0</div>
            <div class="stat-label">æˆåŠŸæµ‹è¯•</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="overallScore">0%</div>
            <div class="stat-label">æ€»ä½“å…¼å®¹æ€§</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="recommendedEncoding">-</div>
            <div class="stat-label">æ¨èç¼–ç </div>
          </div>
        </div>
      </div>

      <!-- ç¼–ç è®¾ç½®åŒºåŸŸ -->
      <div class="section">
        <h2>âš™ï¸ 4. ç¼–ç è®¾ç½®</h2>
        <div class="test-group">
          <div class="test-input">
            <label for="encodingPreference">é¦–é€‰ç¼–ç ï¼š</label>
            <select id="encodingPreference">
              <option value="AUTO">è‡ªåŠ¨æ£€æµ‹</option>
              <option value="GBK">GBK (æ¨èä¸­å›½å“ç‰Œ)</option>
              <option value="UTF8">UTF-8 (å›½é™…æ ‡å‡†)</option>
              <option value="GB18030">GB18030 (å®Œæ•´ä¸­æ–‡)</option>
              <option value="BIG5">Big5 (ç¹ä½“ä¸­æ–‡)</option>
              <option value="ASCII">ASCII (çº¯è‹±æ–‡)</option>
            </select>
            <label>å¤‡ç”¨ç¼–ç é¡ºåºï¼š</label>
            <textarea
              id="fallbackEncodings"
              placeholder="è¾“å…¥å¤‡ç”¨ç¼–ç ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼šGBK,UTF8,GB18030"
            >
GBK,UTF8,GB18030,ASCII</textarea
            >
            <button class="button" onclick="setEncodingPreference()">
              ğŸ’¾ ä¿å­˜ç¼–ç è®¾ç½®
            </button>
          </div>
          <div class="test-input">
            <label>å½“å‰è®¾ç½®ï¼š</label>
            <div id="currentSettings" class="result info">
              ç¼–ç è®¾ç½®å°†åœ¨è¿™é‡Œæ˜¾ç¤º...
            </div>
          </div>
        </div>
      </div>

      <!-- å®é™…æ‰“å°æµ‹è¯• -->
      <div class="section">
        <h2>ğŸ–¨ï¸ 5. å®é™…æ‰“å°æµ‹è¯•</h2>
        <div class="demo-text">
          æµ‹è¯•è®¢å•å†…å®¹ï¼š â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” è®¢å•
          #20250115001 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” ğŸ“
          å®¢æˆ·ä¿¡æ¯ å§“å: å¼ å°æ˜ ç”µè¯: 138****5678 åœ°å€:
          åŒ—äº¬å¸‚æœé˜³åŒºæœ›äº¬è¡—é“123å·2Bå®¤ ğŸ½ï¸ èœå“æ˜ç»† å®«ä¿é¸¡ä¸ x1 Â¥28.00 éº»å©†è±†è…
          x1 Â¥18.00 ç™½ç±³é¥­ x2 Â¥4.00 å¯å£å¯ä¹ x1 Â¥5.00 ğŸ’° è´¹ç”¨æ˜ç»† å•†å“å°è®¡:
          Â¥55.00 é…é€è´¹: Â¥3.00 åŒ…è£…è´¹: Â¥2.00
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è®¢å•æ€»è®¡: Â¥60.00 ğŸ“…
          è®¢å•æ—¶é—´: 18:30 ğŸšš é…é€æ–¹å¼: å¤–å–é…é€
        </div>

        <div class="test-input">
          <button
            class="button success"
            onclick="testPrintWithOptimalEncoding()"
          >
            ğŸ¯ ä½¿ç”¨æœ€ä½³ç¼–ç æ‰“å°æµ‹è¯•
          </button>
          <button class="button" onclick="testPrintWithAllEncodings()">
            ğŸ”„ æµ‹è¯•æ‰€æœ‰ç¼–ç æ•ˆæœ
          </button>
          <button class="button warning" onclick="generatePreview()">
            ğŸ‘ï¸ ç”Ÿæˆæ‰“å°é¢„è§ˆ
          </button>
        </div>

        <div id="printTestResult" class="result info">
          é€‰æ‹©æµ‹è¯•æ–¹å¼å¼€å§‹æ‰“å°æµ‹è¯•...
        </div>
      </div>

      <!-- è¯Šæ–­å·¥å…· -->
      <div class="section">
        <h2>ğŸ”§ 6. ç¼–ç è¯Šæ–­å·¥å…·</h2>
        <div class="test-input">
          <button class="button" onclick="runDiagnostics()">
            ğŸ©º è¿è¡Œç³»ç»Ÿè¯Šæ–­
          </button>
          <button class="button danger" onclick="resetEncodingSettings()">
            ğŸ”„ é‡ç½®æ‰€æœ‰è®¾ç½®
          </button>
          <button class="button" onclick="exportDiagnosticReport()">
            ğŸ“‹ å¯¼å‡ºè¯Šæ–­æŠ¥å‘Š
          </button>
        </div>
        <div id="diagnosticResult" class="result info">
          ç‚¹å‡»"è¿è¡Œç³»ç»Ÿè¯Šæ–­"è·å–è¯¦ç»†è¯Šæ–­ä¿¡æ¯...
        </div>
      </div>
    </div>

    <script>
      // å…¨å±€çŠ¶æ€
      let currentPrinters = [];
      let selectedPrinter = null;
      let lastAnalysis = null;
      let lastCapability = null;

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener('DOMContentLoaded', function () {
        console.log('ğŸš€ æ™ºèƒ½ç¼–ç æµ‹è¯•æ¼”ç¤ºç³»ç»Ÿå¯åŠ¨');
        refreshPrinters();
        loadCurrentSettings();
      });

      // åˆ†ææ–‡æœ¬ç¼–ç ç‰¹å¾
      async function analyzeTextEncoding() {
        const text = document.getElementById('analyzeText').value;
        const resultDiv = document.getElementById('analysisResult');

        if (!text.trim()) {
          resultDiv.className = 'result error';
          resultDiv.textContent = 'âŒ è¯·è¾“å…¥è¦åˆ†æçš„æ–‡æœ¬';
          return;
        }

        resultDiv.className = 'result info';
        resultDiv.innerHTML =
          '<div class="loading"></div>æ­£åœ¨åˆ†ææ–‡æœ¬ç¼–ç ç‰¹å¾...';

        try {
          const analysis = await window.__TAURI__.invoke(
            'analyze_text_encoding',
            {
              text: text,
            }
          );

          lastAnalysis = analysis;

          resultDiv.className = 'result success';
          resultDiv.innerHTML = `âœ… ç¼–ç åˆ†æå®Œæˆ

ğŸ“Š æ–‡æœ¬ç‰¹å¾ï¼š
   â€¢ åŒ…å«ä¸­æ–‡: ${analysis.has_chinese ? 'âœ… æ˜¯' : 'âŒ å¦'}
   â€¢ åŒ…å«ç®€ä½“å­—: ${analysis.has_simplified ? 'âœ… æ˜¯' : 'âŒ å¦'}
   â€¢ åŒ…å«ç¹ä½“å­—: ${analysis.has_traditional ? 'âœ… æ˜¯' : 'âŒ å¦'}
   â€¢ åŒ…å«ä¸­æ–‡ç¬¦å·: ${analysis.has_symbols ? 'âœ… æ˜¯' : 'âŒ å¦'}
   â€¢ æ£€æµ‹ç½®ä¿¡åº¦: ${(analysis.confidence * 100).toFixed(1)}%

ğŸ¯ æ¨èç¼–ç : ${analysis.recommended_encoding}

ğŸ“ˆ å­—ç¬¦ç»Ÿè®¡:
${Object.entries(analysis.character_counts)
  .map(([key, value]) => `   â€¢ ${key}: ${value} ä¸ª`)
  .join('\n')}`;

          console.log('ğŸ“ æ–‡æœ¬åˆ†æç»“æœ:', analysis);
        } catch (error) {
          resultDiv.className = 'result error';
          resultDiv.textContent = `âŒ åˆ†æå¤±è´¥: ${error}`;
          console.error('åˆ†ææ–‡æœ¬ç¼–ç å¤±è´¥:', error);
        }
      }

      // åˆ·æ–°æ‰“å°æœºåˆ—è¡¨
      async function refreshPrinters() {
        const select = document.getElementById('printerSelect');
        select.innerHTML = '<option value="">æ­£åœ¨åŠ è½½...</option>';

        try {
          const printers = await window.__TAURI__.invoke('get_printers');
          currentPrinters = printers;

          select.innerHTML = '';
          if (printers.length === 0) {
            select.innerHTML = '<option value="">æœªå‘ç°æ‰“å°æœº</option>';
          } else {
            printers.forEach((printer) => {
              const option = document.createElement('option');
              option.value = printer.name;
              option.textContent = `${printer.name} (${printer.width}mm, ${printer.printer_brand})`;
              select.appendChild(option);
            });
          }

          console.log('ğŸ–¨ï¸ å‘ç°æ‰“å°æœº:', printers.length, 'ä¸ª');
        } catch (error) {
          select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
          console.error('è·å–æ‰“å°æœºåˆ—è¡¨å¤±è´¥:', error);
        }
      }

      // æµ‹è¯•æ‰“å°æœºä¸­æ–‡æ”¯æŒ
      async function testPrinterChinese() {
        const selectedPrinterName =
          document.getElementById('printerSelect').value;
        const infoDiv = document.getElementById('printerInfo');
        const resultsDiv = document.getElementById('encodingTestResults');

        if (!selectedPrinterName) {
          infoDiv.className = 'result error';
          infoDiv.textContent = 'âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ‰“å°æœº';
          return;
        }

        selectedPrinter = currentPrinters.find(
          (p) => p.name === selectedPrinterName
        );

        infoDiv.className = 'result info';
        infoDiv.innerHTML =
          '<div class="loading"></div>æ­£åœ¨æµ‹è¯•æ‰“å°æœºä¸­æ–‡æ”¯æŒèƒ½åŠ›...';
        resultsDiv.style.display = 'none';

        try {
          const capability = await window.__TAURI__.invoke(
            'test_printer_chinese_support',
            {
              printerName: selectedPrinterName,
            }
          );

          lastCapability = capability;

          // æ˜¾ç¤ºæ‰“å°æœºä¿¡æ¯
          infoDiv.className = 'result success';
          infoDiv.innerHTML = `âœ… ä¸­æ–‡æ”¯æŒæµ‹è¯•å®Œæˆ

ğŸ–¨ï¸ æ‰“å°æœºä¿¡æ¯ï¼š
   â€¢ åç§°: ${capability.printer_name}
   â€¢ å“ç‰Œ: ${capability.brand}
   â€¢ ä¸­æ–‡æ”¯æŒ: ${capability.supports_chinese ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}
   â€¢ æ€»ä½“å…¼å®¹æ€§: ${(capability.overall_compatibility * 100).toFixed(1)}%
   â€¢ æ¨èç¼–ç : ${capability.recommended_encoding}

ğŸ“‹ å¤‡ç”¨ç¼–ç : ${capability.fallback_encodings.join(', ')}`;

          // æ˜¾ç¤ºç¼–ç æµ‹è¯•ç»“æœ
          displayEncodingResults(capability.tested_encodings);
          resultsDiv.style.display = 'grid';

          console.log('ğŸ§ª ä¸­æ–‡æ”¯æŒæµ‹è¯•ç»“æœ:', capability);
        } catch (error) {
          infoDiv.className = 'result error';
          infoDiv.textContent = `âŒ æµ‹è¯•å¤±è´¥: ${error}`;
          console.error('æµ‹è¯•æ‰“å°æœºä¸­æ–‡æ”¯æŒå¤±è´¥:', error);
        }
      }

      // æ˜¾ç¤ºç¼–ç æµ‹è¯•ç»“æœ
      function displayEncodingResults(encodingResults) {
        const resultsDiv = document.getElementById('encodingTestResults');
        resultsDiv.innerHTML = '';

        encodingResults.forEach((result) => {
          const card = document.createElement('div');
          const score = result.compatibility_score * 100;

          let cardClass = 'encoding-card';
          let statusIcon = '';

          if (score >= 85) {
            cardClass += ' excellent';
            statusIcon = 'ğŸŸ¢';
          } else if (score >= 70) {
            cardClass += ' good';
            statusIcon = 'ğŸŸ¡';
          } else {
            cardClass += ' poor';
            statusIcon = 'ğŸ”´';
          }

          card.className = cardClass;
          card.innerHTML = `
                    <h3>${statusIcon} ${result.encoding_name}</h3>
                    <div class="score">${score.toFixed(1)}%</div>
                    <div>çŠ¶æ€: ${result.success ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}</div>
                    <div>æµ‹è¯•: ${result.test_content}</div>
                    ${
                      result.error_message
                        ? `<div style="color: #e74c3c; font-size: 12px; margin-top: 10px;">é”™è¯¯: ${result.error_message}</div>`
                        : ''
                    }
                `;

          resultsDiv.appendChild(card);
        });
      }

      // è·å–ç¼–ç èƒ½åŠ›è¯„ä¼°
      async function getEncodingCapability() {
        const selectedPrinterName =
          document.getElementById('printerSelect').value;
        const resultDiv = document.getElementById('compatibilityResult');

        if (!selectedPrinterName) {
          resultDiv.className = 'result error';
          resultDiv.textContent = 'âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ‰“å°æœº';
          return;
        }

        resultDiv.className = 'result info';
        resultDiv.innerHTML = '<div class="loading"></div>æ­£åœ¨è¯„ä¼°ç¼–ç èƒ½åŠ›...';

        try {
          const capability = await window.__TAURI__.invoke(
            'get_printer_encoding_capability',
            {
              printerName: selectedPrinterName,
            }
          );

          resultDiv.className = 'result success';
          resultDiv.innerHTML = `ï¿½ï¿½ ç¼–ç èƒ½åŠ›è¯„ä¼°ç»“æœ

ğŸ–¨ï¸ æ‰“å°æœº: ${capability.printer_name}
ğŸ·ï¸ å“ç‰Œ: ${capability.brand}
ğŸ¯ æ¨èç¼–ç : ${capability.recommended_encoding}
ğŸ“ˆ æ€»ä½“å…¼å®¹æ€§: ${(capability.overall_compatibility * 100).toFixed(1)}%

ğŸ“‹ ç¼–ç æ”¯æŒè¯¦æƒ…:
${capability.tested_encodings
  .map(
    (enc) =>
      `   â€¢ ${enc.encoding_name}: ${(enc.compatibility_score * 100).toFixed(
        1
      )}% ${enc.success ? 'âœ…' : 'âŒ'}`
  )
  .join('\n')}`;

          updateCompatibilityStats(capability);
        } catch (error) {
          resultDiv.className = 'result error';
          resultDiv.textContent = `âŒ è¯„ä¼°å¤±è´¥: ${error}`;
          console.error('è·å–ç¼–ç èƒ½åŠ›å¤±è´¥:', error);
        }
      }

      // æ›´æ–°å…¼å®¹æ€§ç»Ÿè®¡
      function updateCompatibilityStats(capability) {
        const statsDiv = document.getElementById('compatibilityStats');
        const totalTests = capability.tested_encodings.length;
        const successfulTests = capability.tested_encodings.filter(
          (t) => t.success
        ).length;

        document.getElementById('totalTests').textContent = totalTests;
        document.getElementById('successfulTests').textContent =
          successfulTests;
        document.getElementById('overallScore').textContent = `${(
          capability.overall_compatibility * 100
        ).toFixed(1)}%`;
        document.getElementById('recommendedEncoding').textContent =
          capability.recommended_encoding;

        statsDiv.style.display = 'grid';
      }

      // è¿è¡Œå®Œæ•´å…¼å®¹æ€§æµ‹è¯•
      async function runFullCompatibilityTest() {
        const selectedPrinterName =
          document.getElementById('printerSelect').value;

        if (!selectedPrinterName) {
          alert('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ‰“å°æœº');
          return;
        }

        // å…ˆè¿è¡Œæ–‡æœ¬åˆ†æ
        const testText =
          document.getElementById('analyzeText').value ||
          'ä¸­æ–‡æµ‹è¯•ï¼šä½ å¥½ä¸–ç•Œï¼è®¢å•#12345';
        await analyzeTextEncoding();

        // å†è¿è¡Œæ‰“å°æœºæµ‹è¯•
        await testPrinterChinese();

        // æœ€åè·å–ç¼–ç èƒ½åŠ›
        await getEncodingCapability();

        alert('ğŸ‰ å®Œæ•´å…¼å®¹æ€§æµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹å„ä¸ªæµ‹è¯•ç»“æœã€‚');
      }

      // è®¾ç½®ç¼–ç åå¥½
      async function setEncodingPreference() {
        const selectedPrinterName =
          document.getElementById('printerSelect').value;
        const preferredEncoding =
          document.getElementById('encodingPreference').value;
        const fallbackEncodingsText =
          document.getElementById('fallbackEncodings').value;
        const resultDiv = document.getElementById('currentSettings');

        if (!selectedPrinterName) {
          resultDiv.className = 'result error';
          resultDiv.textContent = 'âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ‰“å°æœº';
          return;
        }

        const fallbackEncodings = fallbackEncodingsText
          .split(',')
          .map((enc) => enc.trim())
          .filter((enc) => enc.length > 0);

        try {
          await window.__TAURI__.invoke('set_printer_encoding_preference', {
            printerName: selectedPrinterName,
            preferredEncoding: preferredEncoding,
            fallbackEncodings:
              fallbackEncodings.length > 0 ? fallbackEncodings : null,
          });

          resultDiv.className = 'result success';
          resultDiv.innerHTML = `âœ… ç¼–ç è®¾ç½®ä¿å­˜æˆåŠŸ

ğŸ–¨ï¸ æ‰“å°æœº: ${selectedPrinterName}
ğŸ¯ é¦–é€‰ç¼–ç : ${preferredEncoding}
ğŸ“‹ å¤‡ç”¨ç¼–ç : ${fallbackEncodings.join(', ')}

è®¾ç½®å·²ä¿å­˜å¹¶ç«‹å³ç”Ÿæ•ˆã€‚`;

          console.log('ğŸ’¾ ç¼–ç è®¾ç½®å·²ä¿å­˜');
        } catch (error) {
          resultDiv.className = 'result error';
          resultDiv.textContent = `âŒ ä¿å­˜è®¾ç½®å¤±è´¥: ${error}`;
          console.error('è®¾ç½®ç¼–ç åå¥½å¤±è´¥:', error);
        }
      }

      // åŠ è½½å½“å‰è®¾ç½®
      async function loadCurrentSettings() {
        const resultDiv = document.getElementById('currentSettings');
        resultDiv.textContent = 'å½“å‰ç¼–ç è®¾ç½®å°†åœ¨é€‰æ‹©æ‰“å°æœºåæ˜¾ç¤º...';
      }

      // ä½¿ç”¨æœ€ä½³ç¼–ç æ‰“å°æµ‹è¯•
      async function testPrintWithOptimalEncoding() {
        const selectedPrinterName =
          document.getElementById('printerSelect').value;
        const resultDiv = document.getElementById('printTestResult');

        if (!selectedPrinterName) {
          resultDiv.className = 'result error';
          resultDiv.textContent = 'âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ‰“å°æœº';
          return;
        }

        resultDiv.className = 'result info';
        resultDiv.innerHTML =
          '<div class="loading"></div>æ­£åœ¨æ‰§è¡Œæœ€ä½³ç¼–ç æ‰“å°æµ‹è¯•...';

        try {
          await window.__TAURI__.invoke('test_print', {
            printerName: selectedPrinterName,
          });

          resultDiv.className = 'result success';
          resultDiv.textContent =
            'âœ… æœ€ä½³ç¼–ç æ‰“å°æµ‹è¯•æˆåŠŸå®Œæˆï¼è¯·æ£€æŸ¥æ‰“å°æœºè¾“å‡ºç»“æœã€‚';
        } catch (error) {
          resultDiv.className = 'result error';
          resultDiv.textContent = `âŒ æ‰“å°æµ‹è¯•å¤±è´¥: ${error}`;
          console.error('æ‰“å°æµ‹è¯•å¤±è´¥:', error);
        }
      }

      // æµ‹è¯•æ‰€æœ‰ç¼–ç æ•ˆæœ
      async function testPrintWithAllEncodings() {
        alert('ğŸ”„ å¤šç¼–ç æ‰“å°æµ‹è¯•åŠŸèƒ½å¼€å‘ä¸­...');
      }

      // ç”Ÿæˆæ‰“å°é¢„è§ˆ
      async function generatePreview() {
        const selectedPrinterName =
          document.getElementById('printerSelect').value;
        const resultDiv = document.getElementById('printTestResult');

        if (!selectedPrinterName) {
          resultDiv.className = 'result error';
          resultDiv.textContent = 'âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ‰“å°æœº';
          return;
        }

        resultDiv.className = 'result info';
        resultDiv.innerHTML = '<div class="loading"></div>æ­£åœ¨ç”Ÿæˆæ‰“å°é¢„è§ˆ...';

        try {
          const preview = await window.__TAURI__.invoke('generate_preview', {
            printerName: selectedPrinterName,
          });

          resultDiv.className = 'result success';
          resultDiv.innerHTML = `ğŸ‘ï¸ æ‰“å°é¢„è§ˆç”ŸæˆæˆåŠŸ

${preview}

ğŸ“Š é¢„è§ˆç»Ÿè®¡:
   â€¢ å­—ç¬¦é•¿åº¦: ${preview.length}
   â€¢ è¡Œæ•°: ${preview.split('\n').length}
   â€¢ ä½¿ç”¨ç¼–ç : è‡ªåŠ¨æ£€æµ‹æœ€ä½³ç¼–ç `;
        } catch (error) {
          resultDiv.className = 'result error';
          resultDiv.textContent = `âŒ ç”Ÿæˆé¢„è§ˆå¤±è´¥: ${error}`;
          console.error('ç”Ÿæˆé¢„è§ˆå¤±è´¥:', error);
        }
      }

      // è¿è¡Œç³»ç»Ÿè¯Šæ–­
      async function runDiagnostics() {
        const resultDiv = document.getElementById('diagnosticResult');

        resultDiv.className = 'result info';
        resultDiv.innerHTML = '<div class="loading"></div>æ­£åœ¨è¿è¡Œç³»ç»Ÿè¯Šæ–­...';

        try {
          // ç»¼åˆè¯Šæ–­ä¿¡æ¯
          const printers = await window.__TAURI__.invoke('get_printers');

          let diagnosticInfo = `ğŸ©º ç³»ç»Ÿè¯Šæ–­æŠ¥å‘Š
ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}

ğŸ“Š ç³»ç»ŸçŠ¶æ€:
   â€¢ å¯ç”¨æ‰“å°æœº: ${printers.length} ä¸ª
   â€¢ æ”¯æŒä¸­æ–‡æ‰“å°æœº: ${printers.filter((p) => p.supports_chinese).length} ä¸ª
   
ğŸ–¨ï¸ æ‰“å°æœºè¯¦æƒ…:
${printers
  .map(
    (p) => `   â€¢ ${p.name}
     - å“ç‰Œ: ${p.printer_brand}
     - å®½åº¦: ${p.width}mm
     - ä¸­æ–‡æ”¯æŒ: ${p.supports_chinese ? 'âœ…' : 'âŒ'}
     - é¦–é€‰ç¼–ç : ${p.preferred_encoding}
     - å¤‡ç”¨ç¼–ç : ${p.fallback_encodings.join(', ')}`
  )
  .join('\n')}

ğŸ”¤ ç¼–ç æ”¯æŒçŠ¶æ€:
   â€¢ GBK: ${
     printers.filter((p) => p.fallback_encodings.includes('GBK')).length
   } ä¸ªæ‰“å°æœºæ”¯æŒ
   â€¢ UTF-8: ${
     printers.filter((p) => p.fallback_encodings.includes('UTF8')).length
   } ä¸ªæ‰“å°æœºæ”¯æŒ
   â€¢ GB18030: ${
     printers.filter((p) => p.fallback_encodings.includes('GB18030')).length
   } ä¸ªæ‰“å°æœºæ”¯æŒ

ğŸ’¡ å»ºè®®:
${generateRecommendations(printers)}`;

          resultDiv.className = 'result success';
          resultDiv.innerHTML = diagnosticInfo;
        } catch (error) {
          resultDiv.className = 'result error';
          resultDiv.textContent = `âŒ è¯Šæ–­å¤±è´¥: ${error}`;
          console.error('ç³»ç»Ÿè¯Šæ–­å¤±è´¥:', error);
        }
      }

      // ç”Ÿæˆå»ºè®®
      function generateRecommendations(printers) {
        const recommendations = [];

        const chinesePrinters = printers.filter((p) => p.supports_chinese);
        if (chinesePrinters.length === 0) {
          recommendations.push('âš ï¸ æœªæ£€æµ‹åˆ°æ”¯æŒä¸­æ–‡çš„æ‰“å°æœºï¼Œå»ºè®®æ£€æŸ¥é©±åŠ¨ç¨‹åº');
        }

        const gbkPrinters = printers.filter((p) =>
          p.fallback_encodings.includes('GBK')
        );
        if (gbkPrinters.length > 0) {
          recommendations.push('âœ… æ£€æµ‹åˆ°GBKå…¼å®¹æ‰“å°æœºï¼Œä¸­æ–‡æ‰“å°æ•ˆæœåº”è¯¥è‰¯å¥½');
        }

        const unknownBrands = printers.filter(
          (p) => p.printer_brand === 'Unknown' || p.printer_brand === ''
        );
        if (unknownBrands.length > 0) {
          recommendations.push('ğŸ’¡ æœ‰æœªè¯†åˆ«å“ç‰Œçš„æ‰“å°æœºï¼Œå»ºè®®æ‰‹åŠ¨é…ç½®ç¼–ç è®¾ç½®');
        }

        return recommendations.length > 0
          ? recommendations.join('\n   ')
          : 'âœ… ç³»ç»Ÿé…ç½®è‰¯å¥½ï¼Œæ— éœ€ç‰¹æ®Šè°ƒæ•´';
      }

      // é‡ç½®ç¼–ç è®¾ç½®
      async function resetEncodingSettings() {
        if (confirm('âš ï¸ ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç¼–ç è®¾ç½®å—ï¼Ÿè¿™å°†æ¢å¤åˆ°é»˜è®¤é…ç½®ã€‚')) {
          alert('ğŸ”„ é‡ç½®åŠŸèƒ½å¼€å‘ä¸­...');
        }
      }

      // å¯¼å‡ºè¯Šæ–­æŠ¥å‘Š
      async function exportDiagnosticReport() {
        alert('ğŸ“‹ å¯¼å‡ºè¯Šæ–­æŠ¥å‘ŠåŠŸèƒ½å¼€å‘ä¸­...');
      }

      // é”™è¯¯å¤„ç†
      window.addEventListener('error', function (event) {
        console.error('é¡µé¢é”™è¯¯:', event.error);
      });

      // é¡µé¢å¸è½½æ—¶çš„æ¸…ç†
      window.addEventListener('beforeunload', function () {
        console.log('ğŸ“ ä¿å­˜ä¼šè¯çŠ¶æ€...');
      });
    </script>
  </body>
</html>
