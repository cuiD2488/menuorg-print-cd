<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸­æ–‡ç¼–ç å¢å¼ºç‰ˆæ‰“å°æœºæµ‹è¯•</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-align: center;
        margin: -20px -20px 20px -20px;
        padding: 30px 20px;
        border-radius: 8px 8px 0 0;
      }
      .btn {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }
      .btn:hover {
        background: #45a049;
      }
      .btn-secondary {
        background: #2196f3;
      }
      .btn-secondary:hover {
        background: #1976d2;
      }
      .btn-warning {
        background: #ff9800;
      }
      .btn-warning:hover {
        background: #f57c00;
      }
      .printer-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }
      .printer-card {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 15px;
        background: #fafafa;
      }
      .printer-card.enabled {
        border-color: #4caf50;
        background: #f1f8e9;
      }
      .encoding-result {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 12px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .test-area {
        margin: 20px 0;
      }
      .test-text {
        width: 100%;
        height: 100px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
      }
      .status {
        padding: 8px 12px;
        border-radius: 4px;
        font-weight: bold;
        display: inline-block;
        margin: 5px 0;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .progress {
        width: 100%;
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #45a049);
        width: 0%;
        transition: width 0.3s ease;
      }
      .encoding-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin: 15px 0;
      }
      .encoding-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 12px;
        text-align: center;
      }
      .encoding-card.best {
        border-color: #4caf50;
        background: #f1f8e9;
      }
      .score {
        font-size: 24px;
        font-weight: bold;
        margin: 8px 0;
      }
      .score.excellent {
        color: #4caf50;
      }
      .score.good {
        color: #2196f3;
      }
      .score.fair {
        color: #ff9800;
      }
      .score.poor {
        color: #f44336;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ–¨ï¸ ä¸­æ–‡ç¼–ç å¢å¼ºç‰ˆæ‰“å°æœºæµ‹è¯•</h1>
        <p>åŸºäº main.rs å®ç°é€»è¾‘çš„ JavaScript ç‰ˆæœ¬</p>
        <div
          class="alert"
          id="browserAlert"
          style="
            display: none;
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
          "
        >
          <strong>ğŸŒ æµè§ˆå™¨ç¯å¢ƒæç¤º:</strong>
          æ‚¨æ­£åœ¨æµè§ˆå™¨ä¸­è¿è¡Œæ¼”ç¤ºæ¨¡å¼ï¼Œæ‰€æœ‰æ‰“å°åŠŸèƒ½å°†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ã€‚è‹¥è¦ä½¿ç”¨å®é™…æ‰“å°æœºï¼Œè¯·åœ¨Electronåº”ç”¨ä¸­è¿è¡Œæ­¤ç³»ç»Ÿã€‚
        </div>
      </div>

      <!-- æ‰“å°æœºç®¡ç†åŒºåŸŸ -->
      <div class="section">
        <h2>ğŸ“‹ æ‰“å°æœºç®¡ç†</h2>
        <button class="btn" onclick="initPrinterManager()">
          åˆå§‹åŒ–æ‰“å°æœºç®¡ç†å™¨
        </button>
        <button class="btn btn-secondary" onclick="loadPrinters()">
          åˆ·æ–°æ‰“å°æœºåˆ—è¡¨
        </button>
        <button class="btn btn-warning" onclick="testAllPrintersEncoding()">
          æ‰¹é‡ç¼–ç æµ‹è¯•
        </button>

        <div id="printerList" class="printer-list"></div>
      </div>

      <!-- ç¼–ç æ£€æµ‹æµ‹è¯•åŒºåŸŸ -->
      <div class="section">
        <h2>ğŸ” ç¼–ç æ£€æµ‹æµ‹è¯•</h2>
        <div class="test-area">
          <label for="testText">æµ‹è¯•æ–‡æœ¬ï¼š</label>
          <textarea
            id="testText"
            class="test-text"
            placeholder="è¾“å…¥è¦æµ‹è¯•çš„ä¸­æ–‡æ–‡æœ¬..."
          >
ç®€ä½“ä¸­æ–‡æµ‹è¯•ï¼šä½ å¥½ä¸–ç•Œï¼è®¢å•#123ï¼Œæ€»è®¡ï¿¥99.50
ç¹é«”ä¸­æ–‡æ¸¬è©¦ï¼šæ‚¨å¥½ä¸–ç•Œï¼è¨‚å–®#123ï¼Œç¸½è¨ˆï¿¥99.50
æ··åˆæ–‡æœ¬æµ‹è©¦ï¼šHello ä¸–ç•Œï¼Order#123ï¼Œç¸½è¨ˆ$99.50
ç¬¦å·æµ‹è¯•ï¼šã€è®¢å•ã€‘â€»ï¿¥ï¼„â‚¬âˆÂ±â‰ â‰¤â‰¥
èœå“ï¼šå®«ä¿é¸¡ä¸ã€éº»å©†è±†è…ã€ç™½ç±³é¥­
åœ°å€ï¼šåŒ—äº¬å¸‚æœé˜³åŒºæœ›äº¬è¡—é“123å·2Bå®¤</textarea
          >

          <div>
            <button class="btn" onclick="detectEncoding()">æ£€æµ‹ç¼–ç ç±»å‹</button>
            <button class="btn btn-secondary" onclick="testAllEncodings()">
              æµ‹è¯•æ‰€æœ‰ç¼–ç 
            </button>
            <button class="btn btn-warning" onclick="autoSelectEncoding()">
              æ™ºèƒ½é€‰æ‹©ç¼–ç 
            </button>
          </div>
        </div>

        <div id="encodingResult" class="encoding-result"></div>
      </div>

      <!-- æ‰“å°æœºç¼–ç å…¼å®¹æ€§æµ‹è¯• -->
      <div class="section">
        <h2>ğŸ§ª æ‰“å°æœºç¼–ç å…¼å®¹æ€§æµ‹è¯•</h2>
        <div id="printerTestControls"></div>
        <div id="testProgress" style="display: none">
          <div class="progress">
            <div id="progressBar" class="progress-bar"></div>
          </div>
          <div id="progressText">æµ‹è¯•è¿›è¡Œä¸­...</div>
        </div>
        <div id="compatibilityResults"></div>
      </div>

      <!-- æµ‹è¯•æŠ¥å‘Šå¯¼å‡º -->
      <div class="section">
        <h2>ğŸ“„ æµ‹è¯•æŠ¥å‘Š</h2>
        <button class="btn" onclick="exportReport('json')">
          å¯¼å‡º JSON æŠ¥å‘Š
        </button>
        <button class="btn btn-secondary" onclick="exportReport('csv')">
          å¯¼å‡º CSV æŠ¥å‘Š
        </button>
        <button class="btn btn-warning" onclick="exportReport('txt')">
          å¯¼å‡ºæ–‡æœ¬æŠ¥å‘Š
        </button>
        <div id="reportStatus"></div>
      </div>
    </div>

    <!-- å¼•å…¥å¢å¼ºç‰ˆæ‰“å°æœºç®¡ç†å™¨ -->
    <script src="renderer/js/printer.js"></script>

    <script>
      let printerManager = null;
      let lastTestResults = null;

      // åˆå§‹åŒ–æ‰“å°æœºç®¡ç†å™¨
      async function initPrinterManager() {
        try {
          updateStatus('æ­£åœ¨åˆå§‹åŒ–æ‰“å°æœºç®¡ç†å™¨...', 'warning');

          // æ£€æµ‹è¿è¡Œç¯å¢ƒ
          const isBrowser = !window.electronAPI;
          if (isBrowser) {
            document.getElementById('browserAlert').style.display = 'block';
            console.log('ğŸŒ æ£€æµ‹åˆ°æµè§ˆå™¨ç¯å¢ƒï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
          }

          printerManager = new PrinterManager();
          await printerManager.init();
          updateStatus(
            'âœ… æ‰“å°æœºç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ' + (isBrowser ? ' (æ¼”ç¤ºæ¨¡å¼)' : ''),
            'success'
          );
          await loadPrinters();
        } catch (error) {
          updateStatus(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
          console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        }
      }

      // åŠ è½½æ‰“å°æœºåˆ—è¡¨
      async function loadPrinters() {
        if (!printerManager) {
          updateStatus('è¯·å…ˆåˆå§‹åŒ–æ‰“å°æœºç®¡ç†å™¨', 'warning');
          return;
        }

        try {
          updateStatus('æ­£åœ¨åŠ è½½æ‰“å°æœºåˆ—è¡¨...', 'warning');
          const printers = await printerManager.loadPrinters();
          displayPrinters(printers);
          updateStatus(`âœ… å·²åŠ è½½ ${printers.length} å°æ‰“å°æœº`, 'success');
        } catch (error) {
          updateStatus(`âŒ åŠ è½½æ‰“å°æœºå¤±è´¥: ${error.message}`, 'error');
          console.error('åŠ è½½æ‰“å°æœºå¤±è´¥:', error);
        }
      }

      // æ˜¾ç¤ºæ‰“å°æœºåˆ—è¡¨
      function displayPrinters(printers) {
        const listElement = document.getElementById('printerList');
        listElement.innerHTML = '';

        printers.forEach((printer, index) => {
          const encodingInfo = printerManager.getEncodingInfo(printer.name);
          const card = document.createElement('div');
          card.className = `printer-card ${printer.isEnabled ? 'enabled' : ''}`;
          card.innerHTML = `
                    <h4>${printer.name}</h4>
                    <p><strong>çŠ¶æ€:</strong> ${printer.status}</p>
                    <p><strong>ç±»å‹:</strong> ${
                      printer.isThermal ? 'çƒ­æ•' : 'æ™®é€š'
                    } (${printer.width}mm)</p>
                    <p><strong>ä¸­æ–‡æ”¯æŒ:</strong> ${
                      printer.supportsChinese ? 'âœ… æ˜¯' : 'âŒ å¦'
                    }</p>
                    <p><strong>æ¨èç¼–ç :</strong> ${
                      printer.recommendedEncoding
                    }</p>
                    <p><strong>å¤‡ç”¨ç¼–ç :</strong> ${printer.fallbackEncodings.join(
                      ', '
                    )}</p>
                    <div>
                        <button class="btn ${
                          printer.isEnabled ? 'btn-warning' : ''
                        }" 
                                onclick="togglePrinter('${
                                  printer.name
                                }', ${!printer.isEnabled})">
                            ${printer.isEnabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                        </button>
                        <button class="btn btn-secondary" 
                                onclick="testSinglePrinter('${printer.name}')">
                            ç¼–ç æµ‹è¯•
                        </button>
                    </div>
                `;
          listElement.appendChild(card);
        });

        // æ›´æ–°æµ‹è¯•æ§åˆ¶é¢æ¿
        updateTestControls(printers);
      }

      // æ›´æ–°æµ‹è¯•æ§åˆ¶é¢æ¿
      function updateTestControls(printers) {
        const controlsElement = document.getElementById('printerTestControls');
        const enabledPrinters = printers.filter((p) => p.isEnabled);

        if (enabledPrinters.length === 0) {
          controlsElement.innerHTML =
            '<p class="status warning">è¯·å…ˆå¯ç”¨è‡³å°‘ä¸€å°æ‰“å°æœºè¿›è¡Œæµ‹è¯•</p>';
          return;
        }

        controlsElement.innerHTML = `
                <p>å·²å¯ç”¨æ‰“å°æœº (${enabledPrinters.length}/${
          printers.length
        }):</p>
                <div class="encoding-info">
                    ${enabledPrinters
                      .map(
                        (printer) => `
                        <div class="encoding-card">
                            <strong>${printer.name}</strong><br>
                            ${printer.recommendedEncoding}
                        </div>
                    `
                      )
                      .join('')}
                </div>
            `;
      }

      // åˆ‡æ¢æ‰“å°æœºå¯ç”¨çŠ¶æ€
      async function togglePrinter(printerName, enabled) {
        if (!printerManager) return;

        try {
          await printerManager.togglePrinter(printerName, enabled);
          updateStatus(
            `âœ… ${printerName} å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`,
            'success'
          );
          await loadPrinters(); // åˆ·æ–°æ˜¾ç¤º
        } catch (error) {
          updateStatus(`âŒ æ“ä½œå¤±è´¥: ${error.message}`, 'error');
        }
      }

      // æµ‹è¯•å•ä¸ªæ‰“å°æœºç¼–ç 
      async function testSinglePrinter(printerName) {
        if (!printerManager) return;

        try {
          updateStatus(
            `æ­£åœ¨æµ‹è¯•æ‰“å°æœº ${printerName} çš„ç¼–ç å…¼å®¹æ€§...`,
            'warning'
          );
          const printer = printerManager.printers.find(
            (p) => p.name === printerName
          );
          const result = await printerManager.testPrinterEncodings(printer);

          displayCompatibilityResult(printerName, result);
          updateStatus(`âœ… ${printerName} ç¼–ç æµ‹è¯•å®Œæˆ`, 'success');
        } catch (error) {
          updateStatus(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // æ‰¹é‡æµ‹è¯•æ‰€æœ‰æ‰“å°æœºç¼–ç 
      async function testAllPrintersEncoding() {
        if (!printerManager) return;

        try {
          showProgress(true);
          updateStatus('æ­£åœ¨æ‰¹é‡æµ‹è¯•æ‰€æœ‰å¯ç”¨æ‰“å°æœºçš„ç¼–ç å…¼å®¹æ€§...', 'warning');

          const results = await printerManager.testAllPrintersEncoding();
          lastTestResults = results;

          displayBatchResults(results);
          showProgress(false);
          updateStatus('âœ… æ‰¹é‡ç¼–ç æµ‹è¯•å®Œæˆ', 'success');
        } catch (error) {
          showProgress(false);
          updateStatus(`âŒ æ‰¹é‡æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        }
      }

      // æ˜¾ç¤ºå…¼å®¹æ€§æµ‹è¯•ç»“æœ
      function displayCompatibilityResult(printerName, result) {
        const resultsElement = document.getElementById('compatibilityResults');

        const resultCard = document.createElement('div');
        resultCard.className = 'container';
        resultCard.innerHTML = `
                <h3>ğŸ–¨ï¸ ${printerName} ç¼–ç å…¼å®¹æ€§æŠ¥å‘Š</h3>
                <div class="encoding-info">
                    ${Object.entries(result.compatibilityReport.encodingScores)
                      .map(
                        ([encoding, scoreInfo]) => `
                        <div class="encoding-card ${
                          scoreInfo.averageScore >= 0.9 ? 'best' : ''
                        }">
                            <div><strong>${encoding}</strong></div>
                            <div class="score ${getScoreClass(
                              scoreInfo.averageScore
                            )}">
                                ${(scoreInfo.averageScore * 100).toFixed(1)}%
                            </div>
                            <div>${scoreInfo.grade}</div>
                        </div>
                    `
                      )
                      .join('')}
                </div>
                
                <div class="status ${
                  result.compatibilityReport.overallScore >= 0.8
                    ? 'success'
                    : result.compatibilityReport.overallScore >= 0.6
                    ? 'warning'
                    : 'error'
                }">
                    æ€»ä½“å…¼å®¹æ€§: ${(
                      result.compatibilityReport.overallScore * 100
                    ).toFixed(1)}%
                </div>
                
                <div>
                    <h4>å»ºè®®:</h4>
                    ${result.compatibilityReport.recommendations
                      .map((rec) => `<p>â€¢ ${rec}</p>`)
                      .join('')}
                </div>
                
                ${
                  result.compatibilityReport.warnings.length > 0
                    ? `
                    <div>
                        <h4>è­¦å‘Š:</h4>
                        ${result.compatibilityReport.warnings
                          .map(
                            (warn) => `<p class="status warning">âš ï¸ ${warn}</p>`
                          )
                          .join('')}
                    </div>
                `
                    : ''
                }
            `;

        resultsElement.appendChild(resultCard);
      }

      // æ˜¾ç¤ºæ‰¹é‡æµ‹è¯•ç»“æœ
      function displayBatchResults(results) {
        const resultsElement = document.getElementById('compatibilityResults');
        resultsElement.innerHTML = '';

        // æ˜¾ç¤ºæ€»ç»“æŠ¥å‘Š
        const summaryCard = document.createElement('div');
        summaryCard.className = 'container';
        summaryCard.innerHTML = `
                <h3>ğŸ“Š æ‰¹é‡æµ‹è¯•æ€»ç»“æŠ¥å‘Š</h3>
                <div class="encoding-info">
                    <div class="encoding-card">
                        <strong>æ€»æ‰“å°æœºæ•°</strong><br>
                        <div class="score">${
                          results.summary.totalPrinters
                        }</div>
                    </div>
                    <div class="encoding-card">
                        <strong>æµ‹è¯•æˆåŠŸ</strong><br>
                        <div class="score good">${
                          results.summary.successfulTests
                        }</div>
                    </div>
                    <div class="encoding-card">
                        <strong>æµ‹è¯•å¤±è´¥</strong><br>
                        <div class="score ${
                          results.summary.failedTests > 0 ? 'poor' : 'good'
                        }">${results.summary.failedTests}</div>
                    </div>
                    <div class="encoding-card best">
                        <strong>æ¨èç¼–ç </strong><br>
                        <div class="score">${
                          results.summary.bestOverallEncoding || 'N/A'
                        }</div>
                    </div>
                </div>
                
                <div class="status ${
                  results.summary.averageCompatibility >= 0.8
                    ? 'success'
                    : results.summary.averageCompatibility >= 0.6
                    ? 'warning'
                    : 'error'
                }">
                    å¹³å‡å…¼å®¹æ€§: ${(
                      results.summary.averageCompatibility * 100
                    ).toFixed(1)}%
                </div>
                
                <div>
                    <h4>å»ºè®®:</h4>
                    ${results.summary.recommendations
                      .map((rec) => `<p>â€¢ ${rec}</p>`)
                      .join('')}
                </div>
            `;
        resultsElement.appendChild(summaryCard);

        // æ˜¾ç¤ºå„ä¸ªæ‰“å°æœºçš„è¯¦ç»†ç»“æœ
        for (const [printerName, result] of Object.entries(
          results.individual
        )) {
          if (result.error) {
            const errorCard = document.createElement('div');
            errorCard.className = 'container';
            errorCard.innerHTML = `
                        <h3>âŒ ${printerName} æµ‹è¯•å¤±è´¥</h3>
                        <div class="status error">${result.error}</div>
                    `;
            resultsElement.appendChild(errorCard);
          } else {
            displayCompatibilityResult(printerName, result);
          }
        }
      }

      // ç¼–ç æ£€æµ‹åŠŸèƒ½
      function detectEncoding() {
        const text = document.getElementById('testText').value;
        if (!text.trim()) {
          updateEncodingResult('è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬');
          return;
        }

        const detector = new ChineseEncodingDetector();
        const charType = detector.detectChineseType(text);

        updateEncodingResult(`ğŸ” å­—ç¬¦ç±»å‹æ£€æµ‹ç»“æœ: ${charType}

ğŸ“ æ–‡æœ¬åˆ†æ:
- æ–‡æœ¬é•¿åº¦: ${text.length} å­—ç¬¦
- æ˜¾ç¤ºå®½åº¦: ${calculateDisplayWidth(text)} å•ä½
- å­—ç¬¦ç±»å‹: ${getCharTypeDescription(charType)}
`);
      }

      // æµ‹è¯•æ‰€æœ‰ç¼–ç 
      function testAllEncodings() {
        const text = document.getElementById('testText').value;
        if (!text.trim()) {
          updateEncodingResult('è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬');
          return;
        }

        const detector = new ChineseEncodingDetector();
        const results = detector.testAllEncodings(text);

        let output = 'ğŸ§ª æ‰€æœ‰ç¼–ç å…¼å®¹æ€§æµ‹è¯•ç»“æœ:\n\n';
        results.forEach((result, index) => {
          output += `${index + 1}. ${result.encoding}:\n`;
          output += `   å…¼å®¹æ€§è¯„åˆ†: ${(result.compatibilityScore * 100).toFixed(
            1
          )}%\n`;
          output += `   ç¼–ç å¤§å°: ${result.encodedSize} å­—èŠ‚\n`;
          output += `   æµ‹è¯•çŠ¶æ€: ${result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\n`;
          output += `   é”™è¯¯æ•°é‡: ${result.errorCount}\n\n`;
        });

        updateEncodingResult(output);
      }

      // æ™ºèƒ½é€‰æ‹©ç¼–ç 
      function autoSelectEncoding() {
        const text = document.getElementById('testText').value;
        if (!text.trim()) {
          updateEncodingResult('è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬');
          return;
        }

        const detector = new ChineseEncodingDetector();
        const charType = detector.detectChineseType(text);
        const selectedEncoding = detector.autoSelectEncoding(text, {
          recommendedEncoding: ChineseEncoding.AUTO,
          fallbackEncodings: [
            ChineseEncoding.GBK,
            ChineseEncoding.UTF8,
            ChineseEncoding.GB18030,
            ChineseEncoding.BIG5,
          ],
        });

        updateEncodingResult(`ğŸ¯ æ™ºèƒ½ç¼–ç é€‰æ‹©ç»“æœ:

æ£€æµ‹çš„å­—ç¬¦ç±»å‹: ${charType}
æ¨èç¼–ç : ${selectedEncoding}
ç¼–ç æè¿°: ${getEncodingDescription(selectedEncoding)}

é€‰æ‹©åŸå› : ${getEncodingReason(charType, selectedEncoding)}
`);
      }

      // å¯¼å‡ºæŠ¥å‘Š
      function exportReport(format) {
        if (!lastTestResults) {
          updateReportStatus(
            'âŒ æ²¡æœ‰å¯å¯¼å‡ºçš„æµ‹è¯•ç»“æœï¼Œè¯·å…ˆè¿è¡Œæ‰¹é‡æµ‹è¯•',
            'error'
          );
          return;
        }

        try {
          if (printerManager) {
            printerManager.exportEncodingReport(lastTestResults, format);
            updateReportStatus(
              `âœ… ${format.toUpperCase()} æŠ¥å‘Šå¯¼å‡ºæˆåŠŸ`,
              'success'
            );
          } else {
            updateReportStatus('âŒ æ‰“å°æœºç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
          }
        } catch (error) {
          updateReportStatus(`âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
        }
      }

      // å·¥å…·å‡½æ•°
      function updateStatus(message, type = 'info') {
        console.log(`[${type.toUpperCase()}] ${message}`);
        // å¯ä»¥åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
      }

      function updateEncodingResult(text) {
        document.getElementById('encodingResult').textContent = text;
      }

      function updateReportStatus(message, type) {
        const statusElement = document.getElementById('reportStatus');
        statusElement.innerHTML = `<div class="status ${type}">${message}</div>`;
        setTimeout(() => {
          statusElement.innerHTML = '';
        }, 5000);
      }

      function showProgress(show) {
        const progressElement = document.getElementById('testProgress');
        progressElement.style.display = show ? 'block' : 'none';

        if (show) {
          let progress = 0;
          const interval = setInterval(() => {
            progress += Math.random() * 20;
            if (progress >= 90) {
              progress = 90;
              clearInterval(interval);
            }
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById(
              'progressText'
            ).textContent = `æµ‹è¯•è¿›è¡Œä¸­... ${Math.round(progress)}%`;
          }, 500);
        }
      }

      function getScoreClass(score) {
        if (score >= 0.95) return 'excellent';
        if (score >= 0.85) return 'good';
        if (score >= 0.7) return 'fair';
        return 'poor';
      }

      function getCharTypeDescription(charType) {
        const descriptions = {
          NONE: 'æ— ä¸­æ–‡å­—ç¬¦',
          SYMBOLS_ONLY: 'ä»…åŒ…å«ä¸­æ–‡ç¬¦å·',
          SIMPLIFIED: 'ç®€ä½“ä¸­æ–‡',
          TRADITIONAL: 'ç¹ä½“ä¸­æ–‡',
          MIXED: 'ç®€ç¹æ··åˆ',
        };
        return descriptions[charType] || 'æœªçŸ¥ç±»å‹';
      }

      function getEncodingDescription(encoding) {
        const descriptions = {
          UTF8: 'UTF-8 - é€šç”¨Unicodeç¼–ç ï¼Œå…¼å®¹æ€§æœ€å¥½ä½†æ–‡ä»¶è¾ƒå¤§',
          GBK: 'GBK - ç®€ä½“ä¸­æ–‡æ ‡å‡†ç¼–ç ï¼Œé€‚åˆå¤§é™†åœ°åŒºä½¿ç”¨',
          GB2312: 'GB2312 - ç®€ä½“ä¸­æ–‡åŸºç¡€ç¼–ç ï¼Œå­—ç¬¦é›†è¾ƒå°‘',
          GB18030: 'GB18030 - æœ€æ–°ä¸­æ–‡å›½æ ‡ç¼–ç ï¼Œå­—ç¬¦é›†æœ€å…¨',
          BIG5: 'Big5 - ç¹ä½“ä¸­æ–‡æ ‡å‡†ç¼–ç ï¼Œé€‚åˆæ¸¯å°åœ°åŒºä½¿ç”¨',
          AUTO: 'è‡ªåŠ¨æ£€æµ‹ - æ ¹æ®æ–‡æœ¬å†…å®¹æ™ºèƒ½é€‰æ‹©æœ€ä½³ç¼–ç ',
        };
        return descriptions[encoding] || 'æœªçŸ¥ç¼–ç ';
      }

      function getEncodingReason(charType, encoding) {
        if (charType === 'SIMPLIFIED' && encoding === 'GBK') {
          return 'ç®€ä½“ä¸­æ–‡æ–‡æœ¬ï¼ŒGBKç¼–ç å…¼å®¹æ€§æœ€ä½³';
        } else if (charType === 'TRADITIONAL' && encoding === 'BIG5') {
          return 'ç¹ä½“ä¸­æ–‡æ–‡æœ¬ï¼ŒBig5ç¼–ç å…¼å®¹æ€§æœ€ä½³';
        } else if (charType === 'MIXED' && encoding === 'UTF8') {
          return 'æ··åˆæ–‡æœ¬ï¼ŒUTF-8ç¼–ç é€šç”¨æ€§æœ€å¼º';
        } else if (encoding === 'UTF8') {
          return 'é»˜è®¤é€‰æ‹©UTF-8ï¼Œç¡®ä¿æœ€å¤§å…¼å®¹æ€§';
        }
        return 'åŸºäºå­—ç¬¦åˆ†æçš„æ™ºèƒ½é€‰æ‹©';
      }

      function calculateDisplayWidth(text) {
        let width = 0;
        for (const char of text) {
          if (char.charCodeAt(0) > 127) {
            width += 2; // ä¸­æ–‡å­—ç¬¦å 2ä¸ªä½ç½®
          } else {
            width += 1; // ASCIIå­—ç¬¦å 1ä¸ªä½ç½®
          }
        }
        return width;
      }

      // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆå§‹åŒ–
      window.addEventListener('load', () => {
        console.log('ğŸš€ ä¸­æ–‡ç¼–ç å¢å¼ºç‰ˆæ‰“å°æœºæµ‹è¯•é¡µé¢å·²åŠ è½½');
        console.log(
          'ğŸ“‹ å¯ç”¨åŠŸèƒ½: ç¼–ç æ£€æµ‹ã€å…¼å®¹æ€§æµ‹è¯•ã€æ™ºèƒ½ç¼–ç é€‰æ‹©ã€æ‰¹é‡æµ‹è¯•ã€æŠ¥å‘Šå¯¼å‡º'
        );
      });
    </script>
  </body>
</html>
