<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ‰“å°ç»´æŠ¤åŠŸèƒ½æ¼”ç¤º - LODOPæ‰“å°ç³»ç»Ÿ</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .content {
        padding: 30px;
      }

      .section {
        margin-bottom: 30px;
        padding: 25px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        background: #fafafa;
      }

      .section h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.5em;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 10px;
      }

      .printer-actions {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn-print {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
      }

      .btn-preview {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
      }

      .btn-test {
        background: linear-gradient(135deg, #ff9800, #f57c00);
        color: white;
      }

      .btn-maintenance {
        background: linear-gradient(135deg, #9c27b0, #7b1fa2);
        color: white;
      }

      .btn-clear {
        background: linear-gradient(135deg, #f44336, #d32f2f);
        color: white;
      }

      .btn-setup {
        background: linear-gradient(135deg, #607d8b, #455a64);
        color: white;
      }

      .btn-custom {
        background: linear-gradient(135deg, #795548, #5d4037);
        color: white;
      }

      .btn-clear-specific {
        background: linear-gradient(135deg, #e91e63, #c2185b);
        color: white;
      }

      .btn-refresh {
        background: linear-gradient(135deg, #009688, #00796b);
        color: white;
      }

      .maintenance-panel {
        background: #fff;
        border: 2px solid #9c27b0;
        border-radius: 10px;
        padding: 25px;
        margin-top: 20px;
      }

      .maintenance-panel h3 {
        color: #9c27b0;
        margin-bottom: 20px;
        font-size: 1.4em;
      }

      .maintenance-info {
        background: #f3e5f5;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 25px;
      }

      .maintenance-info ul {
        margin-left: 20px;
      }

      .maintenance-info li {
        margin-bottom: 8px;
        line-height: 1.6;
      }

      .maintenance-controls {
        background: #fafafa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 25px;
      }

      .control-group {
        margin-bottom: 20px;
      }

      .control-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .control-group select,
      .control-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .control-group select:focus,
      .control-group input:focus {
        outline: none;
        border-color: #9c27b0;
      }

      .control-group small {
        display: block;
        margin-top: 5px;
        color: #666;
        font-style: italic;
      }

      .control-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .maintenance-status {
        background: #e8f5e8;
        padding: 20px;
        border-radius: 8px;
        border-left: 5px solid #4caf50;
      }

      .maintenance-status h4 {
        color: #2e7d32;
        margin-bottom: 15px;
      }

      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }

      .status-item {
        background: white;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #4caf50;
      }

      .status-item strong {
        display: block;
        color: #2e7d32;
        margin-bottom: 5px;
      }

      .printer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }

      .printer-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        transition: all 0.3s ease;
      }

      .printer-card:hover {
        border-color: #4caf50;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .printer-card.selected {
        border-color: #4caf50;
        background: #f1f8e9;
      }

      .printer-card h4 {
        color: #333;
        margin-bottom: 10px;
        font-size: 1.1em;
      }

      .printer-card .printer-info {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 10px;
      }

      .printer-card .printer-actions {
        margin-top: 10px;
        justify-content: flex-start;
      }

      .printer-card .btn {
        font-size: 12px;
        padding: 8px 12px;
      }

      .log-panel {
        background: #263238;
        color: #4caf50;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        font-family: 'Courier New', monospace;
        max-height: 300px;
        overflow-y: auto;
      }

      .log-panel h4 {
        color: #81c784;
        margin-bottom: 15px;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 5px 0;
        border-bottom: 1px solid #37474f;
      }

      .log-timestamp {
        color: #90a4ae;
        font-size: 0.8em;
      }

      .log-message {
        margin-left: 15px;
      }

      .alert {
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
      }

      .alert-info {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        color: #1565c0;
      }

      .alert-success {
        background: #e8f5e8;
        border-left: 4px solid #4caf50;
        color: #2e7d32;
      }

      .alert-warning {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
        color: #ef6c00;
      }

      .alert-error {
        background: #ffebee;
        border-left: 4px solid #f44336;
        color: #c62828;
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 768px) {
        .printer-actions,
        .control-buttons {
          flex-direction: column;
        }

        .btn {
          width: 100%;
          margin-bottom: 10px;
        }

        .status-grid,
        .printer-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ”§ æ‰“å°ç»´æŠ¤åŠŸèƒ½æ¼”ç¤º</h1>
        <p>LODOP æ‰“å°ç³»ç»Ÿ - å®¢æˆ·ç«¯æ‰“å°ä½ç½®å¾®è°ƒå·¥å…·</p>
      </div>

      <div class="content">
        <!-- ğŸ¯ æ‰“å°æœºç®¡ç†åŒºåŸŸ -->
        <div class="section">
          <h2>ğŸ–¨ï¸ æ‰“å°æœºç®¡ç†</h2>
          <div class="alert alert-info">
            <strong>ğŸ“‹ è¯´æ˜ï¼š</strong>
            ç³»ç»Ÿå°†è‡ªåŠ¨æ£€æµ‹å¯ç”¨æ‰“å°æœºã€‚è¯·é€‰æ‹©éœ€è¦è¿›è¡Œä½ç½®è°ƒæ•´çš„æ‰“å°æœºã€‚
          </div>

          <div class="printer-actions">
            <button onclick="initSystem()" class="btn btn-primary">
              ğŸš€ åˆå§‹åŒ–ç³»ç»Ÿ
            </button>
            <button onclick="refreshPrinters()" class="btn btn-info">
              ğŸ”„ åˆ·æ–°æ‰“å°æœº
            </button>
            <button onclick="manualCheckCLodopStatus()" class="btn btn-warning">
              ğŸ” æ£€æŸ¥C-LodopçŠ¶æ€
            </button>
            <button onclick="selectAllPrinters()" class="btn btn-secondary">
              âœ… é€‰æ‹©å…¨éƒ¨
            </button>
          </div>

          <div id="printer-list" class="printer-grid">
            <!-- åŠ¨æ€ç”Ÿæˆæ‰“å°æœºåˆ—è¡¨ -->
          </div>
        </div>

        <!-- ğŸ”§ æ‰“å°ç»´æŠ¤æ§åˆ¶åŒºåŸŸ -->
        <div class="section">
          <h2>ğŸ”§ æ‰“å°ç»´æŠ¤æ§åˆ¶</h2>
          <div class="alert alert-warning">
            <strong>âš ï¸ é‡è¦ï¼š</strong>
            æ‰“å°ç»´æŠ¤åŠŸèƒ½ç”¨äºè°ƒæ•´æ‰“å°ä½ç½®åç§»ï¼Œé…ç½®ä¿å­˜åœ¨å®¢æˆ·ç«¯æœ¬åœ°ã€‚æ¯å°æ‰“å°æœºå’Œæ¯ä¸ªä»»åŠ¡åå¯ä»¥æœ‰ç‹¬ç«‹çš„åç§»é…ç½®ã€‚
          </div>

          <!-- ğŸ”§ æ–°å¢ï¼šæ‰“å°ç»´æŠ¤é¢æ¿ -->
          <div class="maintenance-panel">
            <h3>ğŸ”§ æ‰“å°ç»´æŠ¤åŠŸèƒ½</h3>
            <div class="maintenance-info">
              <p>ğŸ“ <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong></p>
              <ul>
                <li>æ‰“å°ç»´æŠ¤ç”¨äºè°ƒæ•´æ‰“å°ä½ç½®åç§»ï¼Œé…ç½®ä¿å­˜åœ¨å®¢æˆ·ç«¯æœ¬åœ°</li>
                <li>ä¸åŒæ‰“å°æœºå¯èƒ½éœ€è¦ä¸åŒçš„åç§»è°ƒæ•´</li>
                <li>è°ƒæ•´åç‚¹å‡»ã€åº”ç”¨ã€‘ä¿å­˜ï¼Œç‚¹å‡»ã€æ¢å¤ç¼ºçœã€‘å¯é‡ç½®</li>
                <li>ä»»åŠ¡åç›¸åŒçš„æ‰“å°ä»»åŠ¡ä¼šä½¿ç”¨ç›¸åŒçš„åç§»é…ç½®</li>
              </ul>
            </div>

            <div class="maintenance-controls">
              <div class="control-group">
                <label for="maintenance-printer">é€‰æ‹©æ‰“å°æœºï¼š</label>
                <select id="maintenance-printer">
                  <option value="">ä½¿ç”¨å½“å‰é€‰ä¸­çš„æ‰“å°æœº</option>
                </select>
              </div>

              <div class="control-group">
                <label for="maintenance-task-name">ä»»åŠ¡åç§°ï¼š</label>
                <input
                  type="text"
                  id="maintenance-task-name"
                  placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤ä»»åŠ¡å"
                />
                <small>ç›¸åŒä»»åŠ¡åçš„æ‰“å°ä¼šä½¿ç”¨ç›¸åŒçš„åç§»é…ç½®</small>
              </div>

              <div class="control-buttons">
                <button onclick="openPrintSetup()" class="btn btn-setup">
                  æ‰“å¼€æ‰“å°ç»´æŠ¤
                </button>
                <button onclick="createCustomSetup()" class="btn btn-custom">
                  è‡ªå®šä¹‰ä»»åŠ¡ç»´æŠ¤
                </button>
                <button
                  onclick="clearSpecificConfig()"
                  class="btn btn-clear-specific"
                >
                  æ¸…é™¤æŒ‡å®šé…ç½®
                </button>
              </div>
            </div>

            <div class="maintenance-status" id="maintenance-status">
              <h4>ğŸ“Š ç»´æŠ¤çŠ¶æ€</h4>
              <div id="maintenance-status-content">
                ç‚¹å‡»åˆ·æ–°çŠ¶æ€æŒ‰é’®è·å–å½“å‰çŠ¶æ€
              </div>
              <button
                onclick="refreshMaintenanceStatus()"
                class="btn btn-refresh"
              >
                åˆ·æ–°çŠ¶æ€
              </button>
            </div>
          </div>
        </div>

        <!-- ğŸ§ª æµ‹è¯•æ‰“å°åŒºåŸŸ -->
        <div class="section">
          <h2>ğŸ§ª æµ‹è¯•æ‰“å°</h2>
          <div class="alert alert-success">
            <strong>âœ… åŠŸèƒ½ï¼š</strong>
            ä½¿ç”¨æµ‹è¯•è®¢å•éªŒè¯æ‰“å°ä½ç½®è°ƒæ•´æ•ˆæœã€‚å»ºè®®å…ˆè¿›è¡Œç»´æŠ¤è°ƒæ•´ï¼Œå†æµ‹è¯•æ‰“å°æ•ˆæœã€‚
          </div>

          <div class="printer-actions">
            <button onclick="testOrderPrint()" class="btn btn-print">
              æµ‹è¯•è®¢å•æ‰“å°
            </button>
            <button onclick="previewOrderPrint()" class="btn btn-preview">
              é¢„è§ˆè®¢å•
            </button>
            <button onclick="testSimplePrint()" class="btn btn-test">
              ç®€å•æµ‹è¯•æ‰“å°
            </button>
          </div>

          <div id="test-order-info" class="alert alert-info hidden">
            <strong>ğŸ“„ æµ‹è¯•è®¢å•ä¿¡æ¯ï¼š</strong>
            <div id="test-order-details"></div>
          </div>
        </div>

        <!-- ğŸ“Š æ“ä½œæ—¥å¿—åŒºåŸŸ -->
        <div class="section">
          <h2>ğŸ“Š æ“ä½œæ—¥å¿—</h2>
          <div class="printer-actions">
            <button onclick="clearLog()" class="btn btn-clear">æ¸…ç©ºæ—¥å¿—</button>
            <button onclick="exportLog()" class="btn btn-custom">
              å¯¼å‡ºæ—¥å¿—
            </button>
          </div>

          <div id="operation-log" class="log-panel">
            <h4>ğŸ” å®æ—¶æ“ä½œæ—¥å¿—</h4>
            <div id="log-content">
              <div class="log-entry">
                <span class="log-timestamp">[ç³»ç»Ÿå¯åŠ¨]</span>
                <div class="log-message">æ‰“å°ç»´æŠ¤æ¼”ç¤ºç³»ç»Ÿå°±ç»ª</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ğŸ”§ ä¿®æ­£è·¯å¾„ï¼šä½¿ç”¨rendererç›®å½•ä¸‹çš„æ­£ç¡®æ–‡ä»¶ -->
    <script src="LodopFuncs.js"></script>
    <script src="../src/printer-lodop.js"></script>

    <script>
      // å…¨å±€å˜é‡
      let printerManager = null;
      let selectedPrinters = [];
      let systemInitialized = false;

      // æµ‹è¯•è®¢å•æ•°æ®
      const testOrder = {
        order_id: 'TEST-' + Date.now(),
        create_time: new Date().toISOString(),
        delivery_time: new Date(Date.now() + 30 * 60 * 1000).toISOString(),
        paystyle: 1,
        recipient_name: 'å¼ ä¸‰',
        recipient_phone: '13800138000',
        delivery_type: 2,
        recipient_address: 'åŒ—äº¬å¸‚æœé˜³åŒºæŸæŸè¡—é“123å·',
        dishes_array: [
          {
            dishes_name: 'å®«ä¿é¸¡ä¸',
            price: '28.00',
            amount: '2',
            remark: 'ä¸è¦èŠ±ç”Ÿï¼Œå¾®è¾£',
            printer_type: '1',
          },
          {
            dishes_name: 'éº»å©†è±†è…',
            price: '22.00',
            amount: '1',
            remark: 'æ­£å¸¸è¾£åº¦',
            printer_type: '1',
          },
          {
            dishes_name: 'ç™½ç±³é¥­',
            price: '3.00',
            amount: '3',
            remark: '',
            printer_type: '2',
          },
          {
            dishes_name: 'å†¬ç“œæ’éª¨æ±¤',
            price: '18.00',
            amount: '1',
            remark: 'æ¸…æ·¡',
            printer_type: '3',
          },
        ],
        sub_total: '109.00',
        discount_total: '0.00',
        tax_fee: '8.72',
        tax_rate: '8.0',
        delivery_fee: '5.00',
        convenience_fee: '3.27',
        convenience_rate: '3.0',
        tip_fee: '10.00',
        total: '136.00',
        order_notes: 'è¯·æŒ‰æ—¶é€è¾¾ï¼Œè°¢è°¢ï¼',
      };

      // ğŸ“‹ æ—¥å¿—ç®¡ç†
      function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logContent = document.getElementById('log-content');
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';

        let icon = '';
        switch (type) {
          case 'success':
            icon = 'âœ…';
            break;
          case 'error':
            icon = 'âŒ';
            break;
          case 'warning':
            icon = 'âš ï¸';
            break;
          case 'maintenance':
            icon = 'ğŸ”§';
            break;
          default:
            icon = 'ğŸ“';
        }

        logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <div class="log-message">${icon} ${message}</div>
            `;

        logContent.appendChild(logEntry);
        logContent.scrollTop = logContent.scrollHeight;

        console.log(`[æ‰“å°ç»´æŠ¤] ${message}`);
      }

      function clearLog() {
        document.getElementById('log-content').innerHTML = `
                <div class="log-entry">
                    <span class="log-timestamp">[æ—¥å¿—å·²æ¸…ç©º]</span>
                    <div class="log-message">ğŸ“ æ“ä½œæ—¥å¿—å·²æ¸…ç©º</div>
                </div>
            `;
        addLog('æ“ä½œæ—¥å¿—å·²æ¸…ç©º');
      }

      function exportLog() {
        const logContent = document.getElementById('log-content').textContent;
        const blob = new Blob([logContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `print-maintenance-log-${new Date()
          .toISOString()
          .slice(0, 19)
          .replace(/:/g, '-')}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        addLog('æ“ä½œæ—¥å¿—å·²å¯¼å‡º');
      }

      // ğŸ—ï¸ ç³»ç»Ÿåˆå§‹åŒ–
      async function initSystem() {
        try {
          addLog('æ­£åœ¨åˆå§‹åŒ–æ‰“å°ç³»ç»Ÿ...', 'info');

          // ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥C-LodopçŠ¶æ€
          addLog('æ£€æŸ¥C-LodopæœåŠ¡çŠ¶æ€...', 'info');

          if (typeof window.checkCLodopStatus === 'function') {
            const clodopStatus = window.checkCLodopStatus();
            addLog(`C-LodopçŠ¶æ€: ${JSON.stringify(clodopStatus)}`, 'info');

            if (!clodopStatus.available) {
              addLog('C-LodopæœåŠ¡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨', 'error');
              if (clodopStatus.error) {
                addLog(`C-Lodopé”™è¯¯: ${clodopStatus.error}`, 'error');
              }
              // ç»§ç»­å°è¯•åˆå§‹åŒ–ï¼Œå¯èƒ½åœ¨åç»­æ­¥éª¤ä¸­æˆåŠŸ
            } else {
              addLog(
                `C-Lodopç‰ˆæœ¬: ${clodopStatus.version}, æ‰“å°æœºæ•°é‡: ${clodopStatus.printerCount}`,
                'success'
              );
            }
          } else {
            addLog(
              'checkCLodopStatuså‡½æ•°æœªå®šä¹‰ï¼Œå¯èƒ½æ˜¯LodopFuncs.jsåŠ è½½é—®é¢˜',
              'warning'
            );
          }

          // ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥getLodopå‡½æ•°
          if (typeof window.getLodop !== 'function') {
            addLog('getLodopå‡½æ•°æœªå®šä¹‰ï¼ŒLodopFuncs.jså¯èƒ½åŠ è½½å¤±è´¥', 'error');
            throw new Error('LodopFuncs.jsåŠ è½½å¤±è´¥ï¼šgetLodopå‡½æ•°ä¸å¯ç”¨');
          }

          // ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥LodopPrinterManagerç±»
          if (typeof LodopPrinterManager !== 'function') {
            addLog(
              'LodopPrinterManagerç±»æœªå®šä¹‰ï¼Œprinter-lodop.jså¯èƒ½åŠ è½½å¤±è´¥',
              'error'
            );
            throw new Error(
              'printer-lodop.jsåŠ è½½å¤±è´¥ï¼šLodopPrinterManagerç±»ä¸å¯ç”¨'
            );
          }

          printerManager = new LodopPrinterManager();
          addLog('LodopPrinterManagerå®ä¾‹å·²åˆ›å»º', 'info');

          const result = await printerManager.init();
          addLog(`æ‰“å°ç®¡ç†å™¨åˆå§‹åŒ–ç»“æœ: ${JSON.stringify(result)}`, 'info');

          if (result.success) {
            systemInitialized = true;
            addLog(`æ‰“å°ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ - å¼•æ“: ${result.engine}`, 'success');
            await refreshPrinters();
          } else {
            throw new Error(result.error || 'åˆå§‹åŒ–å¤±è´¥');
          }
        } catch (error) {
          addLog(`ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
          addLog('å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š', 'info');
          addLog('1. ç¡®è®¤C-LodopæœåŠ¡å·²å®‰è£…å¹¶å¯åŠ¨', 'info');
          addLog('2. æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦å…è®¸localhostè¿æ¥', 'info');
          addLog('3. å°è¯•é‡æ–°åŠ è½½é¡µé¢', 'info');
          console.error('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);

          // ğŸ”§ æ–°å¢ï¼šæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
          const errorDetails = {
            message: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            windowLodop: typeof window.getLodop,
            lodopManager: typeof LodopPrinterManager,
          };
          console.error('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', errorDetails);
        }
      }

      // ğŸ”„ åˆ·æ–°æ‰“å°æœºåˆ—è¡¨
      async function refreshPrinters() {
        try {
          if (!printerManager) {
            addLog('è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿ', 'warning');
            return;
          }

          addLog('æ­£åœ¨åˆ·æ–°æ‰“å°æœºåˆ—è¡¨...', 'info');

          const printers = await printerManager.refreshPrinters();
          renderPrinterList(printers);
          updateMaintenancePrinterSelect(printers);

          addLog(`å‘ç° ${printers.length} å°æ‰“å°æœº`, 'success');
        } catch (error) {
          addLog(`åˆ·æ–°æ‰“å°æœºå¤±è´¥: ${error.message}`, 'error');
          console.error('åˆ·æ–°æ‰“å°æœºå¤±è´¥:', error);
        }
      }

      // ğŸ–¨ï¸ æ¸²æŸ“æ‰“å°æœºåˆ—è¡¨
      function renderPrinterList(printers) {
        const container = document.getElementById('printer-list');
        container.innerHTML = '';

        if (printers.length === 0) {
          container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>âš ï¸ æ³¨æ„ï¼š</strong> æœªå‘ç°å¯ç”¨æ‰“å°æœºï¼Œè¯·æ£€æŸ¥æ‰“å°æœºè¿æ¥å’Œé©±åŠ¨å®‰è£…ã€‚
                    </div>
                `;
          return;
        }

        printers.forEach((printer, index) => {
          const printerCard = document.createElement('div');
          printerCard.className = 'printer-card';
          printerCard.id = `printer-${index}`;

          const isSelected = selectedPrinters.includes(printer.name);
          if (isSelected) {
            printerCard.classList.add('selected');
          }

          printerCard.innerHTML = `
                    <h4>${printer.name}</h4>
                    <div class="printer-info">
                        <div>ğŸ”¸ å®½åº¦: ${printer.width}mm</div>
                        <div>ğŸ”¸ ç±»å‹: ${
                          printer.isThermal ? 'çƒ­æ•' : 'æ™®é€š'
                        }</div>
                        <div>ğŸ”¸ çŠ¶æ€: ${printer.status}</div>
                        ${
                          printer.isDefault
                            ? '<div>ğŸ”¸ <strong>é»˜è®¤æ‰“å°æœº</strong></div>'
                            : ''
                        }
                    </div>
                    <div class="printer-actions">
                        <button onclick="togglePrinterSelection('${
                          printer.name
                        }')" class="btn ${
            isSelected ? 'btn-clear' : 'btn-setup'
          }">
                            ${isSelected ? 'å–æ¶ˆé€‰æ‹©' : 'é€‰æ‹©æ‰“å°æœº'}
                        </button>
                        <button onclick="testSinglePrinter('${
                          printer.name
                        }')" class="btn btn-test">
                            æµ‹è¯•æ‰“å°
                        </button>
                    </div>
                `;

          printerCard.addEventListener('click', (e) => {
            if (!e.target.classList.contains('btn')) {
              togglePrinterSelection(printer.name);
            }
          });

          container.appendChild(printerCard);
        });
      }

      // âœ… åˆ‡æ¢æ‰“å°æœºé€‰æ‹©çŠ¶æ€
      function togglePrinterSelection(printerName) {
        const index = selectedPrinters.indexOf(printerName);
        if (index > -1) {
          selectedPrinters.splice(index, 1);
          addLog(`å–æ¶ˆé€‰æ‹©æ‰“å°æœº: ${printerName}`, 'info');
        } else {
          selectedPrinters.push(printerName);
          addLog(`é€‰æ‹©æ‰“å°æœº: ${printerName}`, 'info');
        }

        // æ›´æ–°æ‰“å°æœºç®¡ç†å™¨
        if (printerManager) {
          printerManager.setSelectedPrinters(selectedPrinters);
        }

        // æ›´æ–°UI
        const printers = printerManager ? printerManager.getAllPrinters() : [];
        renderPrinterList(printers);
      }

      // ğŸ”§ é€‰æ‹©æ‰€æœ‰æ‰“å°æœº
      function selectAllPrinters() {
        if (!printerManager) {
          addLog('è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿ', 'warning');
          return;
        }

        const printers = printerManager.getAllPrinters();
        selectedPrinters = printers.map((p) => p.name);
        printerManager.setSelectedPrinters(selectedPrinters);

        renderPrinterList(printers);
        addLog(`å·²é€‰æ‹©æ‰€æœ‰ ${printers.length} å°æ‰“å°æœº`, 'success');
      }

      // ğŸ§ª æµ‹è¯•å•ä¸ªæ‰“å°æœº
      async function testSinglePrinter(printerName) {
        try {
          if (!printerManager) {
            addLog('è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿ', 'warning');
            return;
          }

          addLog(`æ­£åœ¨æµ‹è¯•æ‰“å°æœº: ${printerName}...`, 'info');

          const result = await printerManager.testPrint(printerName);
          if (result.success) {
            addLog(`æ‰“å°æœº ${printerName} æµ‹è¯•æˆåŠŸ`, 'success');
          } else {
            throw new Error(result.error || 'æµ‹è¯•å¤±è´¥');
          }
        } catch (error) {
          addLog(`æ‰“å°æœº ${printerName} æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
          console.error('æµ‹è¯•æ‰“å°å¤±è´¥:', error);
        }
      }

      // ğŸ”§ æ›´æ–°ç»´æŠ¤é¢æ¿æ‰“å°æœºé€‰æ‹©
      function updateMaintenancePrinterSelect(printers) {
        const select = document.getElementById('maintenance-printer');
        select.innerHTML = '<option value="">ä½¿ç”¨å½“å‰é€‰ä¸­çš„æ‰“å°æœº</option>';

        printers.forEach((printer) => {
          const option = document.createElement('option');
          option.value = printer.name;
          option.textContent = `${printer.name} (${printer.width}mm)`;
          select.appendChild(option);
        });
      }

      // ğŸ”§ æ‰“å¼€æ‰“å°ç»´æŠ¤ç•Œé¢
      async function openPrintSetup() {
        try {
          if (!printerManager) {
            addLog('è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿ', 'warning');
            return;
          }

          if (selectedPrinters.length === 0) {
            addLog('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€å°æ‰“å°æœº', 'warning');
            return;
          }

          const printerSelect = document.getElementById('maintenance-printer');
          const printerName = printerSelect.value || selectedPrinters[0];

          addLog(`æ­£åœ¨æ‰“å¼€æ‰“å°ç»´æŠ¤ç•Œé¢: ${printerName}...`, 'maintenance');

          const result = await printerManager.showPrintSetup(printerName);

          if (result.success) {
            addLog(
              `æ‰“å°ç»´æŠ¤ç•Œé¢å·²æ‰“å¼€ - æ‰“å°æœº: ${result.printer}, ä»»åŠ¡å: ${result.taskName}`,
              'maintenance'
            );
            addLog('è¯·åœ¨ç»´æŠ¤ç•Œé¢ä¸­è°ƒæ•´ä½ç½®åç‚¹å‡»ã€åº”ç”¨ã€‘ä¿å­˜é…ç½®', 'info');
          } else {
            throw new Error(result.error || 'æ‰“å¼€ç»´æŠ¤ç•Œé¢å¤±è´¥');
          }
        } catch (error) {
          addLog(`æ‰“å¼€æ‰“å°ç»´æŠ¤ç•Œé¢å¤±è´¥: ${error.message}`, 'error');
          console.error('æ‰“å¼€æ‰“å°ç»´æŠ¤ç•Œé¢å¤±è´¥:', error);
        }
      }

      // ğŸ”§ è‡ªå®šä¹‰ä»»åŠ¡ç»´æŠ¤
      async function createCustomSetup() {
        try {
          if (!printerManager) {
            addLog('è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿ', 'warning');
            return;
          }

          const printerSelect = document.getElementById('maintenance-printer');
          const taskNameInput = document.getElementById(
            'maintenance-task-name'
          );

          const printerName = printerSelect.value || selectedPrinters[0];
          const customTaskName = taskNameInput.value.trim();

          if (!customTaskName) {
            addLog('è¯·è¾“å…¥è‡ªå®šä¹‰ä»»åŠ¡åç§°', 'warning');
            return;
          }

          addLog(
            `æ­£åœ¨åˆ›å»ºè‡ªå®šä¹‰ä»»åŠ¡ç»´æŠ¤: ${customTaskName} (${printerName})...`,
            'maintenance'
          );

          const result = await printerManager.showPrintSetupWithTaskName(
            printerName,
            customTaskName
          );

          if (result.success) {
            addLog(
              `è‡ªå®šä¹‰ç»´æŠ¤ç•Œé¢å·²æ‰“å¼€ - ä»»åŠ¡å: ${result.taskName}`,
              'maintenance'
            );
          } else {
            throw new Error(result.error || 'åˆ›å»ºè‡ªå®šä¹‰ç»´æŠ¤å¤±è´¥');
          }
        } catch (error) {
          addLog(`åˆ›å»ºè‡ªå®šä¹‰ç»´æŠ¤å¤±è´¥: ${error.message}`, 'error');
          console.error('åˆ›å»ºè‡ªå®šä¹‰ç»´æŠ¤å¤±è´¥:', error);
        }
      }

      // ğŸ§¹ æ¸…é™¤æŒ‡å®šé…ç½®
      async function clearSpecificConfig() {
        try {
          if (!printerManager) {
            addLog('è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿ', 'warning');
            return;
          }

          const taskNameInput = document.getElementById(
            'maintenance-task-name'
          );
          const taskName = taskNameInput.value.trim();

          const confirmMessage = taskName
            ? `ç¡®å®šè¦æ¸…é™¤ä»»åŠ¡ "${taskName}" çš„æ‰“å°é…ç½®å—ï¼Ÿ`
            : 'ç¡®å®šè¦æ¸…é™¤é»˜è®¤æ‰“å°é…ç½®å—ï¼Ÿ';

          if (!confirm(confirmMessage)) {
            return;
          }

          addLog(`æ­£åœ¨æ¸…é™¤é…ç½®: ${taskName || 'é»˜è®¤'}...`, 'maintenance');

          const result = await printerManager.clearLocalPrintConfig(taskName);

          if (result.success) {
            addLog(`é…ç½®æ¸…é™¤æˆåŠŸ - ä»»åŠ¡å: ${result.taskName}`, 'maintenance');
            addLog('ä¸‹æ¬¡æ‰“å°å°†ä½¿ç”¨é»˜è®¤è®¾ç½®', 'info');
          } else {
            throw new Error(result.error || 'æ¸…é™¤é…ç½®å¤±è´¥');
          }
        } catch (error) {
          addLog(`æ¸…é™¤é…ç½®å¤±è´¥: ${error.message}`, 'error');
          console.error('æ¸…é™¤é…ç½®å¤±è´¥:', error);
        }
      }

      // ğŸ“Š åˆ·æ–°ç»´æŠ¤çŠ¶æ€
      async function refreshMaintenanceStatus() {
        try {
          if (!printerManager) {
            addLog('è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿ', 'warning');
            return;
          }

          addLog('æ­£åœ¨åˆ·æ–°ç»´æŠ¤çŠ¶æ€...', 'info');

          const status = printerManager.getPrintMaintenanceStatus();
          renderMaintenanceStatus(status);

          addLog('ç»´æŠ¤çŠ¶æ€å·²åˆ·æ–°', 'success');
        } catch (error) {
          addLog(`åˆ·æ–°ç»´æŠ¤çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
          console.error('åˆ·æ–°ç»´æŠ¤çŠ¶æ€å¤±è´¥:', error);
        }
      }

      // ğŸ¨ æ¸²æŸ“ç»´æŠ¤çŠ¶æ€
      function renderMaintenanceStatus(status) {
        const container = document.getElementById('maintenance-status-content');

        const statusHTML = `
                <div class="status-grid">
                    <div class="status-item">
                        <strong>LODOP çŠ¶æ€</strong>
                        ${status.lodopAvailable ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}
                    </div>
                    <div class="status-item">
                        <strong>å·²é€‰æ‹©æ‰“å°æœº</strong>
                        ${status.selectedPrinters.length} å°
                    </div>
                    <div class="status-item">
                        <strong>æ€»æ‰“å°æœºæ•°</strong>
                        ${status.availablePrinters.length} å°
                    </div>
                    <div class="status-item">
                        <strong>ç»´æŠ¤æ”¯æŒ</strong>
                        ${status.supportsPrintSetup ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>ğŸ“‹ å¯ç”¨æ‰“å°æœºåˆ—è¡¨ï¼š</strong>
                    <ul>
                        ${status.availablePrinters
                          .map(
                            (p) =>
                              `<li>${p.name} (${p.width}mm, ${
                                p.isThermal ? 'çƒ­æ•' : 'æ™®é€š'
                              }${p.isDefault ? ', é»˜è®¤' : ''})</li>`
                          )
                          .join('')}
                    </ul>
                </div>

                <div class="alert alert-success">
                    <strong>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong>
                    <ul>
                        ${status.tips.map((tip) => `<li>${tip}</li>`).join('')}
                    </ul>
                </div>
            `;

        container.innerHTML = statusHTML;
      }

      // ğŸ§ª æµ‹è¯•è®¢å•æ‰“å°
      async function testOrderPrint() {
        try {
          if (!printerManager) {
            addLog('è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿ', 'warning');
            return;
          }

          if (selectedPrinters.length === 0) {
            addLog('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€å°æ‰“å°æœº', 'warning');
            return;
          }

          addLog(`æ­£åœ¨æ‰“å°æµ‹è¯•è®¢å•: ${testOrder.order_id}...`, 'info');
          showTestOrderInfo();

          const result = await printerManager.printOrder(testOrder);

          addLog(
            `æµ‹è¯•è®¢å•æ‰“å°å®Œæˆ - æˆåŠŸ: ${result.æˆåŠŸæ•°é‡}, å¤±è´¥: ${result.å¤±è´¥æ•°é‡}`,
            result.å¤±è´¥æ•°é‡ > 0 ? 'warning' : 'success'
          );

          if (result.é”™è¯¯åˆ—è¡¨.length > 0) {
            result.é”™è¯¯åˆ—è¡¨.forEach((error) => {
              addLog(`æ‰“å°é”™è¯¯: ${error}`, 'error');
            });
          }
        } catch (error) {
          addLog(`æµ‹è¯•è®¢å•æ‰“å°å¤±è´¥: ${error.message}`, 'error');
          console.error('æµ‹è¯•è®¢å•æ‰“å°å¤±è´¥:', error);
        }
      }

      // ğŸ‘ï¸ é¢„è§ˆè®¢å•æ‰“å°
      async function previewOrderPrint() {
        try {
          if (!printerManager) {
            addLog('è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿ', 'warning');
            return;
          }

          if (selectedPrinters.length === 0) {
            addLog('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€å°æ‰“å°æœº', 'warning');
            return;
          }

          addLog('æ­£åœ¨ç”Ÿæˆè®¢å•é¢„è§ˆ...', 'info');
          showTestOrderInfo();

          const result = await printerManager.generatePrintPreview(testOrder);

          if (result.success) {
            addLog('è®¢å•é¢„è§ˆå·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹é¢„è§ˆçª—å£', 'success');
          } else {
            throw new Error(result.error || 'é¢„è§ˆç”Ÿæˆå¤±è´¥');
          }
        } catch (error) {
          addLog(`è®¢å•é¢„è§ˆå¤±è´¥: ${error.message}`, 'error');
          console.error('è®¢å•é¢„è§ˆå¤±è´¥:', error);
        }
      }

      // ğŸ§ª ç®€å•æµ‹è¯•æ‰“å°
      async function testSimplePrint() {
        try {
          if (!printerManager) {
            addLog('è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿ', 'warning');
            return;
          }

          if (selectedPrinters.length === 0) {
            addLog('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€å°æ‰“å°æœº', 'warning');
            return;
          }

          addLog('æ­£åœ¨æ‰§è¡Œç®€å•æµ‹è¯•æ‰“å°...', 'info');

          let successCount = 0;
          let errorCount = 0;

          for (const printerName of selectedPrinters) {
            try {
              const result = await printerManager.testPrint(printerName);
              if (result.success) {
                successCount++;
                addLog(`ç®€å•æµ‹è¯•æ‰“å°æˆåŠŸ: ${printerName}`, 'success');
              } else {
                errorCount++;
                addLog(`ç®€å•æµ‹è¯•æ‰“å°å¤±è´¥: ${printerName}`, 'error');
              }
            } catch (error) {
              errorCount++;
              addLog(
                `ç®€å•æµ‹è¯•æ‰“å°å¼‚å¸¸ ${printerName}: ${error.message}`,
                'error'
              );
            }
          }

          addLog(
            `ç®€å•æµ‹è¯•æ‰“å°å®Œæˆ - æˆåŠŸ: ${successCount}, å¤±è´¥: ${errorCount}`,
            errorCount > 0 ? 'warning' : 'success'
          );
        } catch (error) {
          addLog(`ç®€å•æµ‹è¯•æ‰“å°å¤±è´¥: ${error.message}`, 'error');
          console.error('ç®€å•æµ‹è¯•æ‰“å°å¤±è´¥:', error);
        }
      }

      // ğŸ“„ æ˜¾ç¤ºæµ‹è¯•è®¢å•ä¿¡æ¯
      function showTestOrderInfo() {
        const infoPanel = document.getElementById('test-order-info');
        const detailsDiv = document.getElementById('test-order-details');

        const orderInfo = `
                <div><strong>è®¢å•å·ï¼š</strong>${testOrder.order_id}</div>
                <div><strong>å®¢æˆ·ï¼š</strong>${testOrder.recipient_name} (${
          testOrder.recipient_phone
        })</div>
                <div><strong>ç±»å‹ï¼š</strong>${
                  testOrder.delivery_type == 1 ? 'å¤–é€' : 'è‡ªå–'
                }</div>
                <div><strong>èœå“æ•°ï¼š</strong>${
                  testOrder.dishes_array.length
                } ä¸ª</div>
                <div><strong>æ€»é‡‘é¢ï¼š</strong>$${testOrder.total}</div>
                <div><strong>å¤‡æ³¨ï¼š</strong>${
                  testOrder.order_notes || 'æ— '
                }</div>
            `;

        detailsDiv.innerHTML = orderInfo;
        infoPanel.classList.remove('hidden');

        // 3ç§’åéšè—
        setTimeout(() => {
          infoPanel.classList.add('hidden');
        }, 3000);
      }

      // ğŸš€ é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆå§‹åŒ–
      window.addEventListener('load', () => {
        addLog('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·ç‚¹å‡»"åˆå§‹åŒ–ç³»ç»Ÿ"å¼€å§‹ä½¿ç”¨', 'info');

        // è‡ªåŠ¨åˆå§‹åŒ–ï¼ˆå¯é€‰ï¼‰
        setTimeout(() => {
          initSystem();
        }, 1000);
      });

      // ğŸ“± å“åº”å¼å¤„ç†
      window.addEventListener('resize', () => {
        // è¿™é‡Œå¯ä»¥æ·»åŠ å“åº”å¼è°ƒæ•´é€»è¾‘
      });

      // ğŸ” æ£€æŸ¥C-LodopçŠ¶æ€ï¼ˆæ‰‹åŠ¨è¯Šæ–­ï¼‰
      function manualCheckCLodopStatus() {
        addLog('=== C-Lodop çŠ¶æ€æ£€æŸ¥ ===', 'info');

        try {
          // æ£€æŸ¥å‡½æ•°å¯ç”¨æ€§
          if (typeof window.checkCLodopStatus !== 'function') {
            addLog('âŒ checkCLodopStatuså‡½æ•°ä¸å¯ç”¨', 'error');
            addLog('è¯·æ£€æŸ¥LodopFuncs.jsæ˜¯å¦æ­£ç¡®åŠ è½½', 'error');
            return;
          }

          if (typeof window.getLodop !== 'function') {
            addLog('âŒ getLodopå‡½æ•°ä¸å¯ç”¨', 'error');
            addLog('è¯·æ£€æŸ¥LodopFuncs.jsæ˜¯å¦æ­£ç¡®åŠ è½½', 'error');
            return;
          }

          // è·å–çŠ¶æ€
          const status = window.checkCLodopStatus();
          addLog(`ğŸ“Š C-LodopçŠ¶æ€æ£€æŸ¥ç»“æœ:`, 'info');
          addLog(
            `- å¯ç”¨æ€§: ${status.available ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`,
            status.available ? 'success' : 'error'
          );
          addLog(`- ç‰ˆæœ¬: ${status.version || 'æœªçŸ¥'}`, 'info');
          addLog(`- æœ¬åœ°æœåŠ¡: ${status.isLocal ? 'âœ… æ˜¯' : 'âŒ å¦'}`, 'info');
          addLog(`- æ‰“å°æœºæ•°é‡: ${status.printerCount || 0}`, 'info');

          if (status.error) {
            addLog(`- é”™è¯¯ä¿¡æ¯: ${status.error}`, 'error');
          }

          // å¦‚æœä¸å¯ç”¨ï¼Œæä¾›è§£å†³å»ºè®®
          if (!status.available) {
            addLog('ğŸ”§ è§£å†³å»ºè®®:', 'warning');
            addLog('1. ç¡®è®¤å·²å®‰è£…C-Lodopè½¯ä»¶', 'info');
            addLog('2. æ£€æŸ¥C-LodopæœåŠ¡æ˜¯å¦å¯åŠ¨ï¼ˆé€šå¸¸åœ¨ç³»ç»Ÿæ‰˜ç›˜ä¸­ï¼‰', 'info');
            addLog('3. å°è¯•é‡å¯C-LodopæœåŠ¡', 'info');
            addLog('4. æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦é˜»æ­¢localhostè¿æ¥', 'info');
            addLog('5. å¦‚æœé—®é¢˜æŒç»­ï¼Œå°è¯•é‡æ–°å®‰è£…C-Lodop', 'info');
          } else {
            addLog('âœ… C-LodopçŠ¶æ€æ­£å¸¸ï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨', 'success');
          }
        } catch (error) {
          addLog(`âŒ çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
          console.error('C-LodopçŠ¶æ€æ£€æŸ¥å¼‚å¸¸:', error);
        }
      }
    </script>
  </body>
</html>
