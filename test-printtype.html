<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PrintType åˆ†èœæ‰“å°æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1,
      h2 {
        color: #333;
        margin-bottom: 20px;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #fafafa;
      }

      .config-row {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        gap: 10px;
      }

      .config-row label {
        min-width: 120px;
        font-weight: bold;
      }

      input,
      select,
      button {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        margin-left: 10px;
      }

      button:hover {
        background: #0056b3;
      }

      button.danger {
        background: #dc3545;
      }

      button.danger:hover {
        background: #c82333;
      }

      button.success {
        background: #28a745;
      }

      button.success:hover {
        background: #218838;
      }

      .status {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        white-space: pre-wrap;
      }

      .status.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .status.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .status.info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      .dish-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding: 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .dish-item input {
        margin-left: 10px;
        width: 60px;
      }

      .printer-config {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding: 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .printer-config input {
        margin-left: 10px;
        width: 80px;
      }

      .highlight {
        background: #fff3cd !important;
        border-color: #ffeaa7 !important;
      }

      .test-order {
        background: #e9ecef;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }

      .test-order h4 {
        margin: 0 0 10px 0;
        color: #495057;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ½ï¸ PrintType åˆ†èœæ‰“å°æµ‹è¯•</h1>

      <div class="section">
        <h2>ğŸ“‹ åŠŸèƒ½è¯´æ˜</h2>
        <p><strong>åˆ†èœæ‰“å°åŸç†ï¼š</strong></p>
        <ul>
          <li>
            æ¯ä¸ªèœå“å¯ä»¥è®¾ç½®
            <code>printType</code> å­—æ®µï¼ˆæ•°å­—ï¼Œå¤§äº0è¡¨ç¤ºè¦åˆ†èœï¼‰
          </li>
          <li>æ¯å°æ‰“å°æœºå¯ä»¥è®¾ç½®ç¼–å·ï¼ˆå¯¹åº” printType å€¼ï¼‰</li>
          <li>æ‰“å°æ—¶ï¼Œèœå“æ ¹æ® printType åˆ†é…åˆ°å¯¹åº”ç¼–å·çš„æ‰“å°æœº</li>
          <li>æ²¡æœ‰ç¼–å·çš„æ‰“å°æœºæ‰“å°å®Œæ•´è®¢å•</li>
          <li>æ²¡æœ‰ printType æˆ– printType=0 çš„èœå“å½’å…¥å®Œæ•´è®¢å•</li>
        </ul>
      </div>

      <div class="section">
        <h2>ğŸ–¨ï¸ æ‰“å°æœºç®¡ç†</h2>
        <div class="config-row">
          <button onclick="initPrinter()">åˆå§‹åŒ–æ‰“å°æœº</button>
          <button onclick="refreshPrinters()">åˆ·æ–°æ‰“å°æœºåˆ—è¡¨</button>
          <button onclick="showPrinterStatus()">æŸ¥çœ‹çŠ¶æ€</button>
        </div>
        <div id="printerList"></div>
      </div>

      <div class="section">
        <h2>ğŸ”§ åˆ†èœæ‰“å°é…ç½®</h2>
        <div class="config-row">
          <label>åˆ†èœæ¨¡å¼:</label>
          <select
            id="separateMode"
            title="é€‰æ‹©åˆ†èœæ‰“å°æ¨¡å¼"
            onchange="updateSeparateMode()"
          >
            <option value="false">ç¦ç”¨</option>
            <option value="true">å¯ç”¨</option>
          </select>
          <button onclick="showConfig()">æŸ¥çœ‹é…ç½®</button>
          <button class="danger" onclick="resetConfig()">é‡ç½®é…ç½®</button>
        </div>
        <div id="printerConfig"></div>
      </div>

      <div class="section">
        <h2>ğŸœ æµ‹è¯•è®¢å•</h2>
        <div class="test-order">
          <h4>è®¢å• #12345</h4>
          <div id="dishList"></div>
          <div class="config-row" style="margin-top: 15px">
            <button class="success" onclick="testPrint()">æµ‹è¯•åˆ†èœæ‰“å°</button>
            <button onclick="testPreview()">é¢„è§ˆæ‰“å°</button>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>ğŸ“Š æ‰“å°ç»“æœ</h2>
        <div id="printResult" class="status info">ç­‰å¾…æ‰“å°æµ‹è¯•...</div>
      </div>
    </div>

    <!-- å¼•å…¥ C-Lodop è„šæœ¬ -->
    <script language="javascript" src="./CLodopfuncs.js"></script>
    <script language="javascript" src="./src/printer-lodop.js"></script>

    <script>
      let printerManager = null;

      // æµ‹è¯•è®¢å•æ•°æ®
      const testOrder = {
        order_id: '12345',
        create_time: new Date().toISOString(),
        delivery_time: new Date(Date.now() + 30 * 60 * 1000).toISOString(),
        paystyle: 1,
        recipient_name: 'å¼ ä¸‰',
        recipient_phone: '13800138000',
        delivery_type: 2,
        sub_total: 45.5,
        tax_fee: 3.64,
        tip_fee: 5.0,
        total: 54.14,
        order_notes: 'ä¸è¦é¦™èœï¼Œå¤šæ”¾è¾£æ¤’',
        dishes_array: [
          {
            dishes_name: 'å®«ä¿é¸¡ä¸',
            price: '18.50',
            amount: '1',
            remark: 'å¾®è¾£ï¼Œä¸è¦èŠ±ç”Ÿ',
            printType: '1', // çƒ­èœï¼Œåˆ†é…ç»™1å·æ‰“å°æœº
          },
          {
            dishes_name: 'éº»å©†è±†è…',
            price: '16.00',
            amount: '1',
            remark: 'ä¸­è¾£',
            printType: '1', // çƒ­èœï¼Œåˆ†é…ç»™1å·æ‰“å°æœº
          },
          {
            dishes_name: 'å‡‰æ‹Œé»„ç“œ',
            price: '8.00',
            amount: '1',
            remark: 'å¤šæ”¾è’œ',
            printType: '2', // å‡‰èœï¼Œåˆ†é…ç»™2å·æ‰“å°æœº
          },
          {
            dishes_name: 'é“¶è€³è²å­æ±¤',
            price: '12.00',
            amount: '2',
            remark: 'æ¸©çƒ­',
            printType: '3', // æ±¤å“ï¼Œåˆ†é…ç»™3å·æ‰“å°æœº
          },
          {
            dishes_name: 'ç±³é¥­',
            price: '3.00',
            amount: '2',
            remark: '',
            printType: '0', // ä¸»é£Ÿï¼Œä¸åˆ†èœï¼Œå®Œæ•´è®¢å•
          },
        ],
      };

      // åˆå§‹åŒ–æ‰“å°æœº
      async function initPrinter() {
        try {
          updateStatus('æ­£åœ¨åˆå§‹åŒ–æ‰“å°æœº...', 'info');

          printerManager = new LodopPrinterManager();
          const result = await printerManager.init();

          if (result.success) {
            updateStatus(`æ‰“å°æœºåˆå§‹åŒ–æˆåŠŸï¼å¼•æ“: ${result.engine}`, 'success');
            await refreshPrinters();
            renderDishList();
          } else {
            updateStatus(`æ‰“å°æœºåˆå§‹åŒ–å¤±è´¥: ${result.error}`, 'error');
          }
        } catch (error) {
          updateStatus(`åˆå§‹åŒ–å¼‚å¸¸: ${error.message}`, 'error');
        }
      }

      // åˆ·æ–°æ‰“å°æœºåˆ—è¡¨
      async function refreshPrinters() {
        if (!printerManager) {
          updateStatus('è¯·å…ˆåˆå§‹åŒ–æ‰“å°æœº', 'error');
          return;
        }

        try {
          const printers = await printerManager.refreshPrinters();
          renderPrinterList(printers);
          renderPrinterConfig(printers);
          updateStatus(`å‘ç° ${printers.length} å°æ‰“å°æœº`, 'success');
        } catch (error) {
          updateStatus(`åˆ·æ–°æ‰“å°æœºå¤±è´¥: ${error.message}`, 'error');
        }
      }

      // æ¸²æŸ“æ‰“å°æœºåˆ—è¡¨
      function renderPrinterList(printers) {
        const container = document.getElementById('printerList');
        container.innerHTML = '';

        printers.forEach((printer, index) => {
          const div = document.createElement('div');
          div.className = 'printer-config';
          div.innerHTML = `
                    <input type="checkbox" id="printer_${index}" ${
            printer.isDefault ? 'checked' : ''
          }
                           onchange="togglePrinter('${
                             printer.name
                           }', this.checked)">
                    <label for="printer_${index}">${printer.name}</label>
                    <span style="margin-left: 10px; color: #666;">
                        (${printer.width}mm, ${printer.engine})
                    </span>
                `;
          container.appendChild(div);
        });

        // é»˜è®¤é€‰æ‹©ç¬¬ä¸€å°æ‰“å°æœº
        if (printers.length > 0) {
          printerManager.setSelectedPrinters([printers[0].name]);
        }
      }

      // æ¸²æŸ“æ‰“å°æœºç¼–å·é…ç½®
      function renderPrinterConfig(printers) {
        const container = document.getElementById('printerConfig');
        container.innerHTML = '<h4>æ‰“å°æœºç¼–å·è®¾ç½®:</h4>';

        printers.forEach((printer, index) => {
          const div = document.createElement('div');
          div.className = 'printer-config';
          div.innerHTML = `
                    <label>${printer.name}:</label>
                    <input type="number" id="number_${index}" min="0" max="99"
                           placeholder="ç¼–å·" value="${
                             printer.printerNumber || ''
                           }"
                           onchange="setPrinterNumber('${
                             printer.name
                           }', this.value)">
                    <span style="margin-left: 10px; color: #666; font-size: 12px;">
                        (0=ä¸åˆ†èœï¼Œ1-99=printTypeç¼–å·)
                    </span>
                `;
          container.appendChild(div);
        });
      }

      // æ¸²æŸ“èœå“åˆ—è¡¨
      function renderDishList() {
        const container = document.getElementById('dishList');
        container.innerHTML = '';

        testOrder.dishes_array.forEach((dish, index) => {
          const div = document.createElement('div');
          div.className = 'dish-item';
          div.innerHTML = `
                    <span style="flex: 1;">${dish.dishes_name} - $${
            dish.price
          }</span>
                    <label>printType:</label>
                    <input type="number" min="0" max="99" value="${
                      dish.printType
                    }"
                           onchange="updateDishPrintType(${index}, this.value)">
                    <span style="margin-left: 10px; color: #666; font-size: 12px;">
                        ${getPrintTypeDescription(dish.printType)}
                    </span>
                `;
          container.appendChild(div);
        });
      }

      // è·å– printType æè¿°
      function getPrintTypeDescription(printType) {
        const type = parseInt(printType);
        if (type === 0) return '(å®Œæ•´è®¢å•)';
        if (type === 1) return '(çƒ­èœ)';
        if (type === 2) return '(å‡‰èœ)';
        if (type === 3) return '(æ±¤å“)';
        return `(ç±»å‹${type})`;
      }

      // åˆ‡æ¢æ‰“å°æœºé€‰æ‹©
      function togglePrinter(printerName, selected) {
        if (!printerManager) return;

        const currentSelected = printerManager.getSelectedPrinters();
        let newSelected;

        if (selected) {
          newSelected = [...currentSelected, printerName];
        } else {
          newSelected = currentSelected.filter((name) => name !== printerName);
        }

        printerManager.setSelectedPrinters(newSelected);
        updateStatus(`å·²é€‰æ‹©æ‰“å°æœº: ${newSelected.join(', ')}`, 'info');
      }

      // è®¾ç½®æ‰“å°æœºç¼–å·
      function setPrinterNumber(printerName, number) {
        if (!printerManager) return;

        const num = parseInt(number) || null;
        if (printerManager.setPrinterNumber(printerName, num)) {
          updateStatus(
            `è®¾ç½®æ‰“å°æœºç¼–å·æˆåŠŸ: ${printerName} -> ${num || 'æ— ç¼–å·'}`,
            'success'
          );
        } else {
          updateStatus(`è®¾ç½®æ‰“å°æœºç¼–å·å¤±è´¥: ${printerName}`, 'error');
        }
      }

      // æ›´æ–°èœå“ printType
      function updateDishPrintType(index, printType) {
        testOrder.dishes_array[index].printType = printType;
        renderDishList(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æè¿°
        updateStatus(
          `æ›´æ–°èœå“ printType: ${testOrder.dishes_array[index].dishes_name} -> ${printType}`,
          'info'
        );
      }

      // æ›´æ–°åˆ†èœæ¨¡å¼
      function updateSeparateMode() {
        if (!printerManager) return;

        const enabled =
          document.getElementById('separateMode').value === 'true';
        printerManager.setSeparatePrintingMode(enabled);
        updateStatus(`åˆ†èœæ‰“å°æ¨¡å¼: ${enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`, 'info');
      }

      // æ˜¾ç¤ºé…ç½®
      function showConfig() {
        if (!printerManager) {
          updateStatus('è¯·å…ˆåˆå§‹åŒ–æ‰“å°æœº', 'error');
          return;
        }

        const config = printerManager.getPrintTypeConfig();
        const configText = `å½“å‰é…ç½®:
åˆ†èœæ¨¡å¼: ${config.enableSeparatePrinting ? 'å¯ç”¨' : 'ç¦ç”¨'}
æ‰“å°æœºç¼–å·: ${JSON.stringify(config.printerNumbers, null, 2)}
å¯ç”¨æ‰“å°æœº: ${config.availablePrinters
          .map((p) => `${p.name}(ç¼–å·:${p.number || 'æ— '})`)
          .join(', ')}`;

        updateStatus(configText, 'info');
      }

      // é‡ç½®é…ç½®
      function resetConfig() {
        if (!printerManager) return;

        printerManager.resetPrintTypeConfig();
        document.getElementById('separateMode').value = 'false';

        // é‡ç½®ç•Œé¢
        const inputs = document.querySelectorAll(
          '#printerConfig input[type="number"]'
        );
        inputs.forEach((input) => (input.value = ''));

        updateStatus('åˆ†èœæ‰“å°é…ç½®å·²é‡ç½®', 'success');
      }

      // æ˜¾ç¤ºæ‰“å°æœºçŠ¶æ€
      function showPrinterStatus() {
        if (!printerManager) {
          updateStatus('è¯·å…ˆåˆå§‹åŒ–æ‰“å°æœº', 'error');
          return;
        }

        const status = printerManager.getEngineStatus();
        const debugInfo = printerManager.getDebugInfo();

        const statusText = `æ‰“å°æœºçŠ¶æ€:
å¼•æ“: ${status.currentEngine}
C-Lodopå¯ç”¨: ${status.lodopAvailable}
åˆå§‹åŒ–çŠ¶æ€: ${status.isInitialized}
ç‰ˆæœ¬: ${status.version}
æ‰“å°æœºæ•°é‡: ${status.printerCount}
å·²é€‰æ‹©æ•°é‡: ${status.selectedCount}

è°ƒè¯•ä¿¡æ¯:
${JSON.stringify(debugInfo, null, 2)}`;

        updateStatus(statusText, 'info');
      }

      // æµ‹è¯•æ‰“å°
      async function testPrint() {
        if (!printerManager) {
          updateStatus('è¯·å…ˆåˆå§‹åŒ–æ‰“å°æœº', 'error');
          return;
        }

        try {
          updateStatus('æ­£åœ¨æ‰§è¡Œåˆ†èœæ‰“å°æµ‹è¯•...', 'info');

          const result = await printerManager.printOrder(testOrder);

          const resultText = `åˆ†èœæ‰“å°æµ‹è¯•å®Œæˆ:
æˆåŠŸæ•°é‡: ${result.æˆåŠŸæ•°é‡}
å¤±è´¥æ•°é‡: ${result.å¤±è´¥æ•°é‡}
æ‰“å°å¼•æ“: ${result.æ‰“å°å¼•æ“}
åˆ†èœæ¨¡å¼: ${result.åˆ†èœæ¨¡å¼}

æ‰“å°è¯¦æƒ…:
${result.æ‰“å°è¯¦æƒ…
  .map(
    (detail) =>
      `- ${detail.printer}: ${detail.success ? 'æˆåŠŸ' : 'å¤±è´¥'} (${
        detail.type
      }, ${detail.dishCount}ä¸ªèœå“${
        detail.printType ? ', printType:' + detail.printType : ''
      })`
  )
  .join('\n')}

${
  result.é”™è¯¯åˆ—è¡¨.length > 0 ? '\né”™è¯¯åˆ—è¡¨:\n' + result.é”™è¯¯åˆ—è¡¨.join('\n') : ''
}`;

          updateStatus(resultText, result.å¤±è´¥æ•°é‡ > 0 ? 'error' : 'success');
        } catch (error) {
          updateStatus(`æ‰“å°æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
        }
      }

      // é¢„è§ˆæ‰“å°
      async function testPreview() {
        if (!printerManager) {
          updateStatus('è¯·å…ˆåˆå§‹åŒ–æ‰“å°æœº', 'error');
          return;
        }

        try {
          updateStatus('æ­£åœ¨ç”Ÿæˆæ‰“å°é¢„è§ˆ...', 'info');

          const result = await printerManager.generatePrintPreview(testOrder);

          if (result.success) {
            updateStatus('æ‰“å°é¢„è§ˆå·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹é¢„è§ˆçª—å£', 'success');
          } else {
            updateStatus('é¢„è§ˆç”Ÿæˆå¤±è´¥', 'error');
          }
        } catch (error) {
          updateStatus(`é¢„è§ˆå¼‚å¸¸: ${error.message}`, 'error');
        }
      }

      // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
      function updateStatus(message, type = 'info') {
        const statusDiv = document.getElementById('printResult');
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
        console.log(`[STATUS-${type.toUpperCase()}] ${message}`);
      }

      // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆå§‹åŒ–
      window.addEventListener('load', () => {
        updateStatus('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·ç‚¹å‡»"åˆå§‹åŒ–æ‰“å°æœº"å¼€å§‹æµ‹è¯•', 'info');
      });
    </script>
  </body>
</html>
