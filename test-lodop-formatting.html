<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>C-Lodop å®½åº¦ä¿®å¤æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .section {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .section h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .preview-area {
        background: #f8f9fa;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
        white-space: pre-wrap;
        max-height: 500px;
        overflow-y: auto;
      }
      .width-test {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .char-ruler {
        font-family: 'Courier New', monospace;
        font-size: 10px;
        background: #e9ecef;
        padding: 5px;
        border: 1px solid #ced4da;
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”§ C-Lodop æ‰“å°å®½åº¦ä¿®å¤æµ‹è¯•</h1>

      <!-- å¼•æ“çŠ¶æ€æ£€æŸ¥ -->
      <div class="section">
        <h3>ğŸ“Š å¼•æ“çŠ¶æ€æ£€æŸ¥</h3>
        <button onclick="checkEngineStatus()">æ£€æŸ¥å¼•æ“çŠ¶æ€</button>
        <div id="engineStatus" class="status info">ç­‰å¾…æ£€æŸ¥...</div>
      </div>

      <!-- å®½åº¦æµ‹è¯•åŒºåŸŸ -->
      <div class="section">
        <h3>ğŸ“ å®½åº¦ä¿®å¤éªŒè¯</h3>
        <div class="width-test">
          <h4>ğŸ¯ 80mmæ‰“å°æœºå­—ç¬¦å®½åº¦æµ‹è¯•</h4>
          <div class="char-ruler">
            <div>42å­—ç¬¦æ ‡å°ºï¼ˆä¿®å¤åç›®æ ‡å®½åº¦ï¼‰:</div>
            <div>123456789012345678901234567890123456789012</div>
            <div>1 2 3 4</div>
          </div>
          <div class="char-ruler">
            <div>32å­—ç¬¦æ ‡å°ºï¼ˆä¿®å¤å‰å®½åº¦ï¼‰:</div>
            <div>12345678901234567890123456789012</div>
            <div>1 2 3</div>
          </div>
        </div>
        <button onclick="testWidthFix()">æµ‹è¯•å®½åº¦ä¿®å¤æ•ˆæœ</button>
        <div id="widthTestResult" class="status info">ç­‰å¾…æµ‹è¯•...</div>
      </div>

      <!-- æ‰“å°æœºåˆ—è¡¨ -->
      <div class="section">
        <h3>ğŸ–¨ï¸ æ‰“å°æœºç®¡ç†</h3>
        <button onclick="refreshPrinters()">åˆ·æ–°æ‰“å°æœºåˆ—è¡¨</button>
        <div id="printerList" class="status info">ç­‰å¾…åˆ·æ–°...</div>
      </div>

      <!-- æ’ç‰ˆé¢„è§ˆ -->
      <div class="section">
        <h3>ğŸ‘ï¸ æ’ç‰ˆé¢„è§ˆï¼ˆä¿®å¤åï¼‰</h3>
        <button onclick="generatePreview()">ç”Ÿæˆæ’ç‰ˆé¢„è§ˆ</button>
        <button onclick="showPrintPreview()">æ˜¾ç¤ºC-Lodopé¢„è§ˆ</button>
        <div id="previewContent" class="preview-area">ç­‰å¾…ç”Ÿæˆé¢„è§ˆ...</div>
      </div>

      <!-- æµ‹è¯•æ‰“å° -->
      <div class="section">
        <h3>ğŸ–¨ï¸ æµ‹è¯•æ‰“å°</h3>
        <button onclick="testPrintWidth()">æµ‹è¯•å®½åº¦ä¿®å¤æ‰“å°</button>
        <button onclick="printSampleOrder()">æ‰“å°æ ·æœ¬è®¢å•</button>
        <div id="printResult" class="status info">ç­‰å¾…æ‰“å°...</div>
      </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="LodopFuncs.js"></script>
    <script src="../src/printer-lodop.js"></script>

    <script>
      let printerManager = null;

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.onload = async function () {
        try {
          console.log('ğŸ”§ åˆå§‹åŒ–å®½åº¦ä¿®å¤æµ‹è¯•é¡µé¢...');

          // ç­‰å¾…C-LodopåŠ è½½
          await new Promise((resolve) => setTimeout(resolve, 1000));

          if (typeof LodopPrinterManager !== 'undefined') {
            printerManager = new LodopPrinterManager();
            const result = await printerManager.init();

            if (result.success) {
              document.getElementById(
                'engineStatus'
              ).innerHTML = `âœ… C-Lodopå¼•æ“åˆå§‹åŒ–æˆåŠŸ<br>ç‰ˆæœ¬: ${printerManager.LODOP.VERSION}`;
              document.getElementById('engineStatus').className =
                'status success';

              // è‡ªåŠ¨åˆ·æ–°æ‰“å°æœºåˆ—è¡¨
              await refreshPrinters();
            } else {
              throw new Error(result.error);
            }
          } else {
            throw new Error('LodopPrinterManager ç±»æœªæ‰¾åˆ°');
          }
        } catch (error) {
          console.error('åˆå§‹åŒ–å¤±è´¥:', error);
          document.getElementById(
            'engineStatus'
          ).innerHTML = `âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`;
          document.getElementById('engineStatus').className = 'status error';
        }
      };

      // æ£€æŸ¥å¼•æ“çŠ¶æ€
      async function checkEngineStatus() {
        try {
          if (!printerManager) {
            throw new Error('æ‰“å°ç®¡ç†å™¨æœªåˆå§‹åŒ–');
          }

          const status = printerManager.getEngineStatus();
          document.getElementById(
            'engineStatus'
          ).innerHTML = `âœ… å¼•æ“çŠ¶æ€æ­£å¸¸<br>
             å½“å‰å¼•æ“: ${status.currentEngine}<br>
             C-Lodopå¯ç”¨: ${status.lodopAvailable}<br>
             å·²åˆå§‹åŒ–: ${status.isInitialized}<br>
             æ‰“å°æœºæ•°é‡: ${status.printerCount}<br>
             å·²é€‰æ‹©: ${status.selectedCount}<br>
             ç‰ˆæœ¬: ${status.version}`;
          document.getElementById('engineStatus').className = 'status success';
        } catch (error) {
          document.getElementById(
            'engineStatus'
          ).innerHTML = `âŒ çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`;
          document.getElementById('engineStatus').className = 'status error';
        }
      }

      // æµ‹è¯•å®½åº¦ä¿®å¤æ•ˆæœ
      async function testWidthFix() {
        try {
          if (!printerManager) {
            throw new Error('æ‰“å°ç®¡ç†å™¨æœªåˆå§‹åŒ–');
          }

          // ç”Ÿæˆå®½åº¦æµ‹è¯•å†…å®¹
          const testOrder = createWidthTestOrder();
          const content = printerManager.generateOrderPrintContent(testOrder);

          // åˆ†æå†…å®¹å®½åº¦
          const lines = content.split('\n');
          const maxLineLength = Math.max(
            ...lines.map((line) => {
              // è®¡ç®—æ˜¾ç¤ºå®½åº¦ï¼ˆä¸­æ–‡å­—ç¬¦ç®—2ä¸ªå®½åº¦ï¼‰
              let width = 0;
              for (const char of line) {
                width += char.charCodeAt(0) > 127 ? 2 : 1;
              }
              return width;
            })
          );

          document.getElementById(
            'widthTestResult'
          ).innerHTML = `âœ… å®½åº¦ä¿®å¤æµ‹è¯•å®Œæˆ<br>
             æœ€å¤§è¡Œé•¿åº¦: ${maxLineLength} å­—ç¬¦<br>
             ç›®æ ‡å®½åº¦: 42 å­—ç¬¦<br>
             ä¿®å¤çŠ¶æ€: ${maxLineLength <= 42 ? 'âœ… æˆåŠŸ' : 'âŒ è¶…å‡º'}<br>
             å†…å®¹è¡Œæ•°: ${lines.length}`;
          document.getElementById('widthTestResult').className =
            maxLineLength <= 42 ? 'status success' : 'status error';
        } catch (error) {
          document.getElementById(
            'widthTestResult'
          ).innerHTML = `âŒ å®½åº¦æµ‹è¯•å¤±è´¥: ${error.message}`;
          document.getElementById('widthTestResult').className = 'status error';
        }
      }

      // åˆ·æ–°æ‰“å°æœºåˆ—è¡¨
      async function refreshPrinters() {
        try {
          if (!printerManager) {
            throw new Error('æ‰“å°ç®¡ç†å™¨æœªåˆå§‹åŒ–');
          }

          const printers = await printerManager.refreshPrinters();
          let html = `âœ… æ‰¾åˆ° ${printers.length} å°æ‰“å°æœº:<br>`;

          printers.forEach((printer, index) => {
            html += `${index + 1}. ${printer.name} (${printer.width}mm, ${
              printer.engine
            })<br>`;
          });

          document.getElementById('printerList').innerHTML = html;
          document.getElementById('printerList').className = 'status success';

          // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€å°æ‰“å°æœº
          if (printers.length > 0) {
            printerManager.setSelectedPrinters([printers[0].name]);
          }
        } catch (error) {
          document.getElementById(
            'printerList'
          ).innerHTML = `âŒ åˆ·æ–°æ‰“å°æœºå¤±è´¥: ${error.message}`;
          document.getElementById('printerList').className = 'status error';
        }
      }

      // ç”Ÿæˆæ’ç‰ˆé¢„è§ˆ
      async function generatePreview() {
        try {
          if (!printerManager) {
            throw new Error('æ‰“å°ç®¡ç†å™¨æœªåˆå§‹åŒ–');
          }

          const testOrder = createWidthTestOrder();
          const content = printerManager.generateOrderPrintContent(testOrder);

          // æ·»åŠ å®½åº¦æ ‡å°º
          const previewWithRuler =
            `ğŸ”§ å®½åº¦ä¿®å¤æµ‹è¯•é¢„è§ˆ (42å­—ç¬¦å®½åº¦)\n` +
            `æ ‡å°º: 123456789012345678901234567890123456789012\n` +
            `      1         2         3         4  \n` +
            `======================================\n` +
            content +
            `======================================\n` +
            `ä¿®å¤è¯´æ˜: C-Lodopæ–‡æœ¬æ¡†å®½åº¦å·²è°ƒæ•´ä¸ºçº¦75.6mm\n` +
            `(42å­—ç¬¦ Ã— 1.8mm/å­—ç¬¦ = 75.6mm)`;

          document.getElementById('previewContent').textContent =
            previewWithRuler;
        } catch (error) {
          document.getElementById(
            'previewContent'
          ).textContent = `âŒ é¢„è§ˆç”Ÿæˆå¤±è´¥: ${error.message}`;
        }
      }

      // æ˜¾ç¤ºC-Lodopé¢„è§ˆ
      async function showPrintPreview() {
        try {
          if (!printerManager) {
            throw new Error('æ‰“å°ç®¡ç†å™¨æœªåˆå§‹åŒ–');
          }

          const testOrder = createWidthTestOrder();
          await printerManager.generatePrintPreview(testOrder);

          document.getElementById('previewContent').textContent =
            'âœ… C-Lodopé¢„è§ˆçª—å£å·²æ‰“å¼€ï¼Œè¯·æŸ¥çœ‹é¢„è§ˆæ•ˆæœ';
        } catch (error) {
          document.getElementById(
            'previewContent'
          ).textContent = `âŒ C-Lodopé¢„è§ˆå¤±è´¥: ${error.message}`;
        }
      }

      // æµ‹è¯•å®½åº¦ä¿®å¤æ‰“å°
      async function testPrintWidth() {
        try {
          if (!printerManager) {
            throw new Error('æ‰“å°ç®¡ç†å™¨æœªåˆå§‹åŒ–');
          }

          const selectedPrinters = printerManager.getSelectedPrinters();
          if (selectedPrinters.length === 0) {
            throw new Error('è¯·å…ˆé€‰æ‹©æ‰“å°æœº');
          }

          // åˆ›å»ºå®½åº¦æµ‹è¯•æ‰“å°å†…å®¹
          const testOrder = createWidthTestOrder();
          const result = await printerManager.printOrder(testOrder);

          document.getElementById(
            'printResult'
          ).innerHTML = `âœ… å®½åº¦ä¿®å¤æµ‹è¯•æ‰“å°å®Œæˆ<br>
             æˆåŠŸ: ${result.æˆåŠŸæ•°é‡}<br>
             å¤±è´¥: ${result.å¤±è´¥æ•°é‡}<br>
             å¼•æ“: ${result.æ‰“å°å¼•æ“}`;
          document.getElementById('printResult').className = 'status success';
        } catch (error) {
          document.getElementById(
            'printResult'
          ).innerHTML = `âŒ æµ‹è¯•æ‰“å°å¤±è´¥: ${error.message}`;
          document.getElementById('printResult').className = 'status error';
        }
      }

      // æ‰“å°æ ·æœ¬è®¢å•
      async function printSampleOrder() {
        try {
          if (!printerManager) {
            throw new Error('æ‰“å°ç®¡ç†å™¨æœªåˆå§‹åŒ–');
          }

          const selectedPrinters = printerManager.getSelectedPrinters();
          if (selectedPrinters.length === 0) {
            throw new Error('è¯·å…ˆé€‰æ‹©æ‰“å°æœº');
          }

          const sampleOrder = createSampleOrder();
          const result = await printerManager.printOrder(sampleOrder);

          document.getElementById(
            'printResult'
          ).innerHTML = `âœ… æ ·æœ¬è®¢å•æ‰“å°å®Œæˆ<br>
             æˆåŠŸ: ${result.æˆåŠŸæ•°é‡}<br>
             å¤±è´¥: ${result.å¤±è´¥æ•°é‡}<br>
             å¼•æ“: ${result.æ‰“å°å¼•æ“}`;
          document.getElementById('printResult').className = 'status success';
        } catch (error) {
          document.getElementById(
            'printResult'
          ).innerHTML = `âŒ æ ·æœ¬è®¢å•æ‰“å°å¤±è´¥: ${error.message}`;
          document.getElementById('printResult').className = 'status error';
        }
      }

      // åˆ›å»ºå®½åº¦æµ‹è¯•è®¢å•
      function createWidthTestOrder() {
        return {
          order_id: 'WIDTH-TEST-001',
          create_time: new Date().toISOString(),
          delivery_time: new Date(Date.now() + 3600000).toISOString(),
          paystyle: 1,
          recipient_name: 'å®½åº¦æµ‹è¯•å®¢æˆ·åç§°',
          recipient_phone: '13800138000',
          delivery_type: 0,
          rd_name: 'ğŸ”§ å®½åº¦ä¿®å¤æµ‹è¯•é¤å…',
          dishes_array: [
            {
              dishes_name: 'è¶…é•¿èœåæµ‹è¯•ï¼šå®«ä¿é¸¡ä¸é…ç™½ç±³é¥­å¥—é¤',
              amount: 2,
              price: '15.99',
              remark: 'ä¸è¾£ï¼Œå¤šæ”¾èŠ±ç”Ÿç±³ï¼Œé…èœè¦èƒ¡èåœä¸',
            },
            {
              dishes_name: 'çŸ­èœå',
              amount: 1,
              price: '8.50',
              remark: 'æ­£å¸¸è¾£åº¦',
            },
          ],
          sub_total: '40.48',
          tax_fee: '3.24',
          tax_rate: '8.0',
          delivery_fee: '2.99',
          convenience_fee: '1.50',
          convenience_rate: '3.5',
          tip_fee: '5.00',
          total: '53.21',
          order_notes:
            'è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•80mmæ‰“å°æœº42å­—ç¬¦å®½åº¦ä¿®å¤æ•ˆæœçš„æµ‹è¯•è®¢å•ã€‚',
        };
      }

      // åˆ›å»ºæ ·æœ¬è®¢å•
      function createSampleOrder() {
        return {
          order_id: 'SAMPLE-' + Date.now(),
          create_time: new Date().toISOString(),
          delivery_time: new Date(Date.now() + 3600000).toISOString(),
          paystyle: 1,
          recipient_name: 'John Doe',
          recipient_phone: '555-1234',
          delivery_type: 1,
          recipient_address: '123 Main St, City, State 12345',
          rd_name: 'Sample Restaurant',
          dishes_array: [
            {
              dishes_name: 'Kung Pao Chicken',
              amount: 2,
              price: '12.99',
              remark: 'Spicy, extra peanuts',
            },
            {
              dishes_name: 'Fried Rice',
              amount: 1,
              price: '8.99',
              remark: 'No egg',
            },
            {
              dishes_name: 'Spring Rolls (4 pieces)',
              amount: 1,
              price: '6.99',
              remark: '',
            },
          ],
          sub_total: '34.97',
          discount_total: '3.50',
          tax_fee: '2.52',
          tax_rate: '8.0',
          delivery_fee: '3.99',
          convenience_fee: '1.75',
          convenience_rate: '5.0',
          tip_fee: '5.00',
          total: '44.73',
          order_notes: 'Please ring the doorbell twice.',
        };
      }
    </script>
  </body>
</html>
